(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{2422:function(e,t,a){"use strict";a.d(t,"r",(function(){return c})),a.d(t,"t",(function(){return l})),a.d(t,"m",(function(){return s})),a.d(t,"j",(function(){return d})),a.d(t,"h",(function(){return u})),a.d(t,"d",(function(){return m})),a.d(t,"b",(function(){return f})),a.d(t,"g",(function(){return E})),a.d(t,"k",(function(){return p})),a.d(t,"f",(function(){return v})),a.d(t,"p",(function(){return g})),a.d(t,"u",(function(){return D})),a.d(t,"v",(function(){return h})),a.d(t,"n",(function(){return b})),a.d(t,"l",(function(){return O})),a.d(t,"w",(function(){return C})),a.d(t,"a",(function(){return P})),a.d(t,"q",(function(){return M})),a.d(t,"s",(function(){return y})),a.d(t,"i",(function(){return T})),a.d(t,"o",(function(){return R})),a.d(t,"c",(function(){return A})),a.d(t,"x",(function(){return I})),a.d(t,"e",(function(){return w}));var n=a(196),r=a.n(n),o=function(){return(o=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function i(e){var t={};return e&&(t=e.cParameter?JSON.parse(e.cParameter):e),t}function _(e){"upesn"!==r.a.platform?cb.utils.alert("当前平台： "+r.a.platform+" ，结果："+e):console.log("当前平台： "+r.a.platform+" ，结果："+e)}function c(e,t,a,n,i){var c={};if(null==a?void 0:a.cParameter){var l=JSON.parse(a.cParameter);c.needResult=l.needResult?parseInt(l.needResult):1,"all"===l.scanType?c.scanType=["qrCode","barCode"]:Array.isArray(c.scanType)||(c.scanType=[l.scanType])}r.a.scanQRCode(o(o({},c),{success:function(e){var t=e.resultStr;cb.invoker.publish("mtl",{action:"scan",result:t}),_(t)},fail:function(e){_(e.message)}}))}function l(e,t,a,n,c){var l=i(a);r.a.upesn.showShareMenu(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"share",result:e}),_(e)},fail:function(e){_(e.message)}}))}function s(e,t,a,n,o){var i=r.a.platform;cb.invoker.publish("mtl",{action:"platform",result:i}),_(r.a.platform)}function d(e,t,a,n,o){r.a.getNetworkType({success:function(e){var t=e.networkType;cb.invoker.publish("mtl",{action:"getNetworkType",networkType:t}),_(e)},fail:function(e){_(e.message)}})}function u(e,t,a,n,o){r.a.getMac({success:function(e){var t=e.macAddress;cb.invoker.publish("mtl",{action:"getMac",result:t}),_(e)},fail:function(e){_(e.message)}})}function m(e,t,a,n,c){var l=i(a);r.a.dail(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"dail",result:e}),_(e)},fail:function(e){_(e.message)}}))}function f(e,t,a,n,i){var c={};if(null==a?void 0:a.cParameter){var l=JSON.parse(a.cParameter);c.count=l.count,"all"===l.sourceType?c.sourceType=["album","camera"]:Array.isArray(c.sourceType)||(c.sourceType=[l.sourceType])}r.a.chooseImage(o(o({},c),{success:function(e){var t=e.localIds;cb.invoker.publish("mtl",{action:"chooseImage",result:t}),_(e)},fail:function(e){_(e.message)}}))}function E(e,t,a,n,c){var l=i(a);r.a.getLocation(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"getLocation",result:e}),_(e)},fail:function(e){_(e.message)}}))}function p(e,t,a,n,c){var l=i(a);r.a.openLocation(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"openLocation",result:e}),_(e)},fail:function(e){_(e.message)}}))}function v(e,t,a,n,c){var l=i(a);r.a.generateQRCode(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"generateQRCode",result:e}),_(e)},fail:function(e){_(e.message)}}))}function g(e,t,a,n,c){var l=i(a);if(l.headers&&"string"==typeof l.headers)try{l.headers=JSON.parse(l.headers)}catch(e){return void alert("headers 参数错误")}if(l.params&&"string"==typeof l.params)try{l.params=JSON.parse(l.params)}catch(e){return void alert("params 参数错误")}r.a.request(o(o({},l),{success:function(e){var t=e.data;cb.invoker.publish("mtl",{action:"request",result:t}),_(e)},fail:function(e){_(e.message)}}))}function D(e,t,a,n,o){r.a.startRecord({success:function(e){cb.invoker.publish("mtl",{action:"startRecord",result:e}),_(e)},fail:function(e){_(e.message)}})}function h(e,t,a,n,o){r.a.stopRecord({success:function(e){cb.invoker.publish("mtl",{action:"stopRecord",result:e}),_(e)},fail:function(e){_(e.message)}})}function b(e,t,a,n,c){var l=i(a);r.a.playVoice(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"playVoice",result:e}),_(e)},fail:function(e){_(e.message)}}))}function O(e,t,a,n,c){var l=i(a);r.a.pauseVoice(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"pauseVoice",result:e}),_(e)},fail:function(e){_(e.message)}}))}function C(e,t,a,n,c){var l=i(a);r.a.stopVoice(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"stopVoice",result:e}),_(e)},fail:function(e){_(e.message)}}))}function P(e,t,a,n,c){var l=i(a);r.a.changeScreenOrientation(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"changeScreenOrientation",result:e}),_(e)},fail:function(e){_(e.message)}}))}function M(e,t,a,n,o){r.a.restoreScreenOrientation({success:function(e){cb.invoker.publish("mtl",{action:"restoreScreenOrientation",result:e}),_(e)},fail:function(e){_(e.message)}})}function y(e,t,a,n,c){var l=i(a);r.a.setStorage(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"setStorage",result:e}),_(e)},fail:function(e){_(e.message)}}))}function T(e,t,a,n,c){var l=i(a);r.a.getStorage(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"getStorage",result:e}),_(e)},fail:function(e){_(e.message)}}))}function R(e,t,a,n,c){var l=i(a);r.a.removeStorage(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"removeStorage",result:e}),_(e)},fail:function(e){_(e.message)}}))}function A(e,t,a,n,c){var l=i(a);r.a.clearStorage(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"clearStorage",result:e}),_(e)},fail:function(e){_(e.message)}}))}function I(e,t,a,n,c){var l=i(a);r.a.uploadFile(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"uploadFile",result:e}),_(e)},fail:function(e){_(e.message)}}))}function w(e,t,a,n,c){var l=i(a);r.a.downloadFile(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"downloadFile",result:e}),_(e)},fail:function(e){_(e.message)}}))}},2423:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(429);function r(e,t,a,r,o){var i=[];t.get("propertyNames").forEach((function(e){if(t.get(e)instanceof cb.models.BaseModel)if("GridModel"===t.get(e).modelType)t.get(e).get("fieldNames").forEach((function(a){var n=t.get(e).getEditRowModel().get(a);2===n.get("iSystem")&&i.push({type:0,actionGroups:[{actions:[{exprType:0,target:e+"."+n.get("cItemName"),scrExprType:0,srcExpression:n.get("formula")}]}]})}));else{var a=t.get(e);2===a.get("iSystem")&&i.push({type:0,actionGroups:[{actions:[{exprType:0,target:a.get("cItemName"),scrExprType:0,srcExpression:a.get("formula")}]}]})}})),t.setCache("formulaRules",i),Object(n.b)(t,i,"listener")}},2438:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _common__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(191),_helpers_env__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(123),uuid_v1__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(557),uuid_v1__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(uuid_v1__WEBPACK_IMPORTED_MODULE_2__),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(429),_staterule_formularule__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(2423),mtl_js_sdk__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(196),mtl_js_sdk__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(mtl_js_sdk__WEBPACK_IMPORTED_MODULE_5__),_mtlapi__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(2422),__awaiter=function(e,t,a,n){return new(a||(a=Promise))((function(r,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function _(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(i,_)}c((n=n.apply(e,t||[])).next())}))},__generator=function(e,t){var a,n,r,o,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:_(0),throw:_(1),return:_(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function _(o){return function(_){return function(o){if(a)throw new TypeError("Generator is already executing.");for(;i;)try{if(a=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){i.label=o[1];break}if(6===o[0]&&i.label<r[1]){i.label=r[1],r=o;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(o);break}r[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{a=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,_])}}},__values=function(e){var t="function"==typeof Symbol&&Symbol.iterator,a=t&&e[t],n=0;if(a)return a.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},themeType="ncc",submitUrls={daily:"https://ys-u8c-daily.yyuap.com",pre:"https://ys-yonsuite-pre.diwork.com",production:"https://ys.diwork.com",2020:"http://ys-2020.yonyoucloud.com"};console.log("yyarchive server_env: ",void 0);var submitUrl=submitUrls[void 0]||"https://ys-u8c-daily.yyuap.com",yyarchive=function(){var _this=this,renderData=function(e,t,a){render(t,a.data,a.dirty,!0)},render=function(e,t,a,n){if(e.getParams().menuId&&!e.getParams().mode&&(e.getParams().mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT),_common__WEBPACK_IMPORTED_MODULE_0__.H(e),a){e.setDirty(!0),e.loadDirtyData(t);var r=e.getGridModels();r.forEach((function(e){e.initRowState(cb.models.DataStates.Insert)}));var o=e.getParams();o.masterOrgField,o.autoAddRow;0}else e.loadData(t);n&&_beforeRender(e),_common__WEBPACK_IMPORTED_MODULE_0__.I(e),n&&_afterRender(e),e.execute("afterLoadData",t,n),e.setCache("dataLoaded",!0),"treevoucher"!==e.getParams().metaType||a||e.validate(!0)},_beforeRender=function(e){var t=e.getParams(),a=t.masterOrgField,n=t.masterOrgKeyField,r=t.mode,o=e.get(a);if(o){o._set_data("bCanModify",r===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD);var i=e.get(n);if(i)i.getValue()&&r!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&e.setDisabled(!1),e.biz.do("depends",e)}},_afterRender=function(e){var t=e.getParams(),a=t.mode,n=t.hasBuildCoded,r=t.billNo,o=t.masterOrgField,i=t.masterOrgKeyField;a===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&n&&_createCode(r,e),e.biz.do("depends",e);var _=e.get(o);if(_){var c=e.get(i);if(c)c.getValue()||(e.setDisabled(!0),e.get("btnAbandon")&&e.get("btnAbandon").setDisabled(!1),_.setDisabled(!1))}},_reloadVoucher=function(e,t,a,n,r){if(e){var o={tplid:t.tplid};o.billData=t;_common__WEBPACK_IMPORTED_MODULE_0__.t(n,o,(function(e,t){_fetchMetaCallback(e,t,n,(function(e,t){a.communication({payload:{menuName:t.cBillName,vm:e,refresh:!0,metaData:t}})}),o)}))}else _resetData(a,t,r)},_getTreeSelectNode=function(e){var t,a,n=e.getTreeModel();return n&&(t=n.getSelectedNodes()),t&&t.length&&t[0]&&(a=t[0]),a},_doService=function(e,t,a,n,r,o){if("treevoucher"===t.getParams().metaType&&!_getTreeSelectNode(t))return void cb.utils.alert("请选择有效数据","warning");_common__WEBPACK_IMPORTED_MODULE_0__.q(e,t,a,n,r,_doServiceByData,o)},_doServiceByData=function(e,t,a,n,r){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(t,o){if(!t){if(a.cShowCaption)cb.utils.alert(a.cShowCaption+"成功","success");else{var i="open"==a.cAction?"启用":"停用";cb.utils.alert(i+"成功","success")}if(e.getCache("banRenderNewData"))console.log("已禁止根据返回数据render");else{var _=e.collectData(!0);o=Array.isArray(o)&&o.length>0?o[0]:o;var c=_common__WEBPACK_IMPORTED_MODULE_0__.e(_,o);"treevoucher"===e.getParams().metaType&&e.getTreeModel().updateNode(c),render(e,c),c&&c.isWfControlled&&e.biz.do("refresh",e)}r&&r()}n&&n({err:t,res:o},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),t)},_tplIsEquql=function(e,t){return!!t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&e[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]!=t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).getValue()},_resetData=function(e,t,a){_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e,t),a&&a({res:t},_common__WEBPACK_IMPORTED_MODULE_0__.a)},_loadVm=function(e,t){t.originalVM=e.originalVM,t.originalViewMeta=e.originalViewMeta,t.biz.do("rule",t),t.biz.do("initDefaultActions",t)},_loadTree=function(e,t,a){t=Object.assign({},t,e.getCache("lastSearchCondition"));var n=e.allActions&&e.allActions.find((function(e){return e.cCommand&&"cmdquerytree"===e.cCommand.trim().toLocaleLowerCase()})),r=n&&n.cSvcUrl?{url:n.cSvcUrl,method:n.cHttpMethod||"POST"}:{url:"bill/querytree",method:"POST"},o=e.getTreeModel();o&&o.promiseExecute("beforeLoad",t,(function(){o.setDataSource(r,t),a&&o.setCache("afterAct",a)}))},search=function(e,t,a,n,r){t.setCache("execFilter",!0),t.setCache("lastSearchCondition",a);var o={billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")};a&&a instanceof Object&&(o=Object.assign(o,a)),n({params:a,data:a},(function(){_loadTree(t,o,r)}))},getModeDirtyData=function(e,t,a){void 0===t&&(t=!1),e.getDirtyData(!1)&&!t?cb.utils.confirm("确定要放弃当前修改吗？",(function(){a(!0)}),(function(){a(!1);var t=e.getCache("cancelEditFun");t instanceof Function&&t()})):a(!0)},_bindTreeSelect=function(e,t){var a=e.getTreeModel();a&&(a.on("select",(function(a,n,r){e.promiseExecute("beforeTreeSelect",a,(function(){a.length?getModeDirtyData(e,r,(function(r){r&&(_common__WEBPACK_IMPORTED_MODULE_0__.G(e,n&&e.getParams().mode||_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),_renderTreeVoucherData(t,e,a[0]),e.setCache("lastMode",_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE))})):cb.extendConfig.yyarchive.treeCard||e.biz.do("add",e)}))})),a.on("afterSetDataSource",(function(){var e=a.getCache("afterAct");e&&e()})))},_renderTreeVoucherData=function(e,t,a){var n=a[t.getTreeModel().getState("keyField")];if(t.setCache("lastId",n&&n.toString()),t.getParams().hasChildren){var r={billnum:e,id:n},o=t.allActions&&t.allActions.find((function(e){return e.cCommand&&"cmddetail"===e.cCommand.trim().toLocaleLowerCase()})),i=o&&o.cSvcUrl?{cSvcUrl:o.cSvcUrl,cHttpMethod:o.cHttpMethod||"GET"}:{cSvcUrl:"bill/detail",cHttpMethod:"GET"};_common__WEBPACK_IMPORTED_MODULE_0__.p(i,(function(e,a){e||cb.extendConfig.yyarchive.treeCard&&t.getParams().mode===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD||render(t,a)}),r)}else render(t,a)},_fetchMetaCallback=function(e,t,a,n,r,o,i){_common__WEBPACK_IMPORTED_MODULE_0__.z(e,t,a,r,(function(e,a){e.viewCallback=n,e.originalVM=e,e.originalParams=r,e.originalViewMeta=t.viewmeta,o({vm:e,view:a})}),(function(e){e.setCache("entryMode",r.mode),e.setCache("condition",r.condition),e.initData()}),i)},_afterViewCallback=function(e,t,a){var n=function(t){var a=JSON.parse(JSON.stringify(t.getParams()));Object.assign(a,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,id:t.get("id").getValue()}),_getInitdata(e,a,(function(e,a){e?cb.utils.alert(e.message,"error"):_resetData(t,a)}))};_common__WEBPACK_IMPORTED_MODULE_0__.G(t,a.mode),t.on("refresh",(function(){n(t)})),t.on("back",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.w(t)===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&n(t)}));var r=new cb.promise;t.on("return",(function(e){return _common__WEBPACK_IMPORTED_MODULE_0__.w(t)===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE||!t.getDirtyData(!1)||(e&&"object"==typeof e?(e.prompt={},!0):(cb.utils.confirm("确定要"+e+"吗",(function(){r.resolve()}),(function(){r.reject()})),r))})),t.biz.do("initDefaultActions",t),t.on("afterRule",(function(){a.mode===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT&&t.execute("afterEdit"),"copy"===a.action&&t.execute("afterCopy")})),t.on("afterCode",(function(){a.mode===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT&&t.getParams().workflowNoCtrl&&(t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1))}))},_getInitdata=function(e,t,a,n){cb.rest.DynamicProxy.create({getCmdList:{url:"billmeta/getbillcommands",method:"GET"}}).getCmdList({billno:e},(function(r,o){var i,_,c,l={billnum:e};switch(t&&t.mode||_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE){case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD:i="cmdadd",_="bill/add",c="POST",Object.assign(l,t.carryParams);break;case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE:case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT:if(i="cmddetail",_="bill/detail",c="GET",!t.id)return void a();l.id=t.id,t.isSum&&(l.isSum=t.isSum),Object.assign(l,t.carryParams)}if(i&&o){var s=o.find((function(e){return e.cCommand&&e.cCommand.trim().toLocaleLowerCase()===i}));s&&s.cSvcUrl&&(_=s.cSvcUrl,c=s.cHttpMethod||"GET")}t&&!0===t.readOnly&&(t.mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE);var d={cSvcUrl:_,cHttpMethod:c};n?n({params:t,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(d,a,l)})):_common__WEBPACK_IMPORTED_MODULE_0__.p(d,a,l)}))},cellsCheck=function(e,t,a,n,r){var o=[];a.forEach((function(e){t.get(e.childrenField).getColumn(e.cellName).bCheck&&o.push({location:e.rowIndex,key:e.cellName,childrenField:e.childrenField,value:JSON.stringify(e.value),type:e.cControlType,fieldname:e.cFieldName})})),_common__WEBPACK_IMPORTED_MODULE_0__.c(e,t,o)},referRowsCheck=function(e,t,a,n,r){var o=a.childrenField,i=a.columnName,_=a.index,c=a.rows,l=t.get(o).getColumn(i);if(l.bBatchCheck){var s={location:_,key:i,childrenField:o,value:JSON.stringify(c),type:l.cControlType,fieldname:l.cFieldName,mergeAll:!0};_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,s,n,r,!0)}},cellCheck=function(e,t,a,n,r){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),i=a.cellName,_=o.getColumn(i);if(_.bCheck){var c={location:a.rowIndex,key:i,childrenField:a.childrenField,value:JSON.stringify(a.value),oldValue:a.oldValue,type:_.cControlType,fieldname:_.cFieldName,async:a.async,callback:a.callback,context:a.context};n({params:a,data:c},(function(){if(!0===_.bCheck){var a=o.getCache("ruleItems");a&&a.indexOf(i)>-1&&(c.async=!1),_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,c,n,r,!0)}}))}},lineOpenOrClose=function(e,t,a,n,r){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(o.length){var i=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getRowsByIndexes(o),_=o[0],c=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getName(),l=t.collectData(!0);l[c]=i;var s={billnum:e,data:JSON.stringify(l)};n({params:a,data:s},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,n){if(!e){cb.utils.alert("操作成功","success");var o={};a&&a.childrenField&&(o[a.childrenField]=[_]);var i=t.collectData(!0),c=_common__WEBPACK_IMPORTED_MODULE_0__.e(i,n,o);render(t,c),_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).select([_])}r({err:e,res:n},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),s)}))}},copy=function(e,t,a,n,r){if(a&&a.cSvcUrl){t&&(a.mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,a.id=t.get("id").getValue());var o={billnum:e};_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(n,o){n?_common__WEBPACK_IMPORTED_MODULE_0__.a({err:n}):_getInitdata(e,a,(function(e,n){if(e)_common__WEBPACK_IMPORTED_MODULE_0__.a({err:e});else{var i=_common__WEBPACK_IMPORTED_MODULE_0__.d(n,o);t?(_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),render(t,i,!0,!0),r()):(a.mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,r(null,i))}}))}),o)}},refresh=function(e,t,a,n,r){var o=function(a,n){if(!a&&n){var o=_tplIsEquql(n,t);_reloadVoucher(o,n,t,e,r)}else{r({err:a,res:n},_common__WEBPACK_IMPORTED_MODULE_0__.a)}},i={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,id:t.get("id").getValue(),isSum:a&&a.isSum};n({params:a,data:i},(function(){_getInitdata(e,i,o,n)}))},loadData=function(e,t,a,n,r){var o,i=a.data,_=_common__WEBPACK_IMPORTED_MODULE_0__.w(t),c=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"parent"),l=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cCarry"),s=[];if(l&&c){try{l=JSON.parse(l)}catch(e){return void console.error("列表cCarry JSON格式错误--\x3e"+l)}if("object"==typeof l)for(var d in l){var u=l[d];i[d]=c[u],s.push(d)}}s.map((function(e){var a=t.get(e);a&&a.setDirty(!0)})),n({params:a,data:i},(function(){render(t,i,_==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD)}));var m=e;if(-1!==e.indexOf("Mobile")&&(m=e.split("Mobile")[0]),i.verifystate&&0!==i.verifystate&&(null===(o=t.get("id"))||void 0===o?void 0:o.getValue())){var f=m+"_"+t.get("id").getValue();_showApproveFlow(t,f)}},buildDepends=function(e,t){var a=t.get("depends");if(a){var n=null,r=function(e){try{var r=JSON.parse(e),o=null,i=null,_=null,c=e;for(var l in r)_=l,i=t.get(r[l]),o=i.getEditRowModel(),n=o.get(l);_buildDepends(a[c],o,n.getValue()),o.on("afterUpdateEditRowModel",(function(e){cb.utils.isEmpty(e[_])||_buildDepends(a[c],o,e[_]||0)}),a[e])}catch(r){if(!(n=t.get(e)))return"continue";n._set_data("needCheck",!0),_buildDepends(a[e],t,n.getValue()),n.on("afterValueChange",(function(e){_buildDepends(this,t,e.value)}),a[e])}};for(var o in a)r(o)}},_buildDepends=function(e,t,a){cb.utils.isEmpty(a)||(a="string"==typeof a?Number(a):a,e.forEach((function(e){if(e.childrenField){var n=t.get(e.childrenField);n instanceof cb.models.GridModel&&(n.getEditRowModel().get(e.field).setState("iNumPoint",a),n.setColumnState(e.field,"iNumPoint",a))}else{var r=t.get(e.field);r instanceof cb.models.SimpleModel&&r.setState("iNumPoint",a)}})))},buildOrg=function(e,t){var a=t.getParams(),n=a.masterOrgField,r=a.carryParams;if(n){var o=t.get(n);if(o){t.getParams().mode!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&(o._set_data("bCanModify",!1),o.setReadOnly(!0)),o.on("beforeValueChange",(function(e){if((s=l&&l.getValue())&&(!e.value||e.value.id!=s)){var a=new cb.promise;return t.promiseExecute("beforeChangeMasterOrg",(function(){cb.utils.confirm("切换主组织将清空数据，是否继续？",(function(){t.setCache("delayCode",!0),a.resolve()}))})),a}})),o.on("afterValueChange",(function(a){if(s||cb.utils.isArray(a.value)||!a.value||(t.setDisabled(!1),t.execute("afterMasterOrgChange",l.getValue())),s&&(!a.value||a.value.id!=s)){t.clearCache("delayCode");var n={};n[_]=a.value&&a.value.id||null,t.get("code")&&t.getParams().hasBuildCoded&&(n.code=t.get("code").getValue()),t.biz.do("add",t,{carryParams:r,carryData:n,callback:function(){l._get_data("needCheck")&&_createCode(e,t),!cb.utils.isArray(a.value)&&a.value?o.setValue([a.value]):(l.setValue(null,l._get_data("needCheck")),t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1),o.setDisabled(!1)),s=l.getValue(),o.execute("afterValueChange",a),t.execute("afterMasterOrgChange",s)}})}}));var i=o.getState("bill2ReferKeyFieldMap")||{},_=null;for(var c in i){if(_)break;_=c}_||(_="org");var l=t.get(_);if(l){t.getParams().masterOrgKeyField=_;var s=l.getValue();if(!s)return t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1),void o.setDisabled(!1);var d=t.getParams(),u=d.mode,m=d.realAdd,f=d.action;u===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&!1!==m&&"copy"!==f&&o.browse(!1,(function(e){e.on("getRefMetaReady",(function(){var a={isExtend:!0,simpleVOs:[{field:"id",op:"in",value1:s}]};e.execute("pressEnter",{model:o,condition:a,browse:!1,errCallBack:function(){return l.setValue(null),s=l.getValue(),t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1),o.setDisabled(!1),!1}})}))}))}}}},buildCode=function(e,t,a,n,r){var o=t.getParams(),i=o.isCoded,_=o.mode,c=o.realAdd;if(i&&!1!==c){var l=e.toLocaleLowerCase().indexOf("mobile"),s={billNum:l>=0?e.substr(0,l):e};n({params:a,data:s},(function(){cb.rest.DynamicProxy.create({getCode:{url:"billNumber/findByBillNum",method:"GET"}}).getCode(s,(function(e,a){if(!e&&a){var n=t.get("code");if(n){var o=!!a.ballowhandwork;if(n._set_data("bCanModify",o),n.setDisabled(!o),r(),(!o||a.brepeatredo)&&a.billPrefix&&a.billPrefix.length){t.getParams().hasBuildCoded=!0,_===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&_createCode(s.billNum,t);var i=[];a.billPrefix.forEach((function(e){e.cfieldname&&(_buildCode(e.cfieldname,t,s.billNum),i.push(e.cfieldname))})),t.setCache("prefixes",i)}}}else cb.utils.alert(e.message,"error")}))}))}},_buildCode=function(e,t,a){var n=t.get(e);n&&(n._set_data("needCheck",!0),n.on("afterValueChange",(function(){_createCode(a,t)})))},_createCode=function(e,t){if(!t.getCache("delayCode")){var a=cb.rest.DynamicProxy.create({createCode:{url:"billNumber/createCode?billNum="+e,method:"POST"}}),n=t.collectData();a.createCode(n,(function(e,a){!e&&a?t.get("code").setValue(a):cb.utils.alert(e.message,"error")}))}},buildRule=function(billNo,viewmodel,para,beforeAct,afterAct){var postData={billNumber:billNo,language:"javascript"},beforeActData={params:para,data:postData};beforeAct(beforeActData,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p({cSvcUrl:"/itemrule/script",cHttpMethod:"GET"},(function(_err,data){data=eval(data)||{},data&&(data.rules||[]).forEach((function(e){var t={};for(var a in e.triggers.forEach((function(a){var n=a.ds;if(n)t[n]||(t[n]=[]),t[n].push(a.item);else{if(!viewmodel.get(a.item))return;viewmodel.get(a.item).on("afterValueChange",(function(){this.run(this.param)}),{run:data.run,param:{ruleid:e.id,vm:viewmodel,trigger:{ds:n,item:a.item,lineid:"0"}}})}})),t)if(viewmodel.get(a)){viewmodel.get(a).setCache("ruleItems",t[a]);var n=function(e){-1!==this.items.indexOf(e.cellName)&&(this.param.trigger.item=e.cellName,this.param.trigger.lineid="0:"+e.rowIndex,this.run(this.param))},r={items:t[a],run:data.run,param:{ruleid:e.id,vm:viewmodel,trigger:{ds:a}}};viewmodel.get(a).on("afterCellValueChange",n,r),viewmodel.get(a).on("innerCellValueChange",n,r),viewmodel.get(a).on("afterDeleteRows",(function(){var e=this.childrenField;this.items.forEach((function(t){viewmodel.get(e).execute("innerCellValueChange",{rowIndex:-1,cellName:t})}))}),{items:t[a],childrenField:a}),viewmodel.get(a).on("afterInsertRow",(function(){var e=this.childrenField;this.items.forEach((function(t){viewmodel.get(e).execute("innerCellValueChange",{rowIndex:-1,cellName:t})}))}),{items:t[a],childrenField:a})}}));var jointFields={};for(var attr in(data.jointFields||[]).forEach((function(e){var t=e.ds;if(t)jointFields[t]||(jointFields[t]=[]),jointFields[t].push(e.item);else{if(!viewmodel.get(e.item))return;viewmodel.get(e.item).on("jointQuery",(function(){var e=null;try{e=JSON.parse(this.param.vm.get(this.param.trigger.item).getState("cStyle"))}catch(t){e={}}var t=this.jointQuery(this.param),a=[];for(var n in t.paras)a.push(n+"="+t.paras[n]);if(e.menuCode="SJ0201",e.menuCode)viewmodel.communication({type:"menu",payload:{menuCode:e.menuCode,menuUrl:"?"+a.join(",")}});else{var r=this.param.vm,o={billtype:"yyarchive",billno:t.target,params:cb.utils.extend(!0,t.paras,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT})};cb.loader.runCommandLine("bill",o,r)}}),{jointQuery:data.jointQuery,param:{vm:viewmodel,trigger:{ds:e.ds,item:e.item}}})}})),jointFields)viewmodel.get(attr)&&viewmodel.get(attr).on("cellJointQuery",(function(e){if(-1!==this.items.indexOf(e.cellName)){this.param.trigger.item=e.cellName,this.param.trigger.lineid="0:"+e.rowIndex;var t=this.jointQuery(this.param),a=this.param.vm,n={billtype:"yyarchive",billno:t.target,params:cb.utils.extend(!0,t.paras,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT})};cb.loader.runCommandLine("bill",n,a)}}),{items:jointFields[attr],jointQuery:data.jointQuery,param:{vm:viewmodel,trigger:{ds:attr}}});var refFields={};for(var attr in(data.refFields||[]).forEach((function(e){var t=e.ds;if(t)refFields[t]||(refFields[t]=[]),refFields[t].push(e.item);else{var a=viewmodel.get(e.item);if(!a)return;a.on("beforeBrowse",(function(){var e=this.jointQuery(this.param);e&&_setReferRule(e,this.referModel)}),{referModel:a,jointQuery:data.jointQuery,param:{action:"ref",vm:viewmodel,trigger:{ds:e.ds,item:e.item}}})}})),refFields){var referModel=viewmodel.get(attr);referModel&&referModel.on("beforeBrowse",(function(e){if(-1!==this.items.indexOf(e.cellName)){this.param.trigger.item=e.cellName,this.param.trigger.lineid="0:"+e.rowIndex;var t=this.jointQuery(this.param);t&&_setReferRule(t,e.context)}}),{referModel:referModel,items:refFields[attr],jointQuery:data.jointQuery,param:{action:"ref",vm:viewmodel,trigger:{ds:attr}}})}afterAct()}),postData)}))},_setReferRule=function(e,t){var a=e.target;a&&(a.cRefType&&t.setRefCode(a.cRefType),a.cRefRetId&&t.setReturnFields(a.cRefRetId.refid)),t.setFilter({isExtend:!0,simpleVOs:e.paras})},_resetOriginal=function(e,t){var a=e.originalVM||e;a.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&e.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&a.getOriginalData()[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]!=e.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).getValue()&&(e.communication({payload:{menuName:a.originalViewMeta.cBillName,vm:a,refresh:!0,metaData:a.originalViewMeta}}),_loadVm(e,a));var n=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE;e.getCache("lastMode")?_common__WEBPACK_IMPORTED_MODULE_0__.G(a,e.getCache("lastMode")):e.getCache("entryMode")!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&e.getParams().menuId||_common__WEBPACK_IMPORTED_MODULE_0__.G(a,n);var r=a.getOriginalData(),o=a.getTreeModel();if(o){var i=o.getSelectedNodes();i.length>0&&(r=i[0])}a.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&!r[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]&&(r[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]=a.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).get("cDefaultValue")),render(a,r,n===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,!0),t({res:r},_common__WEBPACK_IMPORTED_MODULE_0__.a)},check=function(e,t,a,n,r){if("treevoucher"===t.getParams().metaType){var o=_getTreeSelectNode(t);if(o){var i=t.getTreeModel();a[i.getState("parentField")]=o[i.getState("keyField")]}}n({params:a},(function(){var o="ncc"===cb.extendConfig.theme;_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,a,n,r,!1,o)}))},getAbandonText=function(e){return(e?JSON.parse(e):{}).cAbandonText||"取消"},abandon=function(e,t,a,n,r){n({params:a},(function(){if(_common__WEBPACK_IMPORTED_MODULE_0__.w(t)!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE||t.getParams().menuId){var n=t.getDirtyData(!1);if("treevoucher"===t.getParams().metaType&&cb.extendConfig.yyarchive.treeCard&&(n||(n=t.getNecessaryData())),n){var o=a.cShowCaption||getAbandonText(a.cParameter);cb.utils.confirm("确定要"+o+"么",(function(){_abandon(t,r,e)}),(function(){a&&a.enabledCallback&&a.enabledCallback()}))}else _abandon(t,r,e)}else cb.route.goBack()}))},_abandon=function(e,t,a){var n,r=e.getParams(),o=r.multitpl,i=r.metaType,_=r.menuId;if(o||e.getCache("entryMode")!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&"treevoucher"!==i&&!_)cb.route.goBack();else{if(_resetOriginal(e,t),"treevoucher"===i){var c=e.getCache("lastId");if(!c)return _common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),e.setDirty(!1),void _resetOriginal(e,t);var l=e.getTreeModel();if(!l)return;return l.select(c,void 0,!0),void e.setDirty(!1)}if(e.get("verifystate")){if(e.get("verifystate")&&0!==e.get("verifystate").getValue()){var s=a;if(-1!==a.indexOf("Mobile")&&(s=a.split("Mobile")[0]),null===(n=e.get("id"))||void 0===n?void 0:n.getValue()){var d=s+"_"+e.get("id").getValue();_showApproveFlow(e,d)}}}else e.get("btnEdit")&&e.get("btnEdit").setVisible(!0),e.get("btnSaveAndAdd")&&e.get("btnSaveAndAdd").setVisible(!1),e.get("btnSave")&&e.get("btnSave").setVisible(!1),e.get("btnAbandon")&&e.get("btnAbandon").setVisible(!1);e.validate(!0)}},inValid=function(e,t,a,n,r){var o=window.prompt("请输入作废理由",""),i=t.getNecessaryData();o&&(i=cb.utils.extend(i,{invalidReason:o}));var _={billnum:e,data:JSON.stringify(i)};n({params:a,data:_},(function(){_doServiceByData(t,_,a,r)}))},batchModify=function(e,t,a,n,r){t.communication({type:"modal",payload:{key:"batchModify",data:{billType:"yyarchive",billNo:e,model:t,params:a}}})},submit=function(e,t,a,n,r){if(console.log("submit ----\x3e"),!t.get("id").getValue())return cb.invoker.publishLoadData(!1),void cb.utils.alert("单据id属性不存在，请检查数据建模");a.cShowCaption="提交";var o=t.collectData(!0);o.mobileBillNo=e,o.mobileBillType="yyarchive",-1!==e.indexOf("Mobile")&&(e=e.split("Mobile")[0]);var i={billnum:e,data:JSON.stringify(o)},_={params:a,data:i},c=e+"_"+t.get("id").getValue();n(_,(function(){_doServiceByData(t,i,a,r,(function(){_showApproveFlow(t,c)}))}))},_showApproveFlow=function(e,t){if("upesn"===mtl_js_sdk__WEBPACK_IMPORTED_MODULE_5___default.a.platform)mtl_js_sdk__WEBPACK_IMPORTED_MODULE_5___default.a.upesn.getUserYHTInfo({success:function(a){var n={appsource:"developplatform",businessKey:t,sourceType:"actionInit",bpmHost:submitUrl,userId:a.yht_userid,tenantId:a.tenant_id};console.log(JSON.stringify(a));var r=cb.utils.getViewModelByType(e,"approveflow");(null==r?void 0:r.length)>0?r.forEach((function(e){e.setData(n),console.log("modelData : ",JSON.stringify(n))})):console.log("未找到审批组件")},fail:function(e){console.log(JSON.stringify(e))}});else{var a=_getcookie("yonyou_uid"),n=void 0;if(window.location.search.substring(1)){var r=window.location.search.substring(1).split("tenantId=");r&&r.length>1&&(n=r[1].split("&")[0])}console.log("pc submit => tenantId:",n," ; userId:",a);var o={appsource:"developplatform",businessKey:t,sourceType:"actionInit",bpmHost:"https://ys-u8c-daily.yyuap.com",userId:a,tenantId:n},i=cb.utils.getViewModelByType(e,"approveflow");(null==i?void 0:i.length)>0?i.forEach((function(e){e.setData(o)})):console.log("未找到审批组件")}},_getcookie=function(e){for(var t=document.cookie.split("; "),a=0;a<t.length;a++){var n=t[a].split("=");if(n[0]==e)return unescape(n[1])}},unsubmit=function(e,t,a,n,r){console.log("unsubmit ---\x3e");var o=t.collectData();o=t.collectData(!0);var i={billnum:e,data:JSON.stringify(o)};n({params:a,data:i},(function(){_doServiceByData(t,i,a,r,(function(){t.getParams().workflowNoCtrl&&delete t.getParams().workflowNoCtrl}))}))},checkApprove=function(e,t,a,n,r){var o={billNum:e,billId:t.get("id"),billCode:t.get("code")};n({params:a,data:o},(function(){t.communication({type:"modal",payload:{type:"platform",url:"checkapprove",model:t,data:o}}),r()}))},workflow=function(e,t,a,n,r){var o=e+"_"+t.get("id").getValue(),i={width:850,height:510,appsource:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.appCode,businessKey:o};n({params:a,data:i},(function(){window.flowComp(i).showFlowBox({onClose:function(o){refresh(e,t,a,n,r)}})}))},audit=function(e,t,a,n,r){if(t.get("isWfControlled")&&t.get("isWfControlled").getValue()){if(!t.get("verifystate")||1!==t.get("verifystate").getValue())return void cb.utils.alert("请先提交","error");var o=e+"_"+t.get("id").getValue();window.flowComp({width:850,height:510,appsource:"u8c",businessKey:o}).showFlowBox({onClose:function(e){t.communication({type:"refresh"})}})}else{var i=t.collectData(!0),_={billnum:e,data:JSON.stringify(i)};n({params:a,data:_},(function(){_doServiceByData(t,_,a,r)}))}},open=function(e,t,a,n,r){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"open"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}cb.extendConfig.allConfirm&&a.cShowCaption?cb.utils.confirm("是否确认"+a.cShowCaption+"此记录",(function(){_doService(e,t,a,n,r,!0)})):_doService(e,t,a,n,r,!0)},close=function(e,t,a,n,r){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"close"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}cb.extendConfig.allConfirm&&a.cShowCaption?cb.utils.confirm("是否确认"+a.cShowCaption+"此记录",(function(){_doService(e,t,a,n,r,!0)})):_doService(e,t,a,n,r,!0)},table2DBtnClick=function(e,t,a,n,r){t.execute("table2DBtnClick")},addRow=function(e,t,a,n,r){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),i=o.t2DInfo_Bus_Get("support2D"),_=o.t2DInfo_Bus_Get("show2D");if(i&&_)t.execute("table2DAddRowClick");else{var c={params:a};n(c,(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).appendRow();c.data=e,r(c)}))}},deleteRow=function(e,t,a,n,r){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();cb.utils.isArray(o)&&0==o.length?cb.utils.alert("请选择行","warning"):(delete a.params,n({params:a,data:o},(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).deleteRows(o);r(e)})))},insertRow=function(e,t,a,n,r){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(cb.utils.isArray(o)&&0==o.length)cb.utils.alert("请选择行","warning");else{var i={params:a,data:o};n(i,(function(){o.length&&(_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).insertRow(o[0]),r(i))}))}},copyRow=function(e,t,a,n,r){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(cb.utils.isArray(o)&&0==o.length)cb.utils.alert("请选择行","warning");else{var i=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getRow(o[0]),_={params:a,data:{rowIndexes:o,rowData:i}};n(_,(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).insertRow(o[0],_.data.rowData);_.data.rowData=e,r(_)}))}},shiftUpRow=function(e,t,a,n,r){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(o.length){var i=o[0],_={params:a,data:i};n(_,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).shiftUpRow(i),r(_)}))}},shiftDownRow=function(e,t,a,n,r){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(o.length){var i=o[0],_={params:a,data:i};n(_,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).shiftDownRow(i),r(_)}))}},localPrint=function(e,t,a,n,r){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"localprint"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}var i=t.get("id").getValue();if(cb.utils.isEmpty(i))cb.utils.alert("未找到具体单据","error");else{var _=a&&a.cSvcUrl||"/bill",c=a.disabledCallback,l=a.enabledCallback,s="";if(a.cParameter){var d=JSON.parse(a.cParameter);s=d&&d.printTplItemName}if(s){var u=t.get(s);if(u){var m=u.getValue();if(cb.utils.isEmpty(m))return void cb.utils.alert("请选择打印模板","error");c&&(c(),a.disabledCallback=!1),_localPrint(e,m,i,_,n,l)}else{c&&(c(),a.disabledCallback=!1),cb.rest.DynamicProxy.create({getTemplate:{url:"print/getTemplateByBo",method:"GET",options:{mask:!0}}}).getTemplate({billno:e},(function(t,a){if(t)return cb.utils.alert(t.message,"error"),void(l&&l());var r=1===a.length?a[0]:a.find((function(e){return e.isdefault}));if(cb.utils.isEmpty(r))return cb.utils.alert("没有设置打印模板，请检查","error"),void(l&&l());_localPrint(e,r.templatecode,i,_,n,l)}))}}else cb.utils.alert("请预置打印按钮的cParameter信息 { printTplItemName : 打印模板的cItemName}","warning")}},_localPrint=function(e,t,a,n,r,o){var i={billno:e,templateCode:t,ids:[a]};cb.rest.DynamicProxy.create({print:{url:n+"/getTemplateStructure",method:"POST",options:{mask:!0}}}).print(i,(function(e,t){if(e)return cb.utils.alert(e.message,"error"),void(o&&o());r(t,(function(){cb.utils.localPrint(t),o&&o()}))}))},isInWorkBench=function(e){var t=!1,a="isInWorkBench";return t=isModelHasKey(e,a),e&&0==t&&(e=e.getParent(),t=isModelHasKey(e,a)),e&&0==t&&(e=e.getParent(),t=isModelHasKey(e,a)),t},isHideAlert=function(e){var t=!1,a="isHideAlert";return t=isModelHasKey(e,a),e&&0==t&&(e=e.getParent(),t=isModelHasKey(e,a)),e&&0==t&&(e=e.getParent(),t=isModelHasKey(e,a)),t||!1},isModelHasKey=function(e,t){return e&&1==e.getCache(t)||!1},save=function(e,t,a,n,r,o){var i,_,c=e;if(-1!==c.indexOf("Mobile")&&(c=e.split("Mobile")[0]),!(a=a||{}).cAction){var l=t.allActions&&t.allActions.find((function(e){return"save"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,l)}var s=t.validate();if(s){if(1==isHideAlert(t))r({err:{message:"以下数据项校验失败："+s.join(",")}});else if("ncc"===cb.extendConfig.theme)cb.utils.alert(t.getCache("customErrorMessage")||"以下数据项校验失败："+s.join(","),"error");else{var d=t.getCache("invalidFields");if(d){var u=[],m=!1;d.forEach((function(e){var a=t.get(e),n=a.get("bShowIt"),r=a.get("bHidden");!1===n||r?u.push(a._get_data("cShowCaption")||a._get_data("cCaption")||a._get_data("cFieldName")):m=!0})),u.length>0&&!m?cb.utils.alert("存在隐藏必输数据项："+u.join(","),"error"):cb.utils.alert("存在必输项，请填写完整！","error")}}return console.log("保存失败---以下数据项校验失败："+s.join(",")),void cb.invoker.publishLoadData(!1)}var f=_common__WEBPACK_IMPORTED_MODULE_0__.w(t),E=t.getParams().metaType,p=t.collectData();if(!p)return"treevoucher"!==E&&(cb.utils.alert("未作任何修改"),t.setReadOnly(!0),_common__WEBPACK_IMPORTED_MODULE_0__.I(t)),void cb.invoker.publishLoadData(!1);if("editablevoucherlist"==E&&(p=p[t.getGridModel().getName()]),f==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD){if(p._status=cb.models.DataStates.Insert,"treevoucher"===E){var v=t.getTreeModel(),g=p[v.getState("parentField")];if(g){if(v){var D=v.getNodesByKeys(g);D&&D.length&&(p.level=D[0].level+1)}}else p.level=1}var h=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"parentId");if(null!=h){var b=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"foreignKey");b&&(p[b]=h)}}else p._status=cb.models.DataStates.Update;for(var O in p)if(Array.isArray(p[O])&&p[O].length>0)try{for(var C=(i=void 0,__values(p[O])),P=C.next();!P.done;P=C.next()){var M=P.value;M.id&&M._status==cb.models.DataStates.Insert&&(M._status=cb.models.DataStates.Update)}}catch(e){i={error:e}}finally{try{P&&!P.done&&(_=C.return)&&_.call(C)}finally{if(i)throw i.error}}var y=Object.assign({billnum:c,data:JSON.stringify(p)},a.defineParams);n({params:a,data:y},(function(){a.options={mask:!0},_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(n,i){var _,c,l,s=i,d={params:a,err:n,res:s};if(!n){if(t.setDirty(!1),_handlePageInfoStatus(t,a,i),"treevoucher"===E&&t.getTreeModel&&_loadTree(t,{billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")},(function(){})),0==isHideAlert(t)){var u=(o||a.cShowCaption||a.cCaption||"保存")+"成功";window.parent!==window&&cb.rest.AppContext.query.random?window.parent.postMessage({key:"crossdomainpush",random:cb.rest.AppContext.query.random,msg:{type:"success",content:u}},"*"):cb.utils.alert(u,"success")}if(1==isInWorkBench(t))return void r(d,_common__WEBPACK_IMPORTED_MODULE_0__.a);var m=t.getParams().menuId;if(t.getCache("entryMode")!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&m||_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),"saveandadd"===a.cAction.trim().toLocaleLowerCase()){if("treevoucher"===E){var p=t.getTreeModel();if(t.execute("updateTreeRefer"),t.getParams().saveRefresh){var v=s[p.getState("keyField")];p._set_data("defaultSelectedKeys",[v]),_loadTree(t,{billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")},(function(){}))}else f!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD?p.updateNode(s):p.addNode(s)}return void r(d,_common__WEBPACK_IMPORTED_MODULE_0__.a)}t.get("verifystate")||(t.get("btnEdit")&&t.get("btnEdit").setVisible(!0),t.get("btnSaveAndAdd")&&t.get("btnSaveAndAdd").setVisible(!1),t.get("btnSave")&&t.get("btnSave").setVisible(!1),t.get("btnAbandon")&&t.get("btnAbandon").setVisible(!1)),t.getGridModels().forEach((function(e){e.unselectAll()}));var g,D=t.collectData(!0),h=[];for(var v in i)Array.isArray(i[v])&&(null===(l=null===(c=null===(_=t.get(v))||void 0===_?void 0:_.getDirtyRowIndexes)||void 0===c?void 0:c.call(_))||void 0===l?void 0:l.length)>0&&(h.push(v),g={});if(h.forEach((function(e){g[e]=t.get(e).getDirtyRowIndexes()})),s=_common__WEBPACK_IMPORTED_MODULE_0__.e(D,i,g),render(t,s),"treevoucher"===E){p=t.getTreeModel();if(_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),t.execute("updateTreeRefer"),t.getParams().saveRefresh){v=s[p.getState("keyField")];p._set_data("defaultSelectedKeys",[v]),_loadTree(t,{billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")},(function(){}))}else f!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD?p.updateNode(s):p.addNode(s,!0)}}r(d,_common__WEBPACK_IMPORTED_MODULE_0__.a)}),y)}))},_delete=function(e,t,a,n,r){var o=e.getParams().metaType;_common__WEBPACK_IMPORTED_MODULE_0__.p(t,(function(t,a){if(t)e.setCache("deleteError",!0);else{if(e.setCache("deleteError",!1),cb.utils.alert("操作成功","success"),"treevoucher"===o){var i=e.getTreeModel();if(i){var _=i.getSelectedKeys();if(_&&1==_.length){var c=i.getSelectedNodes()[0],l=i.getNextSibling(c),s=i.getPrevSibling(c),d=i.getParentNode(c);if(i.deleteNode(_),cb.extendConfig.yyarchive.treeCard||null===(cb.extendConfig.treeVoucher||{}).selectAfterDelete)_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e);else if("prev"===(cb.extendConfig.treeVoucher||{}).selectAfterDelete)_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e,i._get_data("dataSource")),i.selectNodes(s||l||d);else if("next"===(cb.extendConfig.treeVoucher||{}).selectAfterDelete)_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e,i._get_data("dataSource")),i.selectNodes(l||s||d);else{(i._get_data("dataSource")||[]).length>0?(_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e,i._get_data("dataSource")),i.selectNodes(l||s||d)):(_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),e.biz.do("add",e))}}}}else{if(!e.getCache("condition"))return void e.communication({type:"return"});e.getParams().menuId?window.parent!==window&&window.jDiwork?jDiwork.closeWin():render(e):r||e.communication({type:"return"})}e.getCache("returnList")&&(e.communication({type:"return"}),e.setCache("returnList",!1))}n({err:t,res:a},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),a)},doDelete=function(e,t,a,n,r){var o=t.getParams().metaType;if("treevoucher"===o){if(!(_=_getTreeSelectNode(t)))return void cb.utils.alert("请选择有效数据","warning");if(_&&_.children&&_.children.length>0&&!cb.extendConfig.yyarchive.treeCard)return void cb.utils.alert("有下级，不能删除","warning")}var i=t.getNecessaryData();if("treevoucher"===o&&cb.extendConfig.yyarchive.treeCard){var _=_getTreeSelectNode(t);i=_}var c={billnum:e,data:JSON.stringify(i)};n({params:a,data:c},(function(){var e=t.getParams().caption,n=!1;cb.utils.confirm("是否确认删除此"+e,(function(){var _=cb.extendConfig.yyarchive.deleteReturn;if(_&&!t.getParams().menuId&&"treevoucher"!==o){"ncc"==themeType&&(_=_handlePageInfoStatus(t,a));var l=t.allActions.find((function(e){var t="cmd"+_;return e.cCommand&&e.cCommand.trim().toLocaleLowerCase()===t}));l&&(t.biz.do(_,t,l),n=!0)}t.getCache("isReturn")&&(n=!0),"treevoucher"===o&&cb.extendConfig.yyarchive.treeCard?cb.utils.confirm("删除时要做业务引用校验，可能等待的时间较长，是否确认删除？",(function(){i&&i.children&&i.children.length>0?cb.utils.confirm("该操作将会删除当前"+e+"及其子"+e+"，是否继续？",(function(){_delete(t,a,c,r,n)})):_delete(t,a,c,r,n)})):_delete(t,a,c,r,n)}),(function(){a&&a.enabledCallback&&a.enabledCallback()}))}))},moveFirstOrLast=function(e,t,a,n,r){var o={billnum:e,condition:t.getCache("condition")};n({params:a,data:o},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,n){r({err:e,res:n},_common__WEBPACK_IMPORTED_MODULE_0__.a),e||(_handlePageInfoStatus(t,a),render(t,n))}),o)}))},movePrevOrNext=function(e,t,a,n,r){if(t.setCache("deleteError",!1),t.getCache("condition")){var o="get"==(a.cHttpMethod?a.cHttpMethod.toLocaleLowerCase():"get")?encodeURI(JSON.stringify(t.getCache("condition"))):t.getCache("condition"),i={billnum:e,id:t.get("id").getValue(),condition:o};n({params:a,data:i},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(n,o){if(n){var i={err:n,res:o};n&&!o&&t.setCache("returnList",!0),r(i,_common__WEBPACK_IMPORTED_MODULE_0__.a)}else{var _=_tplIsEquql(o,t);t.getCache("deleteError")||_reloadVoucher(_,o,t,e,r),_handlePageInfoStatus(t,a)}}),i)}))}},pull=function(e,t,a,n,r){var o=new cb.utils.queryString(a.cSvcUrl),i=o.get("code"),_=o.get("targetBillNo");if(i&&_){var c={code:i,isMainSelect:1,childIds:[t.get("id").getValue()]},l={cSvcUrl:o.pathname+o.toStr(),cHttpMethod:a.cHttpMethod};n({params:a,data:c},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(l,(function(e,a){if(!e){var n={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,carryData:a},o={billtype:"yyarchive",billno:_,params:n};cb.loader.runCommandLine("bill",o,t)}r({err:e,res:a},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),c)}))}},saveAndAdd=function(e,t,a){var n=t.allActions&&t.allActions.find((function(e){return"save"===e.cAction.trim().toLocaleLowerCase()}));if(n){n=Object.assign({},n,{cAction:a.cAction});save(e,t,n,(function(e,a){t.promiseExecute("beforeSave",e,a)}),(function(n){var r,o;r=n,o=function(){if(cb.invoker&&cb.invoker.publishLoadData(!1),n.err)_common__WEBPACK_IMPORTED_MODULE_0__.a(n);else{t.clear(!1);var r=t.allActions&&t.allActions.find((function(e){return"add"===e.cAction.trim().toLocaleLowerCase()}));(r=Object.assign({},r,{cAction:a.cAction})).saveData=n.res,add(e,t,r,(function(e,a){t.promiseExecute("beforeAdd",e,a)}),(function(e,a){t.promiseExecute("afterAdd",e,(function(){a&&a(e),t._get_data("propertyNames").forEach((function(e){var a=t.get(e);a instanceof cb.models.BaseModel&&a.doPropertyChange("validate",{type:"",message:""})}),t)}))})),window.location.reload()}},t.promiseExecute("afterSave",r,(function(){o&&o(r)}))}))}else cb.utils.alert("没有取到保存参数","error")},saveAndAudit=function(e,t,a){var n=t.allActions&&t.allActions.find((function(e){return"save"===e.cAction.trim().toLocaleLowerCase()}));if(n){n=Object.assign({},n,{cAction:a.cAction});save(e,t,n,(function(e,a){t.promiseExecute("beforeSave",e,a)}),(function(n){var r,o;r=n,o=function(){if(n.err)_common__WEBPACK_IMPORTED_MODULE_0__.a(n);else{var r=t.allActions&&t.allActions.find((function(e){return"audit"===e.cAction.trim().toLocaleLowerCase()}));r?(r=Object.assign({},r,{cAction:a.cAction}),audit(e,t,r,(function(e,a){t.promiseExecute("beforeAudit",e,a)}),(function(e,a){t.promiseExecute("afterAudit",e,(function(){a&&a(e)}))}))):cb.utils.alert("没有取到提交参数","error")}},t.promiseExecute("afterSave",r,(function(){o&&o(r)}))}))}else cb.utils.alert("没有取到保存参数","error")},add=function(e,t,a,n,r){var o;if(!t)return _getInitdata(e,a,r);if(!(a=a||{}).cAction){var i=t.allActions&&t.allActions.find((function(e){return"add"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,i)}var _=new cb.utils.queryString(a.cSvcUrl),c=[];if(_.has("code")){var l={billtype:"billmaker",billno:_.get("billno"),params:{code:_.get("code"),makeBilltype:_.get("makeBilltype")}};cb.loader.runCommandLine("bill",l,null,(function(o,i){var _=function(e,t){c=t,r({err:e,params:a,res:t},_common__WEBPACK_IMPORTED_MODULE_0__.a)},l={billnum:e};n({params:a,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.s(l,a,_),o.on("afterOkClick",(function(e){if(e.data){_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD);var a=_common__WEBPACK_IMPORTED_MODULE_0__.e(e.data,c);render(t,a,!0)}})),o.on("close",(function(){t.communication({type:"modal",payload:!1})})),t.communication({type:"modal",payload:{type:"platform",url:"billmaker",model:t,data:{vm:o,viewmeta:i}}})}))}))}else{var s,d=t.getParams().metaType;if("treevoucher"===d){var u=t.getTreeModel().getState("maxLevel"),m=!1===u?65536:u||3;if((s=_getTreeSelectNode(t))&&s.level>m)return void cb.utils.alert("分类最多"+(m+1)+"级","error")}var f={billnum:e};if(Object.assign(f,a.carryParams),"treevoucher"===d&&cb.extendConfig.yyarchive.treeCard){var E=t.getTreeModel(),p=E.getState("keyField");f=Object.assign({},f,((o={})[p]=s&&s[E.getState("keyField")],o))}n({params:a,data:f},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.s(f,a,(function(e,n){var o={err:e,params:a,res:n};if(!e){if(_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),t.addData=n,t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)){var i=t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).getValue();n[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]=i}if("treevoucher"===d){var _=t.getTreeModel(),c=_.getState("parentField");cb.extendConfig.yyarchive.treeCard&&n&&null==n[c]&&s&&(n[c]=s[_.getState("keyField")],n.parent_name=s.name)}if(cb.extendConfig&&"ncc"==cb.extendConfig.theme?render(t,n,!0):render(t,Object.assign({},n,a.carryData),!0,!a.carryData),a.callback)a.callback();else{var l=t.getParams(),u=l.masterOrgField,m=l.masterOrgKeyField,f=t.get(u);if(f){var E=t.get(m);if(E){var p=E.getValue();if(p){var v={isExtend:!0,simpleVOs:[{field:"id",op:"in",value1:p}]},g=function(){return E.setValue(null),t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1),f.setDisabled(!1),!1},D=f.getCache("vm");D?D.execute("pressEnter",{model:f,condition:v,browse:!1,errCallBack:g}):f.browse(!1,(function(e){e.on("getRefMetaReady",(function(){e.execute("pressEnter",{model:f,condition:v,browse:!1,errCallBack:g})}))}))}}}}}r(o,_common__WEBPACK_IMPORTED_MODULE_0__.a)}))}))}},getPredicateValue=function(e){var t=/<%.*?%>/g,a=e.match(t);if(!a)return e;var n={},r=!0;return a.forEach((function(e){var t=e.substring(2,e.length-2).split(".");if(2===t.length){var a=cb.rest.AppContext[t[0]];n[e]=a&&(cb.utils.isEmpty(a[t[1]])?"":a[t[1]])}else r=!1})),r?e.replace(t,(function(e){return n[e]})):e},localoutput=function(billNo,viewmodel,params,beforeAct,afterAct){for(var XLSX=__webpack_require__(2425),outputData=viewmodel.get(""+params.childrenField).getData(),dataColumns=viewmodel.get(""+params.childrenField).getColumns(),res=[],tmpObj={},i=0;i<outputData.length;i++){var resObj={};for(var key in dataColumns){var keyName=dataColumns[key].cShowCaption?dataColumns[key].cShowCaption:dataColumns[key].cCaption;if(dataColumns[key].bShowIt&&!dataColumns[key].bHidden){var resDetails=outputData[i],resSonObj={};resSonObj.cShowCaption=keyName,resSonObj.cControlType=dataColumns[key].cControlType,resSonObj.cFormatData=dataColumns[key].cFormatData,resSonObj.iNumPoint=dataColumns[key].iNumPoint,resSonObj.cEnumString=dataColumns[key].cEnumString;var enumValue=null;if(dataColumns[key].cEnumString){var enumString=dataColumns[key].cEnumString,lookupVector=Object.keys(eval("("+enumString+")")),resultVector=Object.values(eval("("+enumString+")")),thisLoc=lookupVector.indexOf(resDetails[key].toString());enumValue=resultVector[thisLoc]}resSonObj.iColWidth=dataColumns[key].iColWidth,tmpObj[key]=resSonObj,resObj[keyName]=enumValue||resDetails[key]}}res.push(resObj)}var fileName=billNo+".xlsx",sheet=XLSX.utils.json_to_sheet(res),sheetRowCount=res.length,colCount=Object.keys(res[0]).length;sheet["!cols"]=new Array(colCount);for(var rowRange=XLSX.utils.decode_range(sheet["!ref"]),R=0;R<=1;++R)for(var C=rowRange.s.c;C<=rowRange.e.c;++C)if(0==R){var cell_address={c:C,r:R},cell_ref=XLSX.utils.encode_cell(cell_address),value=sheet[cell_ref].v;for(var key in tmpObj)if(tmpObj[key].cShowCaption===value){var controlType=tmpObj[key].cControlType,cellConfig=tmpObj[key],cFormatData=cellConfig.cFormatData;if(sheet["!cols"][C]={wpx:cellConfig.iColWidth},"YYYY-MM-DD"===cFormatData)for(var colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_1=colRange.s.r;R_1<=colRange.e.r;++R_1){var thisCell_address={c:C,r:R_1},thisCell_ref=XLSX.utils.encode_cell(thisCell_address);sheet[thisCell_ref].t="d"}switch(controlType&&controlType.trim().toLocaleLowerCase()){case"inputnumber":case"money":case"price":try{cFormatData=cFormatData&&""!=cFormatData?JSON.parse(cFormatData):{}}catch(e){cb.utils.alert("数量/金额/单价，预制错误！","error")}var iNumPoint=cellConfig.iNumPoint,decimal=cFormatData.decimal?getPredicateValue(cFormatData.decimal):null;if("money"===controlType?iNumPoint=decimal||cb.rest.AppContext.option.amountofdecimal:"price"===controlType?iNumPoint=decimal||cb.rest.AppContext.option.monovalentdecimal:decimal?iNumPoint=decimal:cb.utils.isEmpty(iNumPoint)&&(iNumPoint=null),("money"===controlType||cFormatData.decimal&&cFormatData.decimal.indexOf("amountofdecimal"))&&(cFormatData.splitter=!0,!iNumPoint))for(var colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_2=colRange.s.r;R_2<=colRange.e.r;++R_2){var thisCell_address={c:C,r:R_2},thisCell_ref=XLSX.utils.encode_cell(thisCell_address);sheet[thisCell_ref].z=XLSX.SSF._table[3]}if(iNumPoint)for(var colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_3=colRange.s.r;R_3<=colRange.e.r;++R_3){for(var thisCell_address={c:C,r:R_3},thisCell_ref=XLSX.utils.encode_cell(thisCell_address),decimalCount=cFormatData.splitter?"#,##0.0":"0.0",i=1;i<iNumPoint;i++)decimalCount+="0";sheet[thisCell_ref].z=decimalCount}}}}else if(1===R){var cell_address={c:C,r:R},cell_ref=XLSX.utils.encode_cell(cell_address);if("n"===sheet[cell_ref].t){var length_1=sheet[cell_ref].v.toString().length;if(sheet[cell_ref].z){var re=/[0-9]+\.([0-9]*)/,deciLength=sheet[cell_ref].v.toString().replace(re,"$1").length;length_1+=deciLength}else if(length_1>=12)for(var colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_4=colRange.s.r;R_4<=colRange.e.r;++R_4){var thisCell_address={c:C,r:R_4},thisCell_ref=XLSX.utils.encode_cell(thisCell_address);sheet[thisCell_ref].z=XLSX.SSF._table[1]}}else if("b"===sheet[cell_ref].t)for(var colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_5=colRange.s.r;R_5<=colRange.e.r;++R_5){var thisCell_address={c:C,r:R_5},thisCell_ref=XLSX.utils.encode_cell(thisCell_address);sheet[thisCell_ref].t="s",sheet[thisCell_ref].v=sheet[thisCell_ref].v?"是":"否"}}var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,sheet,""+params.childrenField),XLSX.writeFile(wb,fileName)},output=function(e,t,a,n,r){var o="";window._baseUrl&&(o="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var i=o+"/files"+a.cSvcUrl,_=new cb.utils.queryString(i);if(_){var c={billnum:e,ids:[t.get("id").getValue()].join(),id:t.get("id").getValue(),data:a.data,partParam:a.partParam},l=_&&_.pathname+_.toStr();n({params:a,data:c},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.l(l,c),r()}))}},savebo=function(e,t,a,n,r){cb.rest.DynamicProxy.create({saveBo:{url:"print/saveBo",method:"GET"}}).saveBo({billno:e},(function(e,t){e?cb.utils.alert(e.message,"error"):cb.utils.alert("保存业务对象成功","success")}))},preview=function(e,t,a,n,r){var o=a.params&&a.params.cAction;if("localPrint"===o){var i=t.get("btnLocalPrint");return i&&(a.disabledCallback=function(){i.setDisabled(!0)},a.enabledCallback=function(){i.setDisabled(!1)}),void t.biz.do(o,t,a)}n({params:a},(function(){var n="",o="",i="";if(a.cParameter){var _=JSON.parse(a.cParameter);n=_&&_.printTplItemName}if(n?(o=t.get(n).getValue())||(i="请选择打印模板。"):i="请预置打印按钮的cParameter信息{printTplItemName : 打印模板的cItemName}",""!=i)return cb.utils.alert(i,"warning"),void r({err:i});var c=window.open("about:blank");cb.rest.DynamicProxy.create({preview:{url:"print/printPreview",method:"POST"}}).preview({route:a.cSvcUrl||"/bill",billno:e,template:o,ids:[t.get("id").getValue()]},(function(e,t){e||(c.location.href=t),r({err:e,res:t},_common__WEBPACK_IMPORTED_MODULE_0__.a)}))}))},print=function(e,t,a,n,r){var o=t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY)&&t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY).getValue()&&t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY).getValue().toString(),i={json:{bill:{billnum:e,ids:[t.get("id").getValue()],tplid:o},type:"yyarchive"}};n({params:a,data:i},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.o(i,a,(function(e,t){e?console.error(e):(window.open(t),r())}))}))},initDefaultActions=function(e,t,a,n,r){var o=t.allActions;n({params:a,data:o},(function(){t.on("moveprev",(function(){var a=o.find((function(e){return e.cCommand&&"cmdmoveprev"===e.cCommand.trim().toLocaleLowerCase()}));a&&movePrevOrNext(e,t,a)})),t.on("movenext",(function(){var a=o.find((function(e){return e.cCommand&&"cmdmovenext"===e.cCommand.trim().toLocaleLowerCase()}));a&&movePrevOrNext(e,t,a)})),t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).on("afterValueChange",(function(e){e&&e.value&&t.biz.do("selecttpl",t,e)})),r()}))},selectTpl=function(e,t,a,n,r){a.tplid=a.value.value;var o=function(n,o){var i=_common__WEBPACK_IMPORTED_MODULE_0__.z(n,o,e,a);if(i){var _=i.vm,c=i.view;t.communication({payload:{menuName:c.cBillName,vm:_,refresh:!0,metaData:c}}),_loadVm(t,_),_common__WEBPACK_IMPORTED_MODULE_0__.G(_,_common__WEBPACK_IMPORTED_MODULE_0__.w(t));var l,s=void 0;_common__WEBPACK_IMPORTED_MODULE_0__.w(_)==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD?(l=t.collectData(!0),s=t.addData):(l=t.getOriginalData(),s=t.collectData(!0)),_.setData(s),render(_,l,_common__WEBPACK_IMPORTED_MODULE_0__.w(_)==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),r&&r()}};n({params:a},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.t(e,a,o)}))},push=function(e,t,a,n,r){if(console.log("begin-push--"+(new Date).valueOf()),t)_common__WEBPACK_IMPORTED_MODULE_0__.D(t,a,t.collectData(!0),n,r);else if(a&&a.cSvcUrl){var o=new cb.utils.queryString(a.cSvcUrl),i=o.get("groupCode"),_=o.get("code");if(_){cb.utils.isArray(a.data)||(a.data=[a.data]);var c=[],l=[];a.data.forEach((function(e){c.push(e.id),a.pushKey&&l.push(e[a.pushKey])}));var s=a.pushKey?l:Array.from(new Set(c)),d=a.pushKey?Array.from(new Set(c)):void 0,u={code:_,isMainSelect:a.pushKey?0:1,childIds:s,mainIds:d,data:a.data,groupCode:i};Object.assign(u,a.carryParams),console.log("doProxy-push--"+(new Date).valueOf()),_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(t,n){t?window.parent!==window&&cb.rest.AppContext.query.random?window.parent.postMessage({key:"crossdomainpush",random:cb.rest.AppContext.query.random,args:t.message},"*"):_common__WEBPACK_IMPORTED_MODULE_0__.a({err:t}):(window.parent!==window&&cb.rest.AppContext.query.random&&window.parent.postMessage({key:"crossdomainpush",random:cb.rest.AppContext.query.random},"*"),n.targetData&&(delete n.targetData._status,a.carryParams=a.carryParams||{},a.carryParams.externalData=n.targetData,a.targetData=n.targetData,n.dimensionKeys&&n.dimensionKeys.length>1&&(a.dimensionKeys=n.dimensionKeys),a.dimensionGroupCode=i,a.groupTaskKey=n.dimensionKeys&&n.dimensionKeys.length&&n.dimensionKeys[0].groupTaskKey,a.bWorkbench=!!i,n.targetData.dimensionKey=n.dimensionKeys&&n.dimensionKeys[0]&&n.dimensionKeys[0].key,_getInitdata(e,a,(function(e,t){e?_common__WEBPACK_IMPORTED_MODULE_0__.a({err1:e}):(console.log("_getInitdata-push--"+(new Date).valueOf()),r(null,_common__WEBPACK_IMPORTED_MODULE_0__.e(t,n.targetData)),console.log("afterAct-push--"+(new Date).valueOf()))}))))}),u)}}},compositeAction=function(e,t,a){var n=null,r=null;try{var o=JSON.parse(a.cParameter);if(n=o.action.split("&")[0].replace(/(\w)/,(function(e){return e.toUpperCase()})),!(r=t.biz.action()[n.trim().toLocaleLowerCase()]))return;a.defineParams=o}catch(e){return void console.error("compositeAction error: "+e.message)}r(e,t,a,(function(e,a){t.promiseExecute("before"+n,e,a)}),(function(e,a){t.promiseExecute("after"+n,e,(function(){a&&a(e)}))}),a.cShowCaption)},saveDraft=function(e,t,a,n,r){t.communication({type:"modal",payload:{key:"Savedraft",data:{model:t}}})},saveDatatemp=function(e,t,a,n,r){t.communication({type:"modal",payload:{key:"Savedatatemp",data:{model:t}}})},getYhtUserIds=function(e,t){e&&(e.user&&e.person?getYhtUserId("user",e.user,(function(a){getYhtUserId("person",e.person,(function(e){t(a.concat(e))}))})):(e.user&&getYhtUserId("user",e.user,t),(e.person||e.id)&&getYhtUserId("person",e.person||e.id,t)))},getYhtUserId=function(e,t,a){var n="",r="";switch(e){case"user":n="productcenter.aa_user",r="yhtUserId";break;case"person":case"id":n="ucf-staff-center.bd_staff_ref",r="userId"}if(n){var o=cb.rest.DynamicProxy.create({getYhtUserId:{url:"/bill/ref/getRefData",method:"POST"}}),i=[];t.forEach((function(e){var t=e.getValue();t&&i.push(t)}));var _={refCode:n,dataType:"grid",condition:{isExtend:!0,simpleVOs:[{field:"id",op:"in",value1:i}]}};o.getYhtUserId(_,(function(e,t){if(t&&t.recordList&&t.recordList.length){var n=[];t.recordList.forEach((function(e){n.push(e[r])})),a(n)}}))}},_getNotice=function(e,t,a){var n=e.get(t);if(n){var r=n.getValue();return r&&a&&(r=new Date(r).format("yyyy-MM-dd")),{key:n.getState("cShowCaption"),value:r}}},ecsuite=function(e,t,a,n,r){var o=(a.cParameter&&JSON.parse(a.cParameter)||{}).action,i=t.get("id").getValue(),_=location.origin+"/meta/yyarchive/"+e+"/"+i,c=_,l=t.getParams().caption,s=[];switch(["code","vouchdate","creator"].forEach((function(e){var a=_getNotice(t,e,"vouchdate"===e);a&&s.push(a)})),o){case"cooperation":YYCooperationBridge.YYLanuchFlow({name:l,objectName:"YonSuite",objectId:i,webUrl:_,mobileUrl:c});break;case"task":YYCooperationBridge.YYRenderCreateTask({objectName:"YonSuite",objectId:i,idList:[]});break;case"discussion":var d=t.getCache("ecsuiteItems");d?getYhtUserIds(d,(function(e){YYCooperationBridge.YYGroupChat({objectId:i,docCode:t.get("code")&&t.get("code").getValue(),webUrl:_,mobileUrl:c,name:l,notice:s,idList:e})})):YYCooperationBridge.YYGroupChat({objectId:i,docCode:t.get("code")&&t.get("code").getValue(),webUrl:_,mobileUrl:c,name:l,notice:s,idList:[]});break;case"chat":getYhtUserId(a.type,[a.model],(function(e){YYCooperationBridge.YYChat({id:e[0],webUrl:_,mobileUrl:c,name:l,notice:s})}))}},voucherDo=function(e,t,a,n,r){var o=t.getNecessaryData(),i={billnum:e,data:JSON.stringify(o)};n({params:a,data:i},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,n){if(!e&&(cb.utils.alert(a.cShowCaption+"成功","success"),n)){var o=t.collectData(!0),i=_common__WEBPACK_IMPORTED_MODULE_0__.e(o,n);render(t,i)}r({err:e,res:n},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),i)}))},asyncMeta=function(e,t,a,n){return new Promise((function(r){var o=t.cardViewModel;if(o)return o.biz.do("load",o,{data:a}),void cb.utils.loadingControl.end();var i=Object.assign({},t);a&&a.tplid&&t&&!t.tplid&&(i.tplid=a.tplid),t&&t.carryData&&(a=Object.assign(a,t.carryData));var _=function(t,o){i.billData=a,_fetchMetaCallback(t,o,e,n,i,r,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.t(e,i,_)}))};_common__WEBPACK_IMPORTED_MODULE_0__.t(e,i,_)}))},processWorkflow=function(e,t,a){parseViewModel(e,a),parseContainer(t.view,a)},parseViewModel=function(e,t){for(var a in t)"mainTable"===a?parseMainEntity(e,t[a]):parseChildEntity(e,a,t[a])},parseMainEntity=function(e,t){for(var a in t){var n=e.get(a);if(n instanceof cb.models.BaseModel){var r=t[a],o=r.visible,i=r.editable;n._set_data("bShowIt",o),n._set_data("bCanModify",i)}}},parseChildEntity=function(e,t,a){var n=e.get(t);if(n instanceof cb.models.BaseModel){var r=n._get_data("columns");if(r)for(var o in a){var i=r[o];if(i){var _=a[o],c=_.visible,l=_.editable;i.bShowIt=c,i.bCanModify=l}}}},parseContainer=function(e,t){e.containers?e.containers.forEach((function(e){parseContainer(e,t)})):e.controls&&parseControls(e,t)},parseControls=function(e,t){var a=t[e.childrenField||"mainTable"];if(a){var n=[];e.controls.forEach((function(e){var t=a[e.cItemName];t&&!t.visible||n.push(e)})),e.controls=n}},getAllControls=function(e,t){for(var a=[],n=e.length,r=0;r<n;r++){var o=document.getElementById(e[r]);if(!o)return;var i=o.querySelectorAll(t.join(",")),_=i.length;a[r]=[];for(var c=0;c<_;c++)a[r][c]=i[c]}return a},afterInitData=function(e,t,a,n){return __awaiter(this,void 0,void 0,(function(){var r,o,i,_,c,l,s,d,u;return __generator(this,(function(m){switch(m.label){case 0:(r=[]).push(asyncMeta(e,t,a,n)),o=[],i=0,_=r.length,m.label=1;case 1:return i<_?(l=(c=o).push,[4,r[i]]):[3,4];case 2:l.apply(c,[m.sent()]),m.label=3;case 3:return i++,[3,1];case 4:return s=o[0],d=s.vm,u=s.view,o[1]&&("workflownoctrl"===o[1]?d.getParams().workflowNoCtrl=!0:processWorkflow(d,u,o[1])),d.promiseExecute("afterLoadMeta",s,(function(){var e=u.cBillName;n(d,u,e);var a=d.getCache("groupIds")||[],r=d.getCache("selectors")||[];if(a.length&&r.length){var o=getAllControls(a,r);d.execute("afterInitKeyboard",o)}var i=d.getGridModels(),_=d.get("addGrandSonTable"),c=d.getParams().billNo,l=(cb.rest.AppContext.user||{}).id;i.forEach((function(e){var t=e.getName(),a=c+"_"+l+"_"+t,n=null;cb.indexDB.openDB("cacheInfo",1,["billInfo"]).then((function(t){t?cb.indexDB.IDB_getData({dbTableName:"billInfo",dbName:"cacheInfo",key:a}).then((function(t){if(n=t)for(var a in n)"indexedDB_id"!=a&&e.setColumnState(a,"iColWidth",n[a])})):console.error("打开数据库失败，缓存功能不可用！")})).catch((function(e){console.error(e)})),e.on("afterSetDataSource",(function(){var t=e.getCache("afterAct");t&&t(),setTimeout((function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(e,d,d.getParams().mode)}))})),e.on("afterMount",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(e,d,d.getParams().mode)})),e.on("afterInsertRow",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(e,d,d.getParams().mode)})),e.on("afterInsertRows",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(e,d,d.getParams().mode)})),e.on("afterInsertRowsFromRefer",(function(e){d.biz.do("referrowscheck",d,Object.assign({childrenField:t},e))})),_&&(e.on("beforeSetDataSource",(function(e){return e.forEach((function(e){e.id?e.rid||(e.rid=e.id):e.rid||(e.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()())})),e})),e.on("beforeInsertRow",(function(e){return e.row.rid=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()(),e})),e.on("beforeInsertRows",(function(e){var t=e.rows;return t.forEach((function(e){e.id?e.rid||(e.rid=e.id):e.rid||(e.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()())})),t}))),e.on("colWidthResize",(function(e){var t=e.columnKey,r=e.width;n||(n={indexedDB_id:a}),n[t]=r,cb.indexDB.IDB_saveData(n,"billInfo","cacheInfo")})),e.on("colWidthReturn",(function(e){n={id:a,dbTableName:"billInfo",dbName:"cacheInfo"},cb.indexDB.IDB_deleteOneData(n)}))})),d.get("addAttachment")&&i.forEach((function(e){e.on("beforeSetDataSource",(function(e){return e.forEach((function(e){e.id?e.attachmentId||(e.attachmentId=e.id):e.attachmentId||(e.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()())})),e})),e.on("beforeInsertRow",(function(e){return e.row.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()(),e}))})),_managePageInfoStatue(d,c);var s=d.getParams(),m=s.billData;if("treevoucher"===s.metaType){var f=d.getTreeModel();if(_bindTreeAttachment(d),f&&f.getState("banQuery")||(_loadTree(d,{billnum:c,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(d,"treeName")}),_bindTreeSelect(d,c)),d.getParams().mode!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD){var E=d.getTreeModel();E&&!E.getState("defaultSelectedKeys")&&E.setState("defaultSelectedKeys",!0)}else d.biz.do("add",d)}else d.biz.do("load",d,{data:m});d.getCache("bindTreeSelect")&&d.getTreeModel()&&_bindTreeSelect(d,c),d.biz.do("code",d),d.biz.do("org",d),d.biz.do("depends",d),d.biz.do("rule",d),_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.USEFORMULARULE&&d.biz.do("formularule",d),_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.USESTATERULE&&d.biz.do("staterule",d),t.copy&&d.biz.do("copy",d),_afterViewCallback(c,d,t)})),[2]}}))}))},_handlePageInfoStatus=function(e,t,a){return __awaiter(this,void 0,void 0,(function(){var n,r,o,i,_,c,l,s,d,u,m,f,E,p;return __generator(this,(function(v){switch(v.label){case 0:if("ncc"!=themeType)return[2,!1];if(n=e.get("btnMovefirst"),r=e.get("btnMovelast"),o=e.get("btnMoveprev"),i=e.get("btnMovenext"),_=e.getCache("parentViewModel"),c=_&&_.getCache("lastSearchCondition"),l=e.getCache("curVoucherIndex"),s=e.getCache("recordCount"),!c||cb.utils.isEmpty(l)||!s)return n&&n.setState("disabled",!0),r&&r.setState("disabled",!0),o&&o.setState("disabled",!0),i&&i.setState("disabled",!0),[2,!1];if(d=null,!t)return[3,9];switch(u=t.cAction,u){case"movenext":return[3,1];case"moveprev":return[3,2];case"movelast":return[3,3];case"movefirst":return[3,4];case"delete":return[3,5];case"save":return[3,6]}return[3,8];case 1:return l+=1,[3,8];case 2:return l-=1,[3,8];case 3:return l=s-1,[3,8];case 4:return l=0,[3,8];case 5:return s-=1,m=cb.extendConfig.yyarchive.deleteReturn,d=m,"movenext"==m?l==s&&(d="moveprev",l=s-1):"moveprev"==m&&(0==l&&(d="movenext"),l=l-1<0?0:l-1),0==s&&(d=!1),e.setCache("curVoucherIndex",l),e.setCache("recordCount",s),[2,d];case 6:return _common__WEBPACK_IMPORTED_MODULE_0__.w(e)==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT?[2]:[4,_getParentAllList(_)];case 7:f=v.sent(),E=f.recordList||[],(p=E.findIndex((function(e){return e.id==a.id})))>-1?(s=f.recordCount||E.length,l=p):(s=1,l=0),v.label=8;case 8:e.setCache("curVoucherIndex",l),e.setCache("recordCount",s),v.label=9;case 9:return 1==s?(n&&n.setState("disabled",!0),r&&r.setState("disabled",!0),o&&o.setState("disabled",!0),i&&i.setState("disabled",!0)):-1==l?(o&&o.setState("disabled",!0),i&&i.setState("disabled",!0),n&&n.setState("disabled",!0),r&&r.setState("disabled",!0)):0==l?(n&&n.setState("disabled",!0),o&&o.setState("disabled",!0),r&&r.setState("disabled",!1),i&&i.setState("disabled",!1)):l<s-1?(n&&n.setState("disabled",!1),r&&r.setState("disabled",!1),o&&o.setState("disabled",!1),i&&i.setState("disabled",!1)):l==s-1&&(r&&r.setState("disabled",!0),i&&i.setState("disabled",!0),n&&n.setState("disabled",!1),o&&o.setState("disabled",!1)),[2]}}))}))},_getParentAllList=function(e){return new Promise((function(t){var a=e.getGridModel(),n=a._get_data("proxyConfig");if(n){var r=a._get_data("queryParams"),o=cb.rest.DynamicProxy.create({queryData:n});delete r.page,o.queryData(r,(function(e,a){e?cb.utils.alert(e.message,"error"):t(a)}))}}))},_managePageInfoStatue=function(e,t){"ncc"===themeType&&e.on("afterLoadData",(function(){var t=e.getCache("curVoucherIndex"),a=e.getCache("recordCount");if(cb.utils.isEmpty(t)||!a){var n=e.getCache("parentViewModel");if(n){var r=n.getCache("curVoucherIndex"),o=n.getCache("pageInfo");if(!cb.utils.isEmpty(r)&&o)t=(o.pageIndex-1)*o.pageSize+r,a=o.recordCount,e.setCache("curVoucherIndex",t),e.setCache("recordCount",a)}}_handlePageInfoStatus(e)}))},rowDetail=function(e,t,a,n,r){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),i=o.getCache("cSunBillNo");if(i){var _=a&&a.params&&!cb.utils.isEmpty(a.params.index)?a.params.index:"";if(cb.utils.isEmpty(_))cb.utils.alert("未获取到行号","error");else{var c=o.getRow(_),l=c.rid;if(l){var s=_common__WEBPACK_IMPORTED_MODULE_0__.w(t),d={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,id:l,rowData:c,carryParams:{}};s==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&(d.readOnly=!0);var u={billtype:"yyarchive",billno:i,params:d};n({params:a,data:u},(function(){cb.loader.runCommandLine("bill",u,t),r()}))}else console.error("缺少子表id")}}},jointquery=function(e,t,a,n,r){var o={params:{editType:"jointquery"},parentViewModel:t,billNum:e,billId:t.get("id").getValue()};if(a&&a.childrenField){var i=[];i.push(t.getGridModel().getRow(a.params.index).id);var _={childIds:i},c={childKey:a.childrenField};o=Object.assign(o,_,c)}n(o,(function(){t.communication({payload:{title:"单据联查结果显示",type:"platform",url:"voucher-search/ShowFlow",checkReturn:!0,modal:t,data:o}})}))},printPreview=function(e,t,a,n,r){n(a,(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.x(a,"preview",t),n=e.currentParams,o=e.url;if(!n)return!1;window.open(o+_common__WEBPACK_IMPORTED_MODULE_0__.i(n),"_blank"),r()}))},printDesign=function(e,t,a,n,r){n({params:a},(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.x(a,"design",t),n=e.currentParams,r=e.url;window.open(r+_common__WEBPACK_IMPORTED_MODULE_0__.i(n),"_blank")}))},printNow=function(e,t,a,n,r){n(a,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.B(a,t),r()}))},batchOutputVoucher=function(e,t,a,n,r){var o=t.getGridModel(),i=t.getTreeModel(),_={billnum:e};if(i){var c=i.getSelectedKeys();if(c.includes("main")){var l=i._get_data("keyMap");c=Object.keys(l)}cb.utils.isArray(c)?_.ids=c.join():"string"==typeof c&&(_.ids=c)}else if(o){var s=a&&a.params&&null!=a.params.index?[o.getRow(a.params.index)]:o.getSelectedRows();if(!s||0==s.length)return void cb.utils.alert("请选择","warning");var d=[];s.forEach((function(e){e.id&&e.pubts&&d.push(e.id)}),_this),_.ids=d.join()}var u="";window._baseUrl&&(u="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var m=u+"/files"+a.cSvcUrl,f=new cb.utils.queryString(m),E=f&&f.pathname+f.toStr();n({params:a,data:_},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.l(E,_),r()}))},exportVoucherTemplate=function(e,t,a,n,r){var o="";window._baseUrl&&(o="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var i=o+"/files"+a.cSvcUrl,_=new cb.utils.queryString(i),c=_.pathname+_.toStr(),l={billnum:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey")};n({params:a,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.l(c,l),r()}))},importVoucher=function(e,t,a,n,r){var o={disabledCallback:a.disabledCallback,enabledCallback:a.enabledCallback};a.disabledCallback=!1,a.enabledCallback=!1;var i={params:a,data:{}},_=!1,c=1,l="asyncImport_"+cb.utils.getNewGuid().replace(/-/g,""),s="";if(a.cParameter){var d=JSON.parse(a.cParameter);d&&(_=d.isAsync,c=d.interval||c,s=d.acceptedFileType||"")}n(i,(function(){var e=document.createElement("input");e.type="file",s&&(e.accept=s),e.style.display="none",e.onchange=function(n){o.disabledCallback&&o.disabledCallback();var r=new FormData;r.enctype="multipart/form-data";var s=n.target.files[0],d=s&&s.name,u=s&&s.size;r.append("file",s),i.data.mapCondition&&r.append("mapCondition",JSON.stringify(i.data.mapCondition));var m=new XMLHttpRequest,f=a.cSvcUrl+"?billnum="+_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey");_&&(f=f+"&asyncKey="+l);var E=window._baseUrl?""+window._baseUrl+f:f;m.open("POST",E,!0),m.send(r),_?(o.enabledCallback&&o.enabledCallback(),m.onreadystatechange=function(){var e=!1,a="";if(4===m.readyState){if(200===m.status){var n=void 0;try{n=JSON.parse(m.responseText)}catch(t){e=!0,a="模板内容导入失败,返回信息："+m.responseText}200===n.code||(e=!0,a="模板内容导入失败，"+n.message+"。")}else e=!0,a="模板内容导入返回信息： xhr.readyState ="+m.readyState+"  xhr.status ="+m.status+"  xhr.responseText = "+m.responseText;if(e)cb.utils.alert(a);else{var r=cb.utils.getNowFormatDate(),i=t.getParams()&&(t.getParams().name||t.getParams().caption),_={asyncKey:l,fileSize:u,fileName:d,curTime:r,busName:i,percentage:0,asyncData:"{}"};t.communication({type:"asyncImport",payload:_});var s=setInterval((function(){asyncImportQuery(t,_,o)}),1e3*c);t.setCache(l,s),cb.utils.alert("导入已转入后台处理，可进行其它操作！")}}}):m.onreadystatechange=function(){if(4===m.readyState)if(o.enabledCallback&&o.enabledCallback(),200===m.status){var e=void 0;try{e=JSON.parse(m.responseText)}catch(e){return void cb.utils.alert("模板内容导入失败,返回信息："+m.responseText)}if(200===e.code){var a=e.data;a.sucessCount&&(t.execute("refresh"),t.execute("afterImport",a)),t.communication({type:"modal",payload:{key:"BatchMsg",data:{type:2,res:a}}})}else cb.utils.alert("模板内容导入失败，"+e.message+"。","error")}else console.log("模板内容导入返回信息： xhr.readyState ="+m.readyState+"  xhr.status ="+m.status+"  xhr.responseText = "+m.responseText)},document.body.removeChild(e)},document.body.appendChild(e),e.click()}))},asyncImportQuery=function(e,t,a){var n=t.asyncKey;cb.rest.DynamicProxy.create({getImportProcess:{url:"billtemp/getImportProcess?",method:"GET",options:{mask:!1}}}).getImportProcess({asyncKey:n},(function(a,n){var r="";if(a)return r=a.message,void handleAsyncImportOver(e,t,r);if(n){var o=void 0;try{o=JSON.parse(n)}catch(a){return void handleAsyncImportOver(e,t,r="模板内容导入失败,返回信息："+n)}var i=parseFloat(o.percentage||"0");"0"==o.flag?(r="模板内容导入失败",o.data&&(r=r+",返回信息："+o.data),handleAsyncImportOver(e,t,r)):1==o.flag&&i>=100&&(handleAsyncImportOver(e,t),e.execute("refresh"),e.execute("afterImport",o),e.execute("openNotification",Object.assign({res:o.data},t))),t.asyncData=n,t.percentage=i,e.communication({type:"asyncImport",payload:t})}}))},handleAsyncImportOver=function(e,t,a){var n=e.getCache(t.asyncKey);e.clearCache(t.asyncKey),n&&clearTimeout(n),a&&(cb.utils.alert(a),t.bDelTask=!0,t.errStr=a,e.communication({type:"asyncImport",payload:t}))},doCommunication=function(e,t,a,n,r){_common__WEBPACK_IMPORTED_MODULE_0__.n(e,t,a,n,r)},attachment=function(e,t,a,n,r){if(t.get("addAttachment")){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),i=a&&a.params&&null!=a.params.index?[o.getRow(a.params.index)]:o.getSelectedRows();if(0!=i.length)if(i.length>1)cb.utils.alert("附件管理只能单行显示","warning");else{var _=i[0];if(_.attachmentId){var c=t.getCache("attachmentCondition"),l=Object.assign({id:_.attachmentId},c);n({params:a,data:l},(function(){t.communication({type:"modal",payload:{key:"Attachment",data:{size:"md",data:l,model:t}}}),r()}))}else cb.utils.alert("行缺少附件id","warning")}else cb.utils.alert("请选择行","warning")}else console.log("扩展脚本需要配置addAttachment")},_bindTreeAttachment=function(e){var t=e.getTreeModel();e.get("addAttachment")&&t.on("beforeSetDataSource",(function(e){var a=t._get_data("childrenField")||"children",n=t._get_data("keyField")||"id";return function e(t){t.forEach((function(t){var r=t[a];t.attachmentId||(t.attachmentId=t[n]),r&&cb.utils.isArray(r)&&r.length>0&&e(r)}))}(e),e}))},voucherAttachment=function(e,t,a,n,r){if(t.get("addAttachment")){var o="";switch(_common__WEBPACK_IMPORTED_MODULE_0__.w(t)){case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE:case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT:var i=t.get("attachmentId").getValue();if(i)o=i;else if(c=t.get("id").getValue())t.get("attachmentId").setValue(c),o=c;else{var _=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()();t.get("attachmentId").setValue(_),o=_}break;case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD:var c;if(c=t.get("attachmentId").getValue())o=c;else{_=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()();t.get("attachmentId").setValue(_),o=_}}var l=t.getCache("attachmentCondition"),s=Object.assign({id:o},l);n({params:a,data:s},(function(){t.communication({type:"modal",payload:{key:"Attachment",data:{size:"md",data:s,model:t}}}),r()}))}else console.log("扩展脚本需要配置addAttachment")},stateRule=function(e,t,a,n,r){Object(_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.c)(e,t,a,n,r)},formulaRule=function(e,t,a,n,r){Object(_staterule_formularule__WEBPACK_IMPORTED_MODULE_4__.a)(e,t,a,n,r)},newback=function(e,t,a,n,r){cb.route.goBack()};return{init:function(e,t,a){!(t=t||{}).mode&&t.query&&t.query.mode&&(t.mode=t.query.mode),!t.id&&t.query&&t.query.id&&(t.id=t.query.id),cb.extendConfig.yyarchive||(cb.extendConfig.yyarchive={}),!t.hasOwnProperty("saveReturn")&&cb.extendConfig.yyarchive.hasOwnProperty("saveReturn")&&(t.saveReturn=cb.extendConfig.yyarchive.saveReturn);_getInitdata(e,t,(function(n,r){n?_common__WEBPACK_IMPORTED_MODULE_0__.a({err:n}):((r=r||{})._status===cb.models.DataStates.Insert&&(t.mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,t.realAdd=!1),afterInitData(e,t,r,a))}))},do:function(e,t,a){_common__WEBPACK_IMPORTED_MODULE_0__.K(this,e,t,a)},action:function(){var e={};try{e=cb.extendConfig.voucherExtendConfig}catch(t){console.log(t),e={}}var t={newback:newback,scan:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.r,share:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.t,platform:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.m,getnetworktype:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.j,getmac:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.h,dail:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.d,chooseimage:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.b,getlocation:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.g,openlocation:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.k,generateqrcode:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.f,request:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.p,startrecord:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.u,stoprecord:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.v,playvoice:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.n,pausevoice:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.l,stopvoice:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.w,changescreenorientation:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.a,restorescreenorientation:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.q,setstorage:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.s,getstorage:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.i,removestorage:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.o,clearstorage:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.c,uploadfile:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.x,downloadfile:_mtlapi__WEBPACK_IMPORTED_MODULE_6__.e,render:renderData,doservice:_doService,load:loadData,search:search,code:buildCode,org:buildOrg,depends:buildDepends,rule:buildRule,initdefaultactions:initDefaultActions,commandline:_common__WEBPACK_IMPORTED_MODULE_0__.j,abandon:abandon,copy:copy,push:push,edit:_common__WEBPACK_IMPORTED_MODULE_0__.r,save:save,addrow:addRow,table2dbtnclick:table2DBtnClick,insertrow:insertRow,deleterow:deleteRow,copyrow:copyRow,shiftuprow:shiftUpRow,shiftdownrow:shiftDownRow,delete:doDelete,invalid:inValid,workflow:workflow,audit:audit,submit:submit,unsubmit:unsubmit,unaudit:audit,close:close,open:open,movefirst:moveFirstOrLast,movelast:moveFirstOrLast,moveprev:movePrevOrNext,movenext:movePrevOrNext,add:add,create:add,pull:pull,check:check,refresh:refresh,columnsetting:_common__WEBPACK_IMPORTED_MODULE_0__.h,checkapprove:checkApprove,cellcheck:cellCheck,cellscheck:cellsCheck,referrowscheck:referRowsCheck,lineopen:lineOpenOrClose,lineclose:lineOpenOrClose,localoutput:localoutput,output:output,print:print,selecttpl:selectTpl,saveandadd:saveAndAdd,saveandaudit:saveAndAudit,savebo:savebo,preview:preview,localprint:localPrint,selfdefineaction:compositeAction,savedraft:saveDraft,savedatatemp:saveDatatemp,ecsuite:ecsuite,voucherdo:voucherDo,batchmodify:batchModify,jointquery:jointquery,printpreview:printPreview,printdesign:printDesign,printnow:printNow,batchoutput:batchOutputVoucher,batchimport:importVoucher,tempexport:exportVoucherTemplate,openpage:doCommunication,goback:doCommunication,attachment:attachment,voucherattachment:voucherAttachment,rowdetail:rowDetail,staterule:stateRule,billsetting:_common__WEBPACK_IMPORTED_MODULE_0__.A,formularule:formulaRule,autocomplete:_common__WEBPACK_IMPORTED_MODULE_0__.b,customdo:_common__WEBPACK_IMPORTED_MODULE_0__.m};return Object.assign(t,e)}}}();cb.namespace("biz.common"),cb.biz.common.yyarchive=yyarchive,__webpack_exports__.default=yyarchive}}]);
//# sourceMappingURL=2.bundle.js.map?_=d566ad53-de75-49ba-965f-44adb4dd2a09