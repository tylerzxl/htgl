(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{2436:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _common__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(191),_helpers_env__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(123),uuid_v1__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(557),uuid_v1__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(uuid_v1__WEBPACK_IMPORTED_MODULE_2__),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(429),__assign=function(){return(__assign=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var _ in t=arguments[a])Object.prototype.hasOwnProperty.call(t,_)&&(e[_]=t[_]);return e}).apply(this,arguments)},themeType="ncc",editvoucherlist=function(){var _this=this,_render=function(e,t,a){_common__WEBPACK_IMPORTED_MODULE_0__.H(e),_common__WEBPACK_IMPORTED_MODULE_0__.I(e),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.d(e),a?(e.setDirty(!0),e.loadDirtyData(t)):(e.loadData(t),t&&(e.execute("afterLoadData",t),e.validate(!0)))},_getTreeSelectNode=function(e){var t,a,r=e.getTreeModel();return r&&(t=r.getSelectedNodes()),t&&t.length&&t[0]&&(a=t[0]),a},singleDo=function(e,t,a,r,_){var o=a&&a.params&&a.params.index;if(null!=o){var n=t.getGridModel();if(n){var i=n.getRow(o);if(i){var c={billnum:e,data:JSON.stringify(i)};r({params:a,data:c},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,a){e||(cb.utils.alert("操作成功","success"),t.execute("refresh")),_({err:e,res:a},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),c)}))}}}},_doService=function(e,t,a,r,_){t.getCache("lastMode")?_getTreeSelectNode(t)?_common__WEBPACK_IMPORTED_MODULE_0__.q(e,t,a,r,_,(function(e,t,a){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(t,a){if(!t){cb.utils.alert("操作成功","success");var r=e.collectData(!0),o=_common__WEBPACK_IMPORTED_MODULE_0__.e(r,a);_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT),_render(e,o),e.getTreeModel().updateNode(o)}_({err:t,res:a},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),t)})):cb.utils.alert("请选择有效数据","warning"):singleDo(e,t,a,r,_)},open=function(e,t,a,r,_){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"open"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}cb.extendConfig.allConfirm&&a.cShowCaption?cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026042",{cShowCaption:a.cShowCaption}),(function(){_doService(e,t,a,r,_)})):_doService(e,t,a,r,_)},close=function(e,t,a,r,_){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"close"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}cb.extendConfig.allConfirm&&a.cShowCaption?cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026042",{cShowCaption:a.cShowCaption}),(function(){_doService(e,t,a,r,_)})):_doService(e,t,a,r,_)},_addCard=function(e,t,a,r,_){var o=t.getTreeModel().getState("maxLevel"),n=!1===o?65536:o||3,i=_getTreeSelectNode(t);if(i&&i.level>n)cb.utils.alert(cb.locale("P_YS_FED_FW_0001026057",{level:n+1}),"error");else{var c={billnum:e};r({params:a,data:c},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.s(c,a,(function(e,a){if(a){_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD);var r=t.getTreeModel(),o=r.getState("parentField");null==a[o]&&i&&(a[o]=i[r.getState("keyField")],a.parent_name=i.name),_render(t,a,!0)}_({err:e,res:a},_common__WEBPACK_IMPORTED_MODULE_0__.a)}))}))}},_addVoucher=function(e,t,a,r,_){if("touch"===cb.rest.interMode){var o=t.getGridModel();o&&o.clearCache("backData")}var n=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey");if(n){var i,c=_getTreeSelectNode(t);c&&(i=c[t.getTreeModel().getState("keyField")]);var l={params:a,mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,action:"add",carryParams:{},parentId:i,parent:c};r({params:l},(function(e){e&&(l.carryParams.externalData=e),cb.loader.runCommandLine("bill",{billtype:"voucher",billno:n,params:l},t),_()}))}else cb.utils.alert("元数据未配置cCardKey","warning")},_loadGrid=function(e,t,a){var r=e.getCache("queryItems")||[];if(cb.extendConfig.editvoucherlist||(cb.extendConfig.editvoucherlist={}),r.length){var _=!1;if(r.forEach((function(t){var a=t.replace(/(\w)/,(function(e){return e.toUpperCase()}));e.getCache("exec"+a)||(_=!0)})),_)return void(a&&a())}"Report"===_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"billType")&&e.execute("firstQueryDone",!0);var o=e.getParams().query.reportId,n=e.getGridModel();if(o&&!t.reportId&&n.setColumns(n.getState("columns")),Object.assign(t,e.getParams().query),n){if(n.setState("showSearch",t.showSearch),delete t.showSearch,1==e.getCache("bDisplayNavTree")&&!t.bFromNav)return;if(!n.execute("beforeLoad",t))return!0;var i=e.allActions&&e.allActions.find((function(e){return e.cCommand&&"cmdlist"===e.cCommand.trim().toLocaleLowerCase()})),c=i&&i.cSvcUrl?{url:i.cSvcUrl,method:i.cHttpMethod||"POST",options:{mask:!0}}:{url:"bill/list",method:"POST",options:{mask:!0}};cb.extendConfig.editvoucherlist.pageSize&&n.setPageInfo({pageSize:cb.extendConfig.editvoucherlist.pageSize}),n.setDataSource(c,t,(function(e){var t=n._get_data("delayLoadPageInfo")||e.recordCount>cb.extendConfig.editvoucherlist.pageSize;n.setPagination(t);var a=getColumnsData(e);a&&this.setColumns(a.columns,a.fieldNames)})),n.setCache("afterAct",a),e.getCache("cardViewModel")&&n.execute("dblClick",{})}},getColumnsData=function(e){if(e.viewmodel){for(var t={},a=[],r=e.viewmodel.entities.filter((function(e){return e.bMain&&"Bill"===e.cType}))[0].fields,_=0;_<r.length;_++){var o=r[_];t[o.cItemName]=o,a.push(o.cItemName)}return{columns:t,fieldNames:a}}},switchGroupSchema=function(e,t,a,r,_){var o=a?a.groupSchemaId:void 0,n=a?a.groupSchemaName:void 0,i=a?a.dimensionId||9999:void 0;t.execute("refreshEChartConfig",{billnum:e,groupSchemaId:o,groupSchemaName:n,dimensionId:i}),t.setCache("execSchema",!0),t.setCache("groupSchemaId",o),t.getGridModel().setState("showColumnSetting",!o);var c=Object.assign({billnum:e,groupSchemaId:o,isIncludeMeta:!0},t.getCache("lastSearchCondition"));Object.assign(c,t.getParams().query),_loadGrid(t,c,_)},_bindUpdateCondition=function(e,t){e.on("updateCondition",(function(a){_loadGrid(e,{billnum:t,condition:a})}))},_bindGridDblClick=function(e,t){var a=e.getGridModel();a&&(a.on("dblClick",(function(t,r){var _=this.getParent(),o={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,readOnly:!e.getParams().doubleEdit,id:t.id,rowData:t,cellInfo:r,carryParams:{},cardViewModel:_.getCache("cardViewModel")};if(!a.execute("beforeDblClick",o))return!0;var n=_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"cardKey");if(n){var i={billtype:"voucher",billno:n,params:o};cb.loader.runCommandLine("bill",i,_)}})),a.on("afterSetDataSource",(function(){a.setDirty(!1);var t=a.getCache("afterAct");t&&t(),_common__WEBPACK_IMPORTED_MODULE_0__.F(a,e),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.a(a,e)})))},_bindFilterControl=function(e,t){var a=e.getCache("FilterViewModel");a&&e.on("modeChange",(function(e){for(var t=a._get_data("propertyNames"),r=0;r<t.length;r++){var _=t[r],o=a.get(_);if(o instanceof cb.models.FilterModel){var n=o.getFromModel&&o.getFromModel(),i=o.getToModel&&o.getToModel();n&&n.setState("disabled",e!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),i&&i.setState("disabled",e!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE)}}}))},_loadTree=function(e,t,a){var r=e.allActions&&e.allActions.find((function(e){return e.cCommand&&"cmdquerytree"===e.cCommand.trim().toLocaleLowerCase()})),_=r&&r.cSvcUrl?{url:r.cSvcUrl,method:r.cHttpMethod||"POST"}:{url:"bill/querytree",method:"POST"},o=e.getTreeModel();o&&o.promiseExecute("beforeLoad",t,(function(){o.setDataSource(_,t),a&&o.setCache("afterAct",a)}))},_renderTreeArchiveData=function(e,t,a){if(t.getParams().hasChildren){var r={billnum:e,id:a[t.getTreeModel().getState("keyField")]},_=t.allActions&&t.allActions.find((function(e){return e.cCommand&&"cmddetail"===e.cCommand.trim().toLocaleLowerCase()})),o=_&&_.cSvcUrl?{cSvcUrl:_.cSvcUrl,cHttpMethod:_.cHttpMethod||"GET"}:{cSvcUrl:"bill/detail",cHttpMethod:"GET"};_common__WEBPACK_IMPORTED_MODULE_0__.p(o,(function(e,a){e||_render(t,a)}),r)}else _render(t,a)},_bindTreeSelect=function(e,t){var a=e.getTreeModel();if(a){var r=e.getGridModel(),_=e.getParams().billType;a.on("select",(function(a){e.promiseExecute("beforeTreeSelect",a,(function(){if(r||"TreeList"===_){if(!r)return;e.setCache("execTree",!0);var o={billnum:t};if(a.length){var n=a[0],i=n.path,c=n.id;i?o.path=i:c&&(o.ids=c.toString())}Object.assign(o,e.getCache("lastSearchCondition")),_loadGrid(e,o)}else a.length?(_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT),_renderTreeArchiveData(t,e,a[0]),e.setCache("lastMode",_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT)):(_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),e.biz.do("add",e),e.setCache("lastMode",_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD))}))})),a.on("afterSetDataSource",(function(){if(r){var e=r.getCache("afterAct");e&&e()}else{var t=a.getCache("afterAct");t&&t()}}))}},_bindTreeDblClick=function(e,t){var a=e.getTreeModel();a&&(a.on("cellJointQuery",(function(e){var t=e.rowData;a.execute("dblClick",t)})),a.on("dblClick",(function(e){var t=this.getParent(),r={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,readOnly:!0,id:e.id,cardViewModel:t.getCache("cardViewModel")};if(!a.execute("beforeDblClick",r))return!0;var _={billtype:"voucher",billno:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey"),params:r};cb.loader.runCommandLine("bill",_,t)})))},_bindCompareTreeSelect=function(e,t){var a=e.getTreeModel();a&&a.on("select",(function(a){if(e.getGridModel()&&a.length){var r=_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"foreignKey");if(r){var _=r.split(".");_&&_.length>1&&(r=_[1])}var o={billnum:t,path:a[0][r],operator:"eq"};_loadGrid(e,o)}var n=a[0];_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT),_render(e,n)}))},_treeDetailSelect=function(e,t,a){var r=e.getTreeModel();r&&r.on("afterSetDataSource",(function(e){r.select(a)}))},_setQueryItems=function(e,t){var a=e.getCache("queryItems")||[];-1===a.indexOf(t)&&a.push(t),e.setCache("queryItems",a)},_initPage=function(e,t){var a=_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"billType"),r=_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"filterId"),o=_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"condition"),n=_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"autoLoad"),i=_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"detailId");switch(a){case"Report":_.get(e.getParams(),"query.viewid");!o&&r||_loadGrid(e,{billnum:t,condition:o}),_bindGridDblClick(e,t);break;case"VoucherList":case"ArchiveList":case"EditVoucherList":r||!1===n||_loadGrid(e,{billnum:t,condition:o}),r||_bindUpdateCondition(e,t),_bindGridDblClick(e,t),_bindFilterControl(e,t);break;case"EditTreeVoucherList":case"TreeList":var c=e.getTreeModel();c&&c.getState("defaultSelectedKeys")&&_setQueryItems(e,"tree"),_loadTree(e,{billnum:t,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"treeName")}),_bindTreeSelect(e,t),_bindTreeDblClick(e,t),_bindGridDblClick(e,t);break;case"TreeArchive":_loadTree(e,{billnum:t,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"treeName")}),_bindTreeSelect(e,t),e.biz.do("add",e),e.setCache("lastMode",_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD);break;case"Compare":_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),_loadTree(e,{billnum:t,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(e,"treeName"),isDistinct:!0}),_bindCompareTreeSelect(e,t),_bindGridDblClick(e,t),_render(e)}i&&_treeDetailSelect(e,t,i)},buildRule=function(billNo,viewmodel,para,beforeAct,afterAct){var postData={billNumber:billNo,language:"javascript"},beforeActData={params:para,data:postData};beforeAct(beforeActData,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p({cSvcUrl:"/itemrule/script",cHttpMethod:"GET"},(function(_err,data){data=eval(data)||{},data&&(data.rules||[]).forEach((function(e){var t={};for(var a in e.triggers.forEach((function(a){var r=a.ds;if(r)t[r]||(t[r]=[]),t[r].push(a.item);else{if(!viewmodel.get(a.item))return;viewmodel.get(a.item).on("afterValueChange",(function(){this.run(this.param)}),{run:data.run,param:{ruleid:e.id,vm:viewmodel,trigger:{ds:r,item:a.item,lineid:"0"}}})}})),t)if(viewmodel.get(a)){viewmodel.get(a).setCache("ruleItems",t[a]);var r=function(e){-1!==this.items.indexOf(e.cellName)&&(this.param.trigger.item=e.cellName,this.param.trigger.lineid="0:"+e.rowIndex,this.run(this.param))},_={items:t[a],run:data.run,param:{ruleid:e.id,vm:viewmodel,trigger:{ds:a}}};viewmodel.get(a).on("afterCellValueChange",r,_),viewmodel.get(a).on("innerCellValueChange",r,_),viewmodel.get(a).on("afterDeleteRows",(function(){var e=this.childrenField;this.items.forEach((function(t){viewmodel.get(e).execute("innerCellValueChange",{rowIndex:-1,cellName:t})}))}),{items:t[a],childrenField:a}),viewmodel.get(a).on("afterInsertRow",(function(){var e=this.childrenField;this.items.forEach((function(t){viewmodel.get(e).execute("innerCellValueChange",{rowIndex:-1,cellName:t})}))}),{items:t[a],childrenField:a})}}));var jointFields={};for(var attr in(data.jointFields||[]).forEach((function(e){var t=e.ds;if(t)jointFields[t]||(jointFields[t]=[]),jointFields[t].push(e.item);else{if(!viewmodel.get(e.item))return;viewmodel.get(e.item).on("jointQuery",(function(){var e=null;try{e=JSON.parse(this.param.vm.get(this.param.trigger.item).getState("cStyle"))}catch(t){e={}}var t=this.jointQuery(this.param),a=[];for(var r in t.paras)a.push(r+"="+t.paras[r]);if(e.menuCode="SJ0201",e.menuCode)viewmodel.communication({type:"menu",payload:{menuCode:e.menuCode,menuUrl:"?"+a.join(",")}});else{var _=this.param.vm,o={billtype:"voucher",billno:t.target,params:cb.utils.extend(!0,t.paras,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT})};cb.loader.runCommandLine("bill",o,_)}}),{jointQuery:data.jointQuery,param:{vm:viewmodel,trigger:{ds:e.ds,item:e.item}}})}})),jointFields)viewmodel.get(attr)&&viewmodel.get(attr).on("cellJointQuery",(function(e){if(-1!==this.items.indexOf(e.cellName)){this.param.trigger.item=e.cellName,this.param.trigger.lineid="0:"+e.rowIndex;var t=this.jointQuery(this.param),a=this.param.vm,r={billtype:"voucher",billno:t.target,params:cb.utils.extend(!0,t.paras,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT})};cb.loader.runCommandLine("bill",r,a)}}),{items:jointFields[attr],jointQuery:data.jointQuery,param:{vm:viewmodel,trigger:{ds:attr}}});var refFields={};for(var attr in(data.refFields||[]).forEach((function(e){var t=e.ds;if(t)refFields[t]||(refFields[t]=[]),refFields[t].push(e.item);else{var a=viewmodel.get(e.item);if(!a)return;a.on("beforeBrowse",(function(){var e=this.jointQuery(this.param);e&&_setReferRule(e,this.referModel)}),{referModel:a,jointQuery:data.jointQuery,param:{action:"ref",vm:viewmodel,trigger:{ds:e.ds,item:e.item}}})}})),refFields){var referModel=viewmodel.get(attr);referModel&&referModel.on("beforeBrowse",(function(e){if(-1!==this.items.indexOf(e.cellName)){this.param.trigger.item=e.cellName,this.param.trigger.lineid="0:"+e.rowIndex;var t=this.jointQuery(this.param);t&&_setReferRule(t,e.context)}}),{referModel:referModel,items:refFields[attr],jointQuery:data.jointQuery,param:{action:"ref",vm:viewmodel,trigger:{ds:attr}}})}afterAct()}),postData)}))},_setReferRule=function(e,t){var a=e.target;a&&(a.cRefType&&t.setRefCode(a.cRefType),a.cRefRetId&&t.setReturnFields(a.cRefRetId.refid)),t.setFilter({isExtend:!0,simpleVOs:e.paras})},_getSelectRowIds=function(e,t,a){if(void 0===a&&(a=!0),e){var r=t&&t.params&&null!=t.params.index?[e.getRow(t.params.index)]:e.getSelectedRows(),_=[];return r&&r.length>0&&r.map((function(e){e.id&&_.push(e.id)})),a?Array.from(new Set(_)):_}},check4List=function(e,t,a,r,_){if("treevoucher"===t.getParams().metaType){var o=_getTreeSelectNode(t);if(o){var n=t.getTreeModel();a[n.getState("parentField")]=o[n.getState("keyField")]}}r({params:a},(function(){var o="ncc"===cb.extendConfig.theme;_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,a,r,_,!1,o)}))},referRowsCheck=function(e,t,a,r,_){var o=a.childrenField,n=a.columnName,i=a.index,c=a.rows,l=t.get(o).getColumn(n);if(l.bBatchCheck){var s={location:i,key:n,childrenField:o,value:JSON.stringify(c),type:l.cControlType,fieldname:l.cFieldName,mergeAll:!0};_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,s,r,_,!0)}},cellCheck=function(e,t,a,r,_){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),n=a.cellName,i=o.getColumn(n);if(i.bCheck){var c={location:a.rowIndex,key:n,childrenField:a.childrenField,value:JSON.stringify(a.value),oldValue:a.oldValue,type:i.cControlType,fieldname:i.cFieldName,async:a.async,callback:a.callback,context:a.context},l=o.getCache("ruleItems");l&&l.indexOf(n)>-1&&(c.async=!1),_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,c,r,_,!0)}},cellsCheck=function(e,t,a,r,_){var o=[];a.forEach((function(e){t.get(e.childrenField).getColumn(e.cellName).bCheck&&o.push({location:e.rowIndex,key:e.cellName,childrenField:e.childrenField,value:JSON.stringify(e.value),type:e.cControlType,fieldname:e.cFieldName})})),_common__WEBPACK_IMPORTED_MODULE_0__.c(e,t,o)},abandon=function(e,t,a,r,_){var o={res:t.getOriginalData()};r({params:a},(function(){cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026058",{abandonText:a.cShowCaption}),(function(){var e=t.getGridModel();e&&e.doPropertyChange("clearnColError"),function(e){var t=e.getOriginalData();for(var a in t){var r=t[a],_=e.get(a),o=e._get_data("dataSourceMode");_._set_data("dataSourceMode","local"),_.setData?_.setData(r):_.setDataSource(r),_._set_data("dataSourceMode",o)}for(var n in e.setReadOnly(!0),_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),_common__WEBPACK_IMPORTED_MODULE_0__.I(e),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.d(e),t){r=t[n];(_=e.get(n)).execute("afterSetDataSource",r),_.unselectAll()}var i=e.getGridModel(),c=i.get("pageInfo");if(i.get("pagination")&&c){var l=c&&c.recordCount?c.recordCount:0,s=c&&c.pageIndex?c.pageIndex:1,d=c&&c.pageSize?c.pageSize:50;i.setState("pagination",{total:l,current:s,pageSize:d})}}(t);var a=t.getCache("confirmAbandonFun");a instanceof Function&&a()}),(function(){_(o,_common__WEBPACK_IMPORTED_MODULE_0__.a)}))}))},_hasList=function(e){return e.indexOf("ist")>-1||"compare"==e.toLowerCase()},add=function(e,t,a,r,_){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"add"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}var n=t.getParams()&&t.getParams().billType;n?_hasList(n)?_addVoucher(e,t,a,r,_):_addCard(e,t,a,r,_):console.error("未获得billType")},addRow=function(e,t,a,r,_){r({params:a},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.w(t)!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT&&_common__WEBPACK_IMPORTED_MODULE_0__.r(e,t,a,r,_);var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).appendRow();_(o)}))},deleteRow=function(e,t,a,r,_){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();!o||o.length<1?cb.utils.alert("请选择","warning"):r({params:a,data:o},(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).deleteRows(o);_(e)}))},save=function(e,t,a,r,_){var o=t.validate();if(o)cb.utils.alert("以下数据项校验失败："+o.join(","),"error");else{var n=t.collectData();if(n){var i=_common__WEBPACK_IMPORTED_MODULE_0__.w(t);if(i!=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD)n._status=cb.models.DataStates.Update;else{n._status=cb.models.DataStates.Insert;var c=t.getTreeModel(),l=n[c.getState("parentField")];if(l){if(c){var s=c.getNodesByKeys(l);s&&s.length&&(n.level=s[0].level+1)}}else n.level=1}var d={billnum:e,data:JSON.stringify(n)};r({params:a,data:d},(function(){a.options={mask:!0},_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(a,r){if(!a){var o,n=t.collectData(!0),c=[];for(var l in r)Array.isArray(r[l])&&t.get(l)&&t.get(l).getDirtyRowIndexes&&t.get(l).getDirtyRowIndexes()&&t.get(l).getDirtyRowIndexes().length>0&&(c.push(l),o={});c.forEach((function(e){o[e]=t.get(e).getDirtyRowIndexes()}));var s=_common__WEBPACK_IMPORTED_MODULE_0__.e(n,r,o);_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT),_render(t,s),t.execute("updateTreeRefer");var d=t.getTreeModel();t.getParams().saveRefresh?_loadTree(t,{billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")},(function(){var e=s[d.getState("keyField")];e&&d.select(e.toString())})):i!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD?d.updateNode(s):d.addNode(s,!0),cb.utils.alert("保存成功","success")}_({err:a,res:r},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),d)}))}}},batchDelete=function(e,t,a,r,_){_common__WEBPACK_IMPORTED_MODULE_0__.w(t)==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT?deleteRow(e,t,a,r,_):"ncc"==themeType?batchDo(e,t,a,r,_):batchDo(e,t,a,r,_,!0)},batchDo=function(e,t,a,r,_,o){var n;"btnDelete"!==a.cItemName&&"btnDeleteRow"!==a.cItemName&&null==o&&(o=!!cb.extendConfig.allConfirm);try{n=JSON.parse(a.cmdParameter).primarykey}catch(e){console.error("batchDo action parameter error: "+e.message)}n||(n="id");var i,c=t.getGridModel(),l=t.getTreeModel();if(c?(i=a&&a.params&&null!=a.params.index?[c.getRow(a.params.index)]:c.getSelectedRows(),c._set_data("focusedRowIndex",-1,!0)):l&&(i=l.getSelectedNodes()),i&&0!=i.length){var s;s=c?c.getNecessaryDataForRows(i):l.getNecessaryDataForRows(i);var d=[],u=[];i.forEach((function(e,t){e.id&&e.pubts&&Object.assign(s[t],{code:e.code,id:e.id,pubts:e.pubts}),-1===u.indexOf(e[n])&&(d.push(s[t]),u.push(e[n]))}),_this);var m={billnum:e,data:JSON.stringify(d)},E={params:a,data:m};a.ids=s,r(E,(function(){if(o){var e=t.getParams().caption;cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026054",{cCaption:a.cCaption,text:e}),(function(){_batchDo(t,a,_,d,m)}),(function(){a&&a.enabledCallback&&a.enabledCallback()}))}else _batchDo(t,a,_,d,m)}))}else cb.utils.alert("请选择","warning")},batchsubmit=function(e,t,a,r,_,o){var n=t.validate();if(n){var i=n&&n.join(",");i&&cb.utils.alert("以下数据项校验失败："+i,"error")}else{var c=t.getGridModel(),l=c.getDirtyData();if(l&&l.length>0){r({params:a,data:l},(function(){var r={billnum:e,data:JSON.stringify(l)};_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,r){if(e||!r){var o=e&&e.message?e.message:"后台数据返回错误";return cb.utils.alert(o,"error"),void _()}if(cb.utils.isArray(r))cb.utils.alert("操作成功","success");else{var n=a.cShowCaption;1===l.length?r.failCount?cb.utils.alert(cb.locale("P_YS_FED_FW_0001026088",{actionText:n,messages:r.messages[0]}),"error"):cb.utils.alert(cb.locale("P_YS_FED_FW_0001026089",{actionText:n}),"success"):"ncc"!=themeType||t.getCache("showBatchMsg")?t.communication({type:"modal",payload:{key:"BatchMsg",data:{type:2,res:r}}}):r.failCount>0?cb.utils.alert(cb.locale("P_YS_FED_FW_0001026087",__assign({actionText:n},r)),"error"):cb.utils.alert(cb.locale("P_YS_FED_FW_0001026086",__assign({actionText:n},r)),"success")}var i={err:e,res:r};if(t.getCache("batchSubmitErrorIntercept")&&r.failCount)_(i,_common__WEBPACK_IMPORTED_MODULE_0__.a);else{var s=c.getAllData(!0),d=c.getDirtyRowIndexes(),u=[];u=cb.utils.isArray(r)?r:r.infos||[];var m=_common__WEBPACK_IMPORTED_MODULE_0__.e({gridList:s},{gridList:u},{gridList:d});c.clear(!1),c._set_data("dataSourceMode","local"),c.setData(m.gridList),c._set_data("dataSourceMode","remote"),c.setDirty(!1);var E=c._get_data("rowsDataState").map((function(e){return cb.models.DataStates.Unchanged}));c._set_data("rowsDataState",E),_(i,_common__WEBPACK_IMPORTED_MODULE_0__.a),t.setReadOnly(!0),_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),_common__WEBPACK_IMPORTED_MODULE_0__.I(t),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.d(t),c.execute("afterSetDataSource",m),c.unselectAll()}}),r)}))}else{cb.utils.alert("操作成功","success"),t.setReadOnly(!0),_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),_common__WEBPACK_IMPORTED_MODULE_0__.I(t),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.d(t);var s=c._get_data("dataSource");c.execute("afterSetDataSource",s),c.unselectAll(),_()}}},_batchDo=function(e,t,a,r,_){_common__WEBPACK_IMPORTED_MODULE_0__.p(t,(function(_,o){if(!_){var n=t.cShowCaption;if(1===r.length?o.failCount?cb.utils.alert(cb.locale("P_YS_FED_FW_0001026088",{actionText:n,messages:o.messages[0]}),"error"):(cb.utils.alert(cb.locale("P_YS_FED_FW_0001026089",{actionText:n}),"success"),e.getGridModel().unselectAll()):"ncc"!=themeType||e.getCache("showBatchMsg")?e.communication({type:"modal",payload:{key:"BatchMsg",data:{type:2,res:o}}}):o.failCount>0?cb.utils.alert(cb.locale("P_YS_FED_FW_0001026087",__assign({actionText:n},o)),"error"):cb.utils.alert(cb.locale("P_YS_FED_FW_0001026086",__assign({actionText:n},o)),"success"),e.getCache("lastSearchCondition"))e.execute("back");else{var i=t.cAction,c=t.ids,l=e.getGridModel();if("batchdelete"==i){var s=l._get_data("dataSource");c.forEach((function(e){var t=s.findIndex((function(t){return t.id==e.id}));s.splice(t,1)})),l._set_data("dataSourceMode","local"),l.setDataSource(s),l._set_data("dataSourceMode","remote")}}}a({err:_,res:o},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),_)},dblClick=function(e,t,a,r,_){var o,n,i=t.getGridModel();if(i){var c=a&&a.params&&a.params.index,l=null!=c?[i.getRow(a.params.index)]:i.getSelectedRows();if(!l||1!==l.length)return void cb.utils.alert("请选择一条数据","warning");o=l[0].id,n=l[0],i.setCache("backData",{rowIndex:c,id:o})}else{var s=_getTreeSelectNode(t);if(!s)return void cb.utils.alert("请选择一条数据","warning");o=s.id,n=s}var d={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,copy:a.copy,id:o,rowData:n,carryParams:{}};r({params:a,carry:d},(function(){var e={billtype:"voucher",billno:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey"),params:d};cb.loader.runCommandLine("bill",e,t),_()}))},refresh=function(e,t,a,r,_){var o=t.getCache("lastSearchCondition"),n=t.getTreeModel();if(t.getGridModel()){var i=Object.assign({billnum:e},a),c=t.getCache("isSum");null!=c&&(i.isSum=c),Object.assign(i,t.getParams().query);var l=t.getCache("groupSchemaId");if(l&&(i.groupSchemaId=l),n){var s=_getTreeSelectNode(t);if(s){var d=s.path,u=s.id;d?i.path=d:u&&(i.ids=u.toString())}}var m=cb.utils.extend(!0,i,o);r?r({params:o,data:m},(function(){_loadGrid(t,m,_)})):_loadGrid(t,m,_)}else queryTree(e,t)},search=function(e,t,a,r,_){t.setCache("execFilter",!0),t.setCache("lastSearchCondition",a),r({params:a,data:a},(function(){refresh(e,t,a,r,_)}))},queryTree=function(e,t,a,r,_){var o={billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")};a&&a instanceof Object&&(o=Object.assign(o,a)),r?r({params:a,data:o},(function(){_loadTree(t,o,_)})):_loadTree(t,o,_)},editTree=function(e,t,a,r,_){var o=t.getTreeModel();if(o&&a)if(a.cTarget){var n=_getTreeSelectNode(t);if(n){var i={};i.detailId=n[o.getState("keyField")];var c=cb.utils.extend(!0,i,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT});r({params:a,data:c},(function(){var e={billtype:"voucherlist",billno:a.cTarget,params:c};cb.loader.runCommandLine("bill",e,t),_()}))}}else console.log("未配置tree 的billnumber ,在commend表的target中设置")},moveUp=function(e,t,a,r,_){var o=t.getTreeModel();if(o){var n=o.getSelectedNodes();if(n.length){var i=n[0];if(o.isFirst(i))cb.utils.alert("分类已是同级次的第一个","warning");else{var c=o.getState("keyField"),l={billnum:e,action:a.cAction,id:i[c]};r({params:a,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,r){e||(cb.utils.alert(cb.locale("P_YS_FED_FW_0001026085",{text:a.cShowCaption}),"success"),t.execute("back")),_({err:e,res:r},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),l)}))}}else cb.utils.alert("请选择一条数据","warning")}},moveDown=function(e,t,a,r,_){var o=t.getTreeModel();if(o){var n=o.getSelectedNodes();if(n.length){var i=n[0];if(o.isLast(i))cb.utils.alert("分类已是同级次的最后一个","warning");else{var c=o.getState("keyField"),l={billnum:e,action:a.cAction,id:i[c]};r({params:a,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,r){e||(cb.utils.alert(cb.locale("P_YS_FED_FW_0001026085",{text:a.cShowCaption}),"success"),t.execute("back")),_({err:e,res:r},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),l)}))}}else cb.utils.alert("请选择一条数据","warning")}},singlePush=function(e,t,a,r,_){if(a){var o=a.params&&a.params.index;if(null!=o){var n=t.getGridModel();if(n){var i=n.getRow(o);i&&_common__WEBPACK_IMPORTED_MODULE_0__.D(t,a,i,r,_)}}}},batchPush=function(e,t,a,r,_){var o=t.getGridModel(),n=_getSelectRowIds(o);n&&0!=n.length?_common__WEBPACK_IMPORTED_MODULE_0__.D(t,a,n,r,_):cb.utils.alert("请选择有效数据","warning")},copy=function(e,t,a,r,_){if(a){var o=a.params&&a.params.index;if(null!=o){var n=t.getGridModel();if(n){var i=n.getRow(o);i&&_common__WEBPACK_IMPORTED_MODULE_0__.k(t,a,i.id,r,_)}}}},push=function(e,t,a,r,_){var o=new cb.utils.queryString(a.cSvcUrl),n=o.get("code"),i=t.getGridModel(),c=_getSelectRowIds(i);if(c&&0!=c.length){if(n){var l={code:n,isMainSelect:1,childIds:c},s={cSvcUrl:o.pathname+o.toStr(),cHttpMethod:a.cHttpMethod};r({params:a,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(s,(function(e,t){_({err:e,res:t},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),l)}))}}else cb.utils.alert("请选择有效数据","warning")},output=function(e,t,a,r,_){var o=t.getGridModel(),n="";window._baseUrl&&(n="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var i=n+"/files"+a.cSvcUrl,c=new cb.utils.queryString(i),l={format:c.has("type")?c.get("type"):"pdf",type:"voucherlist",bill:{page:{pageSize:o.getPageSize(),pageIndex:o.getPageIndex()},billnum:e}},s=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.HTTP_OUTPUT_BILL;r({params:a,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.l(s,l),_()}))},importVoucher=function(e,t,a,r,_){var o={disabledCallback:a.disabledCallback,enabledCallback:a.enabledCallback};a.disabledCallback=!1,a.enabledCallback=!1;var n={params:a,data:{}},i=!1,c=1,l="asyncImport_"+cb.utils.getNewGuid().replace(/-/g,""),s="";if(a.cParameter){var d=JSON.parse(a.cParameter);d&&(i=d.isAsync,c=d.interval||c,s=d.acceptedFileType||"")}r(n,(function(){var r=document.createElement("input");r.type="file",s&&(r.accept=s),r.style.display="none",r.onchange=function(_){o.disabledCallback&&o.disabledCallback();var s=new FormData;s.enctype="multipart/form-data";var d=_.target.files[0],u=d&&d.name,m=d&&d.size;s.append("file",d),n.data.mapCondition&&s.append("mapCondition",JSON.stringify(n.data.mapCondition));var E=new XMLHttpRequest,f=a.cSvcUrl+"?billnum="+_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey");try{"bd_staff_card"===_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey")&&(f=a.cSvcUrl+"?billnum="+n.data.mapCondition.billnum)}catch(e){console.error(e)}var p=t.getState("serviceCode")||cb.rest.AppContext.query.serviceCode;p&&(f=f+"&serviceCode="+p),i&&(f=f+"&asyncKey="+l),E.open("POST",f,!0),E.send(s),i?(o.enabledCallback&&o.enabledCallback(),E.onreadystatechange=function(){var a=!1,r="";if(4===E.readyState){if(200===E.status){var _=void 0;try{_=JSON.parse(E.responseText)}catch(e){a=!0,r="模板内容导入失败,返回信息："+E.responseText}_&&200===_.code||(a=!0,r="模板内容导入失败，"+_.message+"。")}else a=!0,r="模板内容导入返回信息： xhr.readyState ="+E.readyState+"  xhr.status ="+E.status+"  xhr.responseText = "+E.responseText;if(a)cb.utils.alert(r);else queryAsyncProcess(e,t,{asyncKey:l,asyncInterval:c,btnCallBack:o,fileSize:m,fileName:u})}}):E.onreadystatechange=function(){if(4===E.readyState)if(o.enabledCallback&&o.enabledCallback(),200===E.status){var e=void 0;try{e=JSON.parse(E.responseText)}catch(e){return void cb.utils.alert(cb.locale("P_YS_FED_FW_0001026084",{text:E.responseText}))}if(e&&200===e.code){var a=e.data;a.sucessCount&&t.execute("refresh"),t.communication({type:"modal",payload:{key:"BatchMsg",data:{type:2,res:a}}})}else cb.utils.alert(cb.locale("P_YS_FED_FW_0001026083",{text:e.message}),"error")}else console.log("模板内容导入返回信息： xhr.readyState ="+E.readyState+"  xhr.status ="+E.status+"  xhr.responseText = "+E.responseText)},document.body.removeChild(r)},document.body.appendChild(r),r.click()}))},exportVoucherTemplate=function(e,t,a,r,_){var o="";window._baseUrl&&(o="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var n=o+"/files"+a.cSvcUrl,i=new cb.utils.queryString(n),c=i.pathname+i.toStr(),l={billnum:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey")};r({params:a,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.l(c,l),_()}))},exportStaticVoucherTemplate=function(e,t,a,r,_){var o=a&&a.cSvcUrl;o?r({params:a},(function(){window.open(o),_()})):cb.utils.alert("导出模板的地址为空","error")},exportReport=function(e,t,a,r,_){var o=t.getCache("isSum"),n=t.getGridModel();if(n&&!n.getRowsCount())return void cb.utils.alert("导出数据不允许为空，请重新选择后重试！","error");var i="";window._baseUrl&&(i="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var c=i+"/files"+a.cSvcUrl,l=new cb.utils.queryString(c),s=l.pathname+l.toStr(),d=Object.assign({billnum:e||_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey"),groupSchemaId:t.getCache("groupSchemaId")},t.getParams().query,t.getCache("lastSearchCondition"));delete d.showSearch,null!=o&&(d.isSum=o),r({params:a,data:d},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.l(s,d),_()}))},subscribeMessage=function(e,t,a,r,_){t.communication({type:"modal",payload:{key:"MessageSubscribe",data:{model:t}}})},batchOutputVoucher=function(e,t,a,r,_){var o=t.getGridModel(),n={billnum:e};if(o){var i=a&&a.params&&null!=a.params.index?[o.getRow(a.params.index)]:o.getSelectedRows();if(!i||0==i.length)return void cb.utils.alert("请选择","warning");var c=[];i.forEach((function(e){e.id&&e.pubts&&c.push(e.id)}),_this),n.ids=c.join()}var l="";window._baseUrl&&(l="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var s=l+"/files"+a.cSvcUrl,d=new cb.utils.queryString(s),u=d&&d.pathname+d.toStr();r({params:a,data:n},(function(){if(!n.fileName){var e=t.getParams().caption;e&&(n.fileName=e)}_common__WEBPACK_IMPORTED_MODULE_0__.l(u,n),_()}))},print=function(e,t,a,r,_){var o=t.getGridModel();if(o){var n={json:{bill:{page:{pageSize:o.getPageSize(),pageIndex:o.getPageIndex()},billnum:e},type:"voucherlist",token:!0}};r({params:a,data:n},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.o(n,a,(function(e,t){e?console.error(e):(window.open(t),_())}))}))}},preview=function(e,t,a,r,_){r({params:a},(function(){var r=t.get("templates").getValue();if(r){var _=window.open("about:blank"),o=cb.rest.DynamicProxy.create({preview:{url:"print/printPreview",method:"POST"}}),n=_getSelectRowIds(t.getGridModel()),i=t.getCache("lastSearchCondition")?JSON.stringify(t.getCache("lastSearchCondition").condition):null;o.preview({route:a.cSvcUrl||"/bill",billno:e,template:r,ids:n,condition:i},(function(e,t){e?cb.utils.alert(e.message,"error"):_.location.href=t}))}else cb.utils.alert("请选择打印模板","warning")}))},batchPrintVoucher=function(e,t,a,r,_){var o=t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY)&&t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY).getValue()&&t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY).getValue().toString(),n=t.getGridModel(),i=_getSelectRowIds(n);if(i&&0!=i.length){var c={json:{bill:{billnum:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey"),ids:i,tplid:o},type:"voucher"}};r({params:a,data:c},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.o(c,a,(function(e,t){e?console.error(e):(window.open(t),_())}))}))}else cb.utils.alert("请选择有效数据","warning")},savebo=function(e,t,a,r,_){cb.rest.DynamicProxy.create({saveBo:{url:"print/saveBo",method:"GET"}}).saveBo({billno:e},(function(e,t){e?cb.utils.alert(e.message,"error"):cb.utils.alert("保存业务对象成功","success")}))},doDelete=function(e,t,a,r,_){var o=_getTreeSelectNode(t);if(o)if(o&&o.children&&o.children.length>0)cb.utils.alert("有下级，不能删除","warning");else{var n=t.getNecessaryData(),i={billnum:e,data:JSON.stringify(n)};r({params:a,data:i},(function(){cb.utils.confirm("确定要删除么",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,a){if(!e){var r=t.getTreeModel();if(r){var o=r.getSelectedKeys();o&&1==o.length&&(r.deleteNode(o),_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),t.biz.do("add",t))}cb.utils.alert("操作成功","success")}_({err:e,res:a},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),i)}))}))}else cb.utils.alert("请选择有效数据","warning")},localPrint=function(e,t,a,r,_){if("Report"!==t.getParams().billType){var o=t.get("id")&&t.get("id").getValue(),n=t.get("code")&&t.get("code").getValue();if(cb.utils.isEmpty(o)&&cb.utils.isEmpty(n))cb.utils.alert("未找到具体单据","error");else{var i=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey");if(cb.utils.isEmpty(i))cb.utils.alert("元数据未配置cCardKey","error");else{var c=cb.rest.DynamicProxy.create({getTemplate:{url:"print/getTemplateByBo",method:"GET",options:{mask:!0}},print:{url:"bill/getTemplateStructure",method:"POST",options:{mask:!0}}});c.getTemplate({billno:i},(function(e,t){if(e)cb.utils.alert(e.message,"error");else{var a=1===t.length?t[0]:t.find((function(e){return e.isdefault}));if(cb.utils.isEmpty(a))cb.utils.alert("没有设置打印模板，请检查","error");else{var _={billno:i,templateCode:a.templatecode};n?_.code=n:_.ids=[o],c.print(_,(function(e,t){e?cb.utils.alert(e.message,"error"):r(t,(function(){cb.utils.localPrint(t)}))}))}}}))}}}else localPrintReport(e,t,a,r,_)},sumSwitch=function(e,t,a,r,_){t.setCache("isSum",t.get("sumSwitch").getValue()||null),refresh(e,t,null,r,_)},localPrintReport=function(e,t,a,r,_){var o=cb.rest.DynamicProxy.create({getTemplate:{url:"print/getTemplateByBo",method:"GET",options:{mask:!0}},print:{url:"report/getTemplateStructure",method:"POST",options:{mask:!0}}});o.getTemplate({billno:e},(function(a,_){if(a)cb.utils.alert(a.message,"error");else{var n=1===_.length?_[0]:_.find((function(e){return e.isdefault}));if(cb.utils.isEmpty(n))cb.utils.alert("没有设置打印模板，请检查","error");else{var i=t.getCache("lastSearchCondition"),c=i?JSON.stringify(i.condition):null,l={billno:e,templateCode:n.templatecode,condition:c,route:"/report/bill"};o.print(l,(function(e,t){e?cb.utils.alert(e.message,"error"):r(t,(function(){cb.utils.localPrint(t)}))}))}}}))},batchModify=function(e,t,a,r,_){t.communication({type:"modal",payload:{key:"batchModify",data:{billType:"list",billNo:e,model:t,params:a}}})},workflow=function(e,t,a,r,_){var o=t.getGridModel(),n=a&&a.params&&a.params.index;if(null!=n&&o){var i=o.getRow(n);if(i)if(i.isWfControlled&&0!==i.verifystate){var c=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey"),l=c+"_"+i.id;c||(l=e+"_"+i.id);var s={width:850,height:510,appsource:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.appCode,businessKey:l};r({params:a,data:s},(function(){window.flowComp(s).showFlowBox({onClose:function(a){(t.getCache("queryItems")||[]).forEach((function(e){var a=e.replace(/(\w)/,(function(e){return e.toUpperCase()}));t.setCache("exec"+a,!0)})),refresh(e,t)}})}))}else cb.utils.alert("暂无审批详情","warning")}},printPreview=function(e,t,a,r,_){r(a,(function(){var e=t.getGridModel();if(e){var r=_common__WEBPACK_IMPORTED_MODULE_0__.x(a,"preview",t),o=r.currentParams,n=r.url;e.getSelectedRows().length>500?cb.utils.confirm("数据量较大，预览可能比较慢，是否使用打印插件，是否直接静默打印",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.B(a,t)}),(function(){_morePrintPreview(o,n)})):_morePrintPreview(o,n),_()}}))},_morePrintPreview=function(e,t){var a=_common__WEBPACK_IMPORTED_MODULE_0__.i(e);if(a.length>2e3){var r=cb.rest.DynamicProxy.create({cacheData:{url:"/cachePrint",method:"post",options:{uniform:!1}}}),_=JSON.stringify(e.params);r.cacheData({param:_},(function(a,r){if(r){e.sendType=7,e.params=r.key;var _=_common__WEBPACK_IMPORTED_MODULE_0__.i(e);window.open(t+_,"_blank")}}))}else window.open(t+a,"_blank")},printDesign=function(e,t,a,r,_){r({params:a},(function(){if(t.getGridModel()){var e=_common__WEBPACK_IMPORTED_MODULE_0__.x(a,"design",t),r=e.currentParams,_=e.url;window.open(_+_common__WEBPACK_IMPORTED_MODULE_0__.i(r),"_blank")}}))},printNow=function(e,t,a,r,_){r(a,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.B(a,t),_()}))},doCommunication=function(e,t,a,r,_){_common__WEBPACK_IMPORTED_MODULE_0__.n(e,t,a,r,_)},attachment=function(e,t,a,r,_){var o=t.getGridModel(),n=a&&a.params&&null!=a.params.index?[o.getRow(a.params.index)]:o.getSelectedRows();if(0!=n.length)if(n.length>1)cb.utils.alert("附件管理只能单行显示","warning");else{var i=n[0],c=t.getCache("attachmentCondition"),l=Object.assign({id:i.attachmentId},c);r({params:a,data:l},(function(){t.communication({type:"modal",payload:{key:"Attachment",data:{size:"md",data:l,model:t}}}),_()}))}else cb.utils.alert("请选择行","warning")};return{init:function(e,t,a){var r=function(_,o){_common__WEBPACK_IMPORTED_MODULE_0__.z(_,o,e,t,(function(r,_){var o=t&&t.query&&Boolean(t.query.isSum);o&&r.setCache("isSum",o);var n=t&&t.reportId;n&&(t.query.reportId=n);var i={vm:r,view:_};r.promiseExecute("afterLoadMeta",i,(function(){var t=r.get("parent_name");if(t instanceof cb.models.ReferModel){var o=t.getState("maxLevel"),n=!1===o?65536:o||3;t.setState("maxLevel",n)}var i=r.getGridModel();i.on("afterInsertRow",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(i,r,r.getParams().mode),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.a(i,r,r.getParams().mode)})),r.get("addAttachment")&&(i.on("beforeSetDataSource",(function(e){return e.forEach((function(e){e.id?e.attachmentId||(e.attachmentId=e.id):e.attachmentId||(e.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()())})),e})),i.on("beforeInsertRow",(function(e){return e.row.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()(),e}))),a(r,_,_.cBillName),_initPage(r,e),r.biz.do("rule",r)}))}),(function(t){"Report"===t.getParams().billType&&(t.getParams().autoLoad=!1),t.initData(),_common__WEBPACK_IMPORTED_MODULE_0__.I(t),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.d(t),t.on("refresh",(function(){refresh(e,t)})),t.on("back",(function(a){var r=t.getGridModel();if(r)if("touch"===cb.rest.interMode||"3"==cb.rest.terminalType){var _=r.getCache("backData");if(!_)return void refresh(e,t);r.clearCache("backData");var o=t.allActions&&t.allActions.find((function(e){return e.cCommand&&"cmdlist"===e.cCommand.trim().toLocaleLowerCase()})),n=o&&o.cSvcUrl?{url:o.cSvcUrl,method:o.cHttpMethod||"POST",options:{mask:!0}}:{url:"bill/list",method:"POST",options:{mask:!0}},i=cb.rest.DynamicProxy.create({queryData:n}),c={billnum:e,page:{pageSize:r.getPageSize(),pageIndex:1},condition:{isExtend:!0,simpleVOs:[{field:"id",op:"eq",value1:_.id}]}};i.queryData(c,(function(e,a){a&&a.recordList&&a.recordList.length&&(r.updateRow(_.rowIndex,a.recordList[0]),_common__WEBPACK_IMPORTED_MODULE_0__.F(r,t),_staterule_rule__WEBPACK_IMPORTED_MODULE_3__.a(r,t))}))}else r.setPageIndex(r.getPageIndex());else queryTree(e,t,null,null,(function(){a&&t.getTreeModel().doPropertyChange("setExpandRow",{rowKey:a,isExpand:!0})}))}));var a=new cb.promise;t.on("return",(function(e){return _common__WEBPACK_IMPORTED_MODULE_0__.w(t)===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE||!t.getDirtyData(!1)||(cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026058",{abandonText:e}),(function(){a.resolve()}),(function(){a.reject()})),a)}))}),(function(){_common__WEBPACK_IMPORTED_MODULE_0__.t(e,t,r)}))};_common__WEBPACK_IMPORTED_MODULE_0__.t(e,t,r)},do:function(e,t,a){_common__WEBPACK_IMPORTED_MODULE_0__.K(this,e,t,a)},action:function(){var e={};try{e=cb.extendConfig.editVoucherListExtendConfig||{}}catch(t){console.log(t),e={}}var t={doservice:_doService,rule:buildRule,cellcheck:cellCheck,cellscheck:cellsCheck,referrowscheck:referRowsCheck,check:check4List,copy:copy,open:open,close:close,save:save,add:add,addrow:addRow,deleteRow:deleteRow,push:push,singlepush:singlePush,edit:_common__WEBPACK_IMPORTED_MODULE_0__.r,dblclick:dblClick,abandon:abandon,delete:doDelete,batchdelete:batchDelete,batchaudit:batchDo,batchunaudit:batchDo,batchsubmit:batchsubmit,batchdo:batchDo,search:search,refresh:refresh,output:output,batchoutput:batchOutputVoucher,batchimport:importVoucher,tempexport:exportVoucherTemplate,statictempexport:exportStaticVoucherTemplate,reportexport:exportReport,messagesubscribe:subscribeMessage,print:print,batchprint:batchPrintVoucher,columnsetting:_common__WEBPACK_IMPORTED_MODULE_0__.h,edittree:editTree,querytree:queryTree,moveup:moveUp,movedown:moveDown,commandLine:_common__WEBPACK_IMPORTED_MODULE_0__.j,switchgroupschema:switchGroupSchema,savebo:savebo,preview:preview,localprint:localPrint,batchpush:batchPush,sumswitch:sumSwitch,batchmodify:batchModify,printpreview:printPreview,printdesign:printDesign,printnow:printNow,workflow:workflow,openpage:doCommunication,goback:doCommunication,attachment:attachment,billsetting:_common__WEBPACK_IMPORTED_MODULE_0__.A};return Object.assign(t,e)}}}();cb.namespace("biz.common"),cb.biz.common.editvoucherlist=editvoucherlist,__webpack_exports__.default=editvoucherlist}}]);
//# sourceMappingURL=8.bundle.js.map?_=d566ad53-de75-49ba-965f-44adb4dd2a09