(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{2422:function(e,t,a){"use strict";a.d(t,"r",(function(){return c})),a.d(t,"t",(function(){return l})),a.d(t,"m",(function(){return s})),a.d(t,"j",(function(){return d})),a.d(t,"h",(function(){return u})),a.d(t,"d",(function(){return m})),a.d(t,"b",(function(){return f})),a.d(t,"g",(function(){return E})),a.d(t,"k",(function(){return p})),a.d(t,"f",(function(){return g})),a.d(t,"p",(function(){return v})),a.d(t,"u",(function(){return h})),a.d(t,"v",(function(){return C})),a.d(t,"n",(function(){return D})),a.d(t,"l",(function(){return b})),a.d(t,"w",(function(){return O})),a.d(t,"a",(function(){return P})),a.d(t,"q",(function(){return M})),a.d(t,"s",(function(){return T})),a.d(t,"i",(function(){return R})),a.d(t,"o",(function(){return y})),a.d(t,"c",(function(){return A})),a.d(t,"x",(function(){return I})),a.d(t,"e",(function(){return w}));var r=a(196),n=a.n(r),o=function(){return(o=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var n in t=arguments[a])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function i(e){var t={};return e&&(t=e.cParameter?JSON.parse(e.cParameter):e),t}function _(e){"upesn"!==n.a.platform?cb.utils.alert("当前平台： "+n.a.platform+" ，结果："+e):console.log("当前平台： "+n.a.platform+" ，结果："+e)}function c(e,t,a,r,i){var c={};if(null==a?void 0:a.cParameter){var l=JSON.parse(a.cParameter);c.needResult=l.needResult?parseInt(l.needResult):1,"all"===l.scanType?c.scanType=["qrCode","barCode"]:Array.isArray(c.scanType)||(c.scanType=[l.scanType])}n.a.scanQRCode(o(o({},c),{success:function(e){var t=e.resultStr;cb.invoker.publish("mtl",{action:"scan",result:t}),_(t)},fail:function(e){_(e.message)}}))}function l(e,t,a,r,c){var l=i(a);n.a.upesn.showShareMenu(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"share",result:e}),_(e)},fail:function(e){_(e.message)}}))}function s(e,t,a,r,o){var i=n.a.platform;cb.invoker.publish("mtl",{action:"platform",result:i}),_(n.a.platform)}function d(e,t,a,r,o){n.a.getNetworkType({success:function(e){var t=e.networkType;cb.invoker.publish("mtl",{action:"getNetworkType",networkType:t}),_(e)},fail:function(e){_(e.message)}})}function u(e,t,a,r,o){n.a.getMac({success:function(e){var t=e.macAddress;cb.invoker.publish("mtl",{action:"getMac",result:t}),_(e)},fail:function(e){_(e.message)}})}function m(e,t,a,r,c){var l=i(a);n.a.dail(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"dail",result:e}),_(e)},fail:function(e){_(e.message)}}))}function f(e,t,a,r,i){var c={};if(null==a?void 0:a.cParameter){var l=JSON.parse(a.cParameter);c.count=l.count,"all"===l.sourceType?c.sourceType=["album","camera"]:Array.isArray(c.sourceType)||(c.sourceType=[l.sourceType])}n.a.chooseImage(o(o({},c),{success:function(e){var t=e.localIds;cb.invoker.publish("mtl",{action:"chooseImage",result:t}),_(e)},fail:function(e){_(e.message)}}))}function E(e,t,a,r,c){var l=i(a);n.a.getLocation(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"getLocation",result:e}),_(e)},fail:function(e){_(e.message)}}))}function p(e,t,a,r,c){var l=i(a);n.a.openLocation(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"openLocation",result:e}),_(e)},fail:function(e){_(e.message)}}))}function g(e,t,a,r,c){var l=i(a);n.a.generateQRCode(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"generateQRCode",result:e}),_(e)},fail:function(e){_(e.message)}}))}function v(e,t,a,r,c){var l=i(a);if(l.headers&&"string"==typeof l.headers)try{l.headers=JSON.parse(l.headers)}catch(e){return void alert("headers 参数错误")}if(l.params&&"string"==typeof l.params)try{l.params=JSON.parse(l.params)}catch(e){return void alert("params 参数错误")}n.a.request(o(o({},l),{success:function(e){var t=e.data;cb.invoker.publish("mtl",{action:"request",result:t}),_(e)},fail:function(e){_(e.message)}}))}function h(e,t,a,r,o){n.a.startRecord({success:function(e){cb.invoker.publish("mtl",{action:"startRecord",result:e}),_(e)},fail:function(e){_(e.message)}})}function C(e,t,a,r,o){n.a.stopRecord({success:function(e){cb.invoker.publish("mtl",{action:"stopRecord",result:e}),_(e)},fail:function(e){_(e.message)}})}function D(e,t,a,r,c){var l=i(a);n.a.playVoice(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"playVoice",result:e}),_(e)},fail:function(e){_(e.message)}}))}function b(e,t,a,r,c){var l=i(a);n.a.pauseVoice(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"pauseVoice",result:e}),_(e)},fail:function(e){_(e.message)}}))}function O(e,t,a,r,c){var l=i(a);n.a.stopVoice(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"stopVoice",result:e}),_(e)},fail:function(e){_(e.message)}}))}function P(e,t,a,r,c){var l=i(a);n.a.changeScreenOrientation(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"changeScreenOrientation",result:e}),_(e)},fail:function(e){_(e.message)}}))}function M(e,t,a,r,o){n.a.restoreScreenOrientation({success:function(e){cb.invoker.publish("mtl",{action:"restoreScreenOrientation",result:e}),_(e)},fail:function(e){_(e.message)}})}function T(e,t,a,r,c){var l=i(a);n.a.setStorage(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"setStorage",result:e}),_(e)},fail:function(e){_(e.message)}}))}function R(e,t,a,r,c){var l=i(a);n.a.getStorage(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"getStorage",result:e}),_(e)},fail:function(e){_(e.message)}}))}function y(e,t,a,r,c){var l=i(a);n.a.removeStorage(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"removeStorage",result:e}),_(e)},fail:function(e){_(e.message)}}))}function A(e,t,a,r,c){var l=i(a);n.a.clearStorage(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"clearStorage",result:e}),_(e)},fail:function(e){_(e.message)}}))}function I(e,t,a,r,c){var l=i(a);n.a.uploadFile(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"uploadFile",result:e}),_(e)},fail:function(e){_(e.message)}}))}function w(e,t,a,r,c){var l=i(a);n.a.downloadFile(o(o({},l),{success:function(e){cb.invoker.publish("mtl",{action:"downloadFile",result:e}),_(e)},fail:function(e){_(e.message)}}))}},2423:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));var r=a(429);function n(e,t,a,n,o){var i=[];t.get("propertyNames").forEach((function(e){if(t.get(e)instanceof cb.models.BaseModel)if("GridModel"===t.get(e).modelType)t.get(e).get("fieldNames").forEach((function(a){var r=t.get(e).getEditRowModel().get(a);2===r.get("iSystem")&&i.push({type:0,actionGroups:[{actions:[{exprType:0,target:e+"."+r.get("cItemName"),scrExprType:0,srcExpression:r.get("formula")}]}]})}));else{var a=t.get(e);2===a.get("iSystem")&&i.push({type:0,actionGroups:[{actions:[{exprType:0,target:a.get("cItemName"),scrExprType:0,srcExpression:a.get("formula")}]}]})}})),t.setCache("formulaRules",i),Object(r.b)(t,i,"listener")}},2429:function(e,t,a){"use strict";a.r(t),a.d(t,"addproduct",(function(){return r})),a.d(t,"scan",(function(){return n}));var r=function(e,t,a,r,n){var o={billNum:e,billId:t.get("id"),billCode:t.get("code")};r({params:a,data:o},(function(){var e=null,r=null;a.params&&(e=a.params.childrenField);var o=t.get(e);t.getParams().cancelCallBack=function(){var e=o.getData().length;o.deleteRows([e-1]),cb.utils.setStatusBarStyle("light"),cb.route.goBack()};var i=a.cParameter;try{r=(i=JSON.parse(i)).referField}catch(e){cb.utils.alert("cParameter解析失败~","error")}var _=cb.rest.history.location.pathname.split("/"),c=_[_.length-1];cb.route.pushPage("/voucherRefer/"+c+"/"+r+"/"+e),cb.rest.bAddProduct=!0,o&&o.appendRow({}),n()}))},n=function(e,t,a,r,n){var o={billNum:e,billId:t.get("id"),billCode:t.get("code")};r({params:a,data:o},(function(){var e=null;a.params&&(e=a.params.onScan),cb.utils.IsIMScanBar()?cb.utils.alert("此设备可以直接用扫码枪！","info"):(cb.rest.isWeChat?wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(e){var a=t.get("barcode");a&&(a.setValue(e.resultStr,!0),a.fireEvent("enter"))}}):e&&e(),n())}))}},2431:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(process){var _common__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(191),_helpers_env__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(123),uuid_v1__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(557),uuid_v1__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(uuid_v1__WEBPACK_IMPORTED_MODULE_2__),_staterule_formularule__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(2423),_mtlapi__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(2422),_staterule_rule__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(429),_voucher_M__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(2429),__awaiter=function(e,t,a,r){return new(a||(a=Promise))((function(n,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function _(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(i,_)}c((r=r.apply(e,t||[])).next())}))},__generator=function(e,t){var a,r,n,o,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:_(0),throw:_(1),return:_(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function _(o){return function(_){return function(o){if(a)throw new TypeError("Generator is already executing.");for(;i;)try{if(a=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(n=i.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){i.label=o[1];break}if(6===o[0]&&i.label<n[1]){i.label=n[1],n=o;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(o);break}n[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{a=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,_])}}},themeType="ncc",voucher=function(){var _this=this,renderData=function(e,t,a){render(t,a.data,a.dirty,!0)},render=function(e,t,a,r){if(e.getParams().menuId&&!e.getParams().mode&&(e.getParams().mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT),_common__WEBPACK_IMPORTED_MODULE_0__.H(e),a){e.setDirty(!0),e.loadDirtyData(t);var n=e.getGridModels();n.forEach((function(e){e.initRowState(cb.models.DataStates.Insert)}));var o=e.getParams();o.masterOrgField,o.autoAddRow;0}else e.loadData(t);(r||e.getParams().isNewData)&&_beforeRender(e),_common__WEBPACK_IMPORTED_MODULE_0__.I(e),_staterule_rule__WEBPACK_IMPORTED_MODULE_5__.d(e),(r||e.getParams().isNewData)&&_afterRender(e),e.execute("afterLoadData",t,r||e.getParams().isNewData),e.setCache("dataLoaded",!0),"treevoucher"!==e.getParams().metaType||a||e.validate(!0)},_beforeRender=function(e){var t=e.getParams(),a=t.masterOrgField,r=t.masterOrgKeyField,n=t.mode,o=e.get(a);if(o){o._set_data("bCanModify",n===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD);var i=e.get(r);if(i)i.getValue()&&n!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&e.setDisabled(!1),e.biz.do("depends",e)}},_afterRender=function(e){var t=e.getParams(),a=t.mode,r=t.hasBuildCoded,n=t.billNo,o=t.masterOrgField,i=t.masterOrgKeyField;a===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&r?_createCode(n,e):a===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&0===e.getParams().isCoded&&(e.getParams().isCoded=!0,e.biz.do("code",e)),e.biz.do("depends",e);var _=e.get(o);if(_){var c=e.get(i);if(c)c.getValue()||(e.setDisabled(!0),e.get("btnAbandon")&&e.get("btnAbandon").setDisabled(!1),_.setDisabled(!1))}},_reloadVoucher=function(e,t,a,r,n){if(e){var o={tplid:t.tplid};o.billData=t;_common__WEBPACK_IMPORTED_MODULE_0__.t(r,o,(function(e,t){_fetchMetaCallback(e,t,r,(function(e,t){a.communication({payload:{menuName:t.cBillName,vm:e,refresh:!0,metaData:t}})}),o)}))}else _resetData(a,t,n)},_getTreeSelectNode=function(e){var t,a,r=e.getTreeModel();return r&&(t=r.getSelectedNodes()),t&&t.length&&t[0]&&(a=t[0]),a},_doService=function(e,t,a,r,n,o){if("treevoucher"===t.getParams().metaType&&!_getTreeSelectNode(t))return void cb.utils.alert("请选择有效数据","warning");_common__WEBPACK_IMPORTED_MODULE_0__.q(e,t,a,r,n,_doServiceByData,o)},_doServiceByData=function(e,t,a,r,n){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(t,o){if(!t){if(a.cShowCaption)cb.utils.alert(cb.locale("P_YS_FED_FW_0001026085",{text:a.cShowCaption}),"success");else{var i="open"==a.cAction?"启用":"停用";cb.utils.alert(cb.locale("P_YS_FED_FW_0001026085",{text:i}),"success")}if(e.getCache("banRenderNewData"))console.log("已禁止根据返回数据render");else{var _=e.collectData(!0);o=Array.isArray(o)&&o.length>0?o[0]:o;var c=_common__WEBPACK_IMPORTED_MODULE_0__.e(_,o);"treevoucher"===e.getParams().metaType&&e.getTreeModel().updateNode(c),render(e,c),c&&c.isWfControlled&&e.biz.do("refresh",e)}n&&n()}r&&r({err:t,res:o},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),t)},_tplIsEquql=function(e,t){return!!t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&e[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]!=t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).getValue()},_resetData=function(e,t,a){_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e,t),a&&a({res:t},_common__WEBPACK_IMPORTED_MODULE_0__.a)},_loadVm=function(e,t){t.originalVM=e.originalVM,t.originalViewMeta=e.originalViewMeta,t.biz.do("rule",t),t.biz.do("initDefaultActions",t)},_loadTree=function(e,t,a){t=Object.assign({},t,e.getCache("lastSearchCondition"));var r=e.allActions&&e.allActions.find((function(e){return e.cCommand&&"cmdquerytree"===e.cCommand.trim().toLocaleLowerCase()})),n=r&&r.cSvcUrl?{url:r.cSvcUrl,method:r.cHttpMethod||"POST"}:{url:"bill/querytree",method:"POST"},o=e.getTreeModel();o&&o.promiseExecute("beforeLoad",t,(function(){o.setDataSource(n,t),a&&o.setCache("afterAct",a)}))},search=function(e,t,a,r,n){t.setCache("execFilter",!0),t.setCache("lastSearchCondition",a);var o={billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")};a&&a instanceof Object&&(o=Object.assign(o,a)),r({params:a,data:a},(function(){_loadTree(t,o,n)}))},getModeDirtyData=function(e,t,a){void 0===t&&(t=!1);var r=e.getDirtyData(!1);"treevoucher"==e.getParams().metaType&&"saveandadd"==e.getCache("actionType")&&(t=!0,e.clearCache("actionType")),r&&!t?cb.utils.confirm("确定要放弃当前修改吗？",(function(){a(!0)}),(function(){a(!1);var t=e.getCache("cancelEditFun");t instanceof Function&&t()})):a(!0)},_bindTreeSelect=function(e,t){var a=e.getTreeModel();a&&(a.on("select",(function(a,r,n){e.promiseExecute("beforeTreeSelect",a,(function(){a.length?getModeDirtyData(e,n,(function(n){n&&(_common__WEBPACK_IMPORTED_MODULE_0__.G(e,r&&e.getParams().mode||_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),_renderTreeVoucherData(t,e,a[0]),e.setCache("lastMode",_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE))})):cb.extendConfig.voucher.treeCard||e.biz.do("add",e)}))})),a.on("afterSetDataSource",(function(){var e=a.getCache("afterAct");e&&e()})))},_renderTreeVoucherData=function(e,t,a){var r=a[t.getTreeModel().getState("keyField")];if(t.setCache("lastId",r&&r.toString()),t.getParams().hasChildren){var n={billnum:e,id:r},o=t.allActions&&t.allActions.find((function(e){return e.cCommand&&"cmddetail"===e.cCommand.trim().toLocaleLowerCase()})),i=o&&o.cSvcUrl?{cSvcUrl:o.cSvcUrl,cHttpMethod:o.cHttpMethod||"GET"}:{cSvcUrl:"bill/detail",cHttpMethod:"GET"};_common__WEBPACK_IMPORTED_MODULE_0__.p(i,(function(e,a){e||cb.extendConfig.voucher.treeCard&&t.getParams().mode===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD||render(t,a)}),n)}else render(t,a)},_fetchMetaCallback=function(e,t,a,r,n,o,i){_common__WEBPACK_IMPORTED_MODULE_0__.z(e,t,a,n,(function(e,a){e.viewCallback=r,e.originalVM=e,e.originalParams=n,e.originalViewMeta=t.viewmeta,o({vm:e,view:a})}),(function(e){e.setCache("entryMode",n.mode),e.setCache("condition",n.condition),e.initData()}),i)},_afterViewCallback=function(e,t,a){var r=function(t){var a=JSON.parse(JSON.stringify(t.getParams()));Object.assign(a,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,id:t.get("id").getValue()}),_getInitdata(e,a,(function(e,a){e?cb.utils.alert(e.message,"error"):_resetData(t,a)}))};_common__WEBPACK_IMPORTED_MODULE_0__.G(t,a.mode),t.on("refresh",(function(){r(t)})),t.on("back",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.w(t)===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&r(t)}));var n=new cb.promise;t.on("return",(function(e){return _common__WEBPACK_IMPORTED_MODULE_0__.w(t)===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE||!t.getDirtyData(!1)||(e&&"object"==typeof e?(e.prompt={},!0):(cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026058",{abandonText:e}),(function(){n.resolve()}),(function(){n.reject()})),n))})),t.biz.do("initDefaultActions",t),t.on("afterRule",(function(){if(a.mode===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT&&t.execute("afterEdit"),"copy"===a.action&&t.execute("afterCopy"),a.mode===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD){if(t.getCache("initKeyboardComplete"))return;_bindKeyboard(t),t.setCache("initKeyboardComplete",!0)}})),a.mode===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT&&t.getParams().workflowNoCtrl&&(t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1))},_getInitdata=function(e,t,a,r){cb.rest.DynamicProxy.create({getCmdList:{url:"billmeta/getbillcommands",method:"GET"}}).getCmdList({billno:e},(function(n,o){var i,_,c,l={billnum:e};switch(t&&t.mode||_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE){case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD:i="cmdadd",_="bill/add",c="POST",Object.assign(l,t.carryParams);break;case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT:if(i="cmddetail",_="bill/detail",c="GET",!t.id)return void a();l.id=t.id,t.isSum&&(l.isSum=t.isSum),Object.assign(l,t.carryParams);break;case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE:i="cmdenter",_="bill/enter",c="GET",l.subid=t&&t.subId}if(i&&o){var s=o.find((function(e){return e.cCommand&&e.cCommand.trim().toLocaleLowerCase()===i}));s&&s.cSvcUrl&&(_=s.cSvcUrl,c=s.cHttpMethod||"GET")}t&&!0===t.readOnly&&(t.mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE);var d={cSvcUrl:_,cHttpMethod:c};r?r({params:t,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(d,a,l)})):_common__WEBPACK_IMPORTED_MODULE_0__.p(d,a,l)}))},cellsCheck=function(e,t,a,r,n){var o=[];a.forEach((function(e){t.get(e.childrenField).getColumn(e.cellName).bCheck&&o.push({location:e.rowIndex,key:e.cellName,childrenField:e.childrenField,value:JSON.stringify(e.value),type:e.cControlType,fieldname:e.cFieldName})})),_common__WEBPACK_IMPORTED_MODULE_0__.c(e,t,o)},referRowsCheck=function(e,t,a,r,n){var o=a.childrenField,i=a.columnName,_=a.index,c=a.rows,l=t.get(o).getColumn(i);if(l.bBatchCheck){var s={location:_,key:i,childrenField:o,value:JSON.stringify(c),type:l.cControlType,fieldname:l.cFieldName,mergeAll:!0};_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,s,r,n,!0)}},cellCheck=function(e,t,a,r,n){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),i=a.cellName,_=o.getColumn(i);if(_.bCheck){var c={location:a.rowIndex,key:i,childrenField:a.childrenField,value:JSON.stringify(a.value),oldValue:a.oldValue,type:_.cControlType,fieldname:_.cFieldName,async:a.async,callback:a.callback,context:a.context};r({params:a,data:c},(function(){if(!0===_.bCheck){var a=o.getCache("ruleItems");a&&a.indexOf(i)>-1&&(c.async=!1),_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,c,r,n,!0)}}))}},lineOpenOrClose=function(e,t,a,r,n){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(o.length){var i=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getRowsByIndexes(o),_=o[0],c=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getName(),l=t.collectData(!0);l[c]=i;var s={billnum:e,data:JSON.stringify(l)};r({params:a,data:s},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,r){if(!e){cb.utils.alert("操作成功","success");var o={};a&&a.childrenField&&(o[a.childrenField]=[_]);var i=t.collectData(!0),c=_common__WEBPACK_IMPORTED_MODULE_0__.e(i,r,o);render(t,c),_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).select([_])}n({err:e,res:r},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),s)}))}},copy=function(e,t,a,r,n){if(a&&a.cSvcUrl){t&&(a.mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,a.id=t.get("id").getValue());var o={billnum:e};_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(r,o){r?_common__WEBPACK_IMPORTED_MODULE_0__.a({err:r}):_getInitdata(e,a,(function(e,r){if(e)_common__WEBPACK_IMPORTED_MODULE_0__.a({err:e});else{var i=_common__WEBPACK_IMPORTED_MODULE_0__.d(r,o);t?(_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),render(t,i,!0,!0),n()):(a.mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,n(null,i))}}))}),o)}},refresh=function(e,t,a,r,n){var o=function(a,r){if(!a&&r){var o=_tplIsEquql(r,t);_reloadVoucher(o,r,t,e,n)}else{n({err:a,res:r},_common__WEBPACK_IMPORTED_MODULE_0__.a)}},i={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,id:t.get("id").getValue(),isSum:a&&a.isSum};r({params:a,data:i},(function(){_getInitdata(e,i,o,r)}))},loadData=function(e,t,a,r,n){var o=a.data,i=_common__WEBPACK_IMPORTED_MODULE_0__.w(t),_=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"parent"),c=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cCarry"),l=[];if(c&&_){try{c=JSON.parse(c)}catch(e){return void console.error("列表cCarry JSON格式错误--\x3e"+c)}if("object"==typeof c)for(var s in c){var d=c[s];o[s]=_[d],l.push(s)}}l.map((function(e){var a=t.get(e);a&&a.setDirty(!0)})),r({params:a,data:o},(function(){render(t,o,i==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD)}))},buildDepends=function(e,t){var a=t.get("depends");if(a){var r=null,n=function(e){try{var n=JSON.parse(e),o=null,i=null,_=null,c=e;for(var l in n)_=l,i=t.get(n[l]),o=i.getEditRowModel(),r=o.get(l);_buildDepends(a[c],o,r.getValue()),o.on("afterUpdateEditRowModel",(function(e){cb.utils.isEmpty(e[_])||_buildDepends(a[c],o,e[_]||0)}),a[e])}catch(n){if(!(r=t.get(e)))return"continue";r._set_data("needCheck",!0),_buildDepends(a[e],t,r.getValue()),r.on("afterValueChange",(function(e){_buildDepends(this,t,e.value)}),a[e])}};for(var o in a)n(o)}},_buildDepends=function(e,t,a){cb.utils.isEmpty(a)||(a="string"==typeof a?Number(a):a,e.forEach((function(e){if(e.childrenField){var r=t.get(e.childrenField);r instanceof cb.models.GridModel&&(r.getEditRowModel().get(e.field).setState("iNumPoint",a),r.setColumnState(e.field,"iNumPoint",a))}else{var n=t.get(e.field);n instanceof cb.models.SimpleModel&&n.setState("iNumPoint",a)}})))},buildOrg=function(e,t){var a=t.getParams(),r=a.masterOrgField,n=a.carryParams;if(r){var o=t.get(r);if(o){t.getParams().mode!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&(o._set_data("bCanModify",!1),o.setReadOnly(!0)),o.on("beforeValueChange",(function(e){if((s=l&&l.getValue())&&(!e.value||e.value.id!=s)){var a=new cb.promise;return t.promiseExecute("beforeChangeMasterOrg",(function(){cb.utils.confirm("切换主组织将清空数据，是否继续",(function(){t.setCache("delayCode",!0),a.resolve()}))})),a}})),o.on("afterValueChange",(function(a){if(s||cb.utils.isArray(a.value)||!a.value||(t.setDisabled(!1),t.execute("afterMasterOrgChange",l.getValue())),s&&(!a.value||a.value.id!=s)){t.clearCache("delayCode");var r={};r[_]=a.value&&a.value.id||null,t.get("code")&&t.getParams().hasBuildCoded&&(r.code=t.get("code").getValue()),t.biz.do("add",t,{carryParams:n,carryData:r,callback:function(){l._get_data("needCheck")&&_createCode(e,t),!cb.utils.isArray(a.value)&&a.value?o.setValue([a.value]):(l.setValue(null,l._get_data("needCheck")),t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1),o.setDisabled(!1)),s=l.getValue(),o.execute("afterValueChange",a),t.execute("afterMasterOrgChange",s)}})}}));var i=o.getState("bill2ReferKeyFieldMap")||{},_=null;for(var c in i){if(_)break;_=c}_||(_="org");var l=t.get(_);if(l){t.getParams().masterOrgKeyField=_;var s=l.getValue();if(!s)return t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1),void o.setDisabled(!1);var d=t.getParams(),u=d.mode,m=d.realAdd,f=d.action;u===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&!1!==m&&"copy"!==f&&o.browse(!1,(function(e){e.on("getRefMetaReady",(function(){var a={isExtend:!0,simpleVOs:[{field:"id",op:"in",value1:s}]};e.execute("pressEnter",{model:o,condition:a,browse:!1,errCallBack:function(){return l.setValue(null),s=l.getValue(),t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1),o.setDisabled(!1),!1}})}))}))}}}},buildCode=function(e,t,a,r,n){var o=t.getParams(),i=o.isCoded,_=o.mode,c=o.realAdd;if(i&&!1!==c){var l={billNum:e};r({params:a,data:l},(function(){cb.rest.DynamicProxy.create({getCode:{url:"billNumber/findByBillNum",method:"GET"}}).getCode(l,(function(e,a){if(!e&&a){var r=t.get("code");if(r){var o=!!a.ballowhandwork;if(r._set_data("bCanModify",o),r.setDisabled(!o),n(),(!o||a.brepeatredo)&&a.billPrefix&&a.billPrefix.length){t.getParams().hasBuildCoded=!0,_===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD&&_createCode(l.billNum,t);var i=[];a.billPrefix.forEach((function(e){e.cfieldname&&(_buildCode(e.cfieldname,t,l.billNum),i.push(e.cfieldname))})),t.setCache("prefixes",i)}}}else cb.utils.alert(e.message,"error")}))}))}},_buildCode=function(e,t,a){var r=t.get(e);r&&(r._set_data("needCheck",!0),r.on("afterValueChange",(function(){_createCode(a,t)})))},_createCode=function(e,t){if(!t.getCache("delayCode")){var a=cb.rest.DynamicProxy.create({createCode:{url:"billNumber/createCode?billNum="+e,method:"POST"}}),r=t.collectData();a.createCode(r,(function(e,a){!e&&a?t.get("code").setValue(a):cb.utils.alert(e.message,"error")}))}},buildRule=function(billNo,viewmodel,para,beforeAct,afterAct){var postData={billNumber:billNo,language:"javascript"},beforeActData={params:para,data:postData};beforeAct(beforeActData,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p({cSvcUrl:"/itemrule/script",cHttpMethod:"GET"},(function(_err,data){data=eval(data)||{};var fields={};for(var attr in data&&(data.rules||[]).forEach((function(e){for(var t in e.triggers.forEach((function(t){var a=t.ds;if(a)fields[a]||(fields[a]=[]),-1==fields[a].indexOf(t.item)&&fields[a].push(t.item);else{if(!viewmodel.get(t.item))return;viewmodel.get(t.item).on("afterValueChange",(function(){this.run(this.param)}),{run:data.run,param:{ruleid:e.id,vm:viewmodel,trigger:{ds:a,item:t.item,lineid:"0"}}})}})),fields)if(viewmodel.get(t)){viewmodel.get(t).setCache("ruleItems",fields[t]);var a=function(e){if(null===e.cellName){if(!this.ruleTriggers||0==this.ruleTriggers.length)return;this.param.trigger.item=this.ruleTriggers[0].item}else{if(-1===this.items.indexOf(e.cellName))return;this.param.trigger.item=e.cellName}this.param.trigger.lineid="0:"+e.rowIndex,this.run(this.param)},r={items:fields[t],run:data.run,param:{ruleid:e.id,vm:viewmodel,trigger:{ds:t}},ruleTriggers:e.triggers};viewmodel.get(t).on("afterCellValueChange",a,r),viewmodel.get(t).on("innerCellValueChange",a,r)}})),fields)viewmodel.get(attr).on("afterDeleteRows",(function(){var e=this.childrenField;viewmodel.get(e).execute("innerCellValueChange",{rowIndex:-1,cellName:null})}),{childrenField:attr}),viewmodel.get(attr).on("afterInsertRow",(function(){var e=this.childrenField;viewmodel.get(e).execute("innerCellValueChange",{rowIndex:-1,cellName:null})}),{childrenField:attr});var jointFields={};for(var attr in(data.jointFields||[]).forEach((function(e){var t=e.ds;if(t)jointFields[t]||(jointFields[t]=[]),jointFields[t].push(e.item);else{if(!viewmodel.get(e.item))return;viewmodel.get(e.item).on("jointQuery",(function(){var e=null;try{e=JSON.parse(this.param.vm.get(this.param.trigger.item).getState("cStyle"))}catch(t){e={}}var t=this.jointQuery(this.param),a=[];for(var r in t.paras)a.push(r+"="+t.paras[r]);if(e.menuCode="SJ0201",e.menuCode)viewmodel.communication({type:"menu",payload:{menuCode:e.menuCode,menuUrl:"?"+a.join(",")}});else{var n=this.param.vm,o={billtype:"voucher",billno:t.target,params:cb.utils.extend(!0,t.paras,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT})};cb.loader.runCommandLine("bill",o,n)}}),{jointQuery:data.jointQuery,param:{vm:viewmodel,trigger:{ds:e.ds,item:e.item}}})}})),jointFields)viewmodel.get(attr)&&viewmodel.get(attr).on("cellJointQuery",(function(e){if(-1!==this.items.indexOf(e.cellName)){this.param.trigger.item=e.cellName,this.param.trigger.lineid="0:"+e.rowIndex;var t=this.jointQuery(this.param),a=this.param.vm,r={billtype:"voucher",billno:t.target,params:cb.utils.extend(!0,t.paras,{mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT})};cb.loader.runCommandLine("bill",r,a)}}),{items:jointFields[attr],jointQuery:data.jointQuery,param:{vm:viewmodel,trigger:{ds:attr}}});var refFields={};for(var attr in(data.refFields||[]).forEach((function(e){var t=e.ds;if(t)refFields[t]||(refFields[t]=[]),refFields[t].push(e.item);else{var a=viewmodel.get(e.item);if(!a)return;a.on("beforeBrowse",(function(){var e=this.jointQuery(this.param);e&&_setReferRule(e,this.referModel)}),{referModel:a,jointQuery:data.jointQuery,param:{action:"ref",vm:viewmodel,trigger:{ds:e.ds,item:e.item}}})}})),refFields){var referModel=viewmodel.get(attr);referModel&&referModel.on("beforeBrowse",(function(e){if(-1!==this.items.indexOf(e.cellName)){this.param.trigger.item=e.cellName,this.param.trigger.lineid="0:"+e.rowIndex;var t=this.jointQuery(this.param);t&&_setReferRule(t,e.context)}}),{referModel:referModel,items:refFields[attr],jointQuery:data.jointQuery,param:{action:"ref",vm:viewmodel,trigger:{ds:attr}}})}afterAct()}),postData)}))},_setReferRule=function(e,t){var a=e.target;a&&(a.cRefType&&t.setRefCode(a.cRefType),a.cRefRetId&&t.setReturnFields(a.cRefRetId.refid)),t.setFilter({isExtend:!0,simpleVOs:e.paras})},_resetOriginal=function(e,t){var a=e.originalVM||e;a.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&e.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&a.getOriginalData()[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]!=e.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).getValue()&&(e.communication({payload:{menuName:a.originalViewMeta.cBillName,vm:a,refresh:!0,metaData:a.originalViewMeta}}),_loadVm(e,a));var r=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE;e.getCache("lastMode")?_common__WEBPACK_IMPORTED_MODULE_0__.G(a,e.getCache("lastMode")):e.getCache("entryMode")!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&e.getParams().menuId||_common__WEBPACK_IMPORTED_MODULE_0__.G(a,r);var n=a.getOriginalData(),o=a.getTreeModel();if(o){var i=o.getSelectedNodes();i.length>0&&(n=i[0])}a.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&cb.utils.isEmpty(n[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY])&&(n[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]=a.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).get("cDefaultValue")),render(a,n,r===_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,!0),t({res:n},_common__WEBPACK_IMPORTED_MODULE_0__.a)},check=function(e,t,a,r,n){if("treevoucher"===t.getParams().metaType){var o=_getTreeSelectNode(t);if(o){var i=t.getTreeModel();a[i.getState("parentField")]=o[i.getState("keyField")]}}r({params:a},(function(){var o="ncc"===cb.extendConfig.theme;_common__WEBPACK_IMPORTED_MODULE_0__.g(e,t,a,r,n,!1,o)}))},getAbandonText=function(e){return JSON.parse(e).cAbandonText||"取消"},abandon=function(e,t,a,r,n){r({params:a},(function(){if(_common__WEBPACK_IMPORTED_MODULE_0__.w(t)!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE||t.getParams().menuId){var e=t.getDirtyData(!1);if("treevoucher"===t.getParams().metaType&&cb.extendConfig.voucher.treeCard&&(e||(e=t.getNecessaryData())),e){var r=a.cShowCaption||getAbandonText(a.cParameter);cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026038",{abandonText:r}),(function(){_abandon(t,n)}),(function(){a&&a.enabledCallback&&a.enabledCallback()}))}else _abandon(t,n)}else t.communication({type:"return"})}))},_abandon=function(e,t){var a=e.getParams(),r=a.multitpl,n=a.metaType,o=a.menuId;if(r||e.getCache("entryMode")!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&"treevoucher"!==n&&!o)return t(),void e.communication({type:"return"});if(_resetOriginal(e,t),"treevoucher"===n){var i=e.getCache("lastId");if(!i)return _common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),e.setDirty(!1),void _resetOriginal(e,t);var _=e.getTreeModel();if(!_)return;return _.select(i,void 0,!0),void e.setDirty(!1)}e.validate(!0)},inValid=function(e,t,a,r,n){var o=window.prompt("请输入作废理由",""),i=t.getNecessaryData();o&&(i=cb.utils.extend(i,{invalidReason:o}));var _={billnum:e,data:JSON.stringify(i)};r({params:a,data:_},(function(){_doServiceByData(t,_,a,n)}))},batchModify=function(e,t,a,r,n){t.communication({type:"modal",payload:{key:"batchModify",data:{billType:"voucher",billNo:e,model:t,params:a}}})},submit=function(e,t,a,r,n){console.log("submit ---\x3e");var o=t.collectData(!0),i={billnum:e,data:JSON.stringify(o)};r({params:a,data:i},(function(){_doServiceByData(t,i,a,n)}))},unsubmit=function(e,t,a,r,n){console.log("unsubmit ---\x3e");var o=t.collectData();o=t.collectData(!0);var i={billnum:e,data:JSON.stringify(o)};r({params:a,data:i},(function(){_doServiceByData(t,i,a,n,(function(){t.getParams().workflowNoCtrl&&delete t.getParams().workflowNoCtrl}))}))},checkApprove=function(e,t,a,r,n){var o={billNum:e,billId:t.get("id"),billCode:t.get("code")};r({params:a,data:o},(function(){t.communication({type:"modal",payload:{type:"platform",url:"checkapprove",model:t,data:o}}),n()}))},workflow=function(e,t,a,r,n){var o=e+"_"+t.get("id").getValue(),i={width:850,height:510,appsource:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.appCode,businessKey:o};r({params:a,data:i},(function(){window.flowComp(i).showFlowBox({onClose:function(o){refresh(e,t,a,r,n)}})}))},audit=function(e,t,a,r,n){if(t.get("isWfControlled")&&t.get("isWfControlled").getValue()){if(!t.get("verifystate")||1!==t.get("verifystate").getValue())return void cb.utils.alert("请先提交","error");var o=e+"_"+t.get("id").getValue();window.flowComp({width:850,height:510,appsource:"u8c",businessKey:o}).showFlowBox({onClose:function(e){t.communication({type:"refresh"})}})}else{var i=t.collectData(!0),_={billnum:e,data:JSON.stringify(i)};r({params:a,data:_},(function(){_doServiceByData(t,_,a,n)}))}},open=function(e,t,a,r,n){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"open"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}cb.extendConfig.allConfirm&&a.cShowCaption?cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026042",{cShowCaption:a.cShowCaption}),(function(){_doService(e,t,a,r,n,!0)})):_doService(e,t,a,r,n,!0)},close=function(e,t,a,r,n){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"close"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}cb.extendConfig.allConfirm&&a.cShowCaption?cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026042",{cShowCaption:a.cShowCaption}),(function(){_doService(e,t,a,r,n,!0)})):_doService(e,t,a,r,n,!0)},table2DBtnClick=function(e,t,a,r,n){t.execute("table2DBtnClick")},addRow=function(e,t,a,r,n){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),i=o.t2DInfo_Bus_Get("support2D"),_=o.t2DInfo_Bus_Get("show2D");if(i&&_)t.execute("table2DAddRowClick");else{var c={params:a};r(c,(function(){o.setCache("excludeFieldsWhenSave",c.params.excludeFieldsWhenSave);var e=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).appendRow();c.data=e,n(c)}))}},deleteRow=function(e,t,a,r,n){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();cb.utils.isArray(o)&&0==o.length?cb.utils.alert("请选择行","warning"):r({params:a,data:o},(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).deleteRows(o);n(e)}))},insertRow=function(e,t,a,r,n){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(cb.utils.isArray(o)&&0==o.length)cb.utils.alert("请选择行","warning");else{var i={params:a,data:o};r(i,(function(){o.length&&(_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).insertRow(o[0],null,!0),n(i))}))}},copyRow=function(e,t,a,r,n){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(cb.utils.isArray(o)&&0==o.length)cb.utils.alert("请选择行","warning");else{var i=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getRow(o[0]),_={params:a,data:{rowIndexes:o,rowData:i}};r(_,(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).insertRow(o[0],_.data.rowData,null,!0);_.data.rowData=e,n(_)}))}},shiftUpRow=function(e,t,a,r,n){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(o.length){var i=o[0],_={params:a,data:i};r(_,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).shiftUpRow(i),n(_)}))}},shiftDownRow=function(e,t,a,r,n){var o=a&&a.params&&null!=a.params.index?[a.params.index]:_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).getSelectedRowIndexes();if(o.length){var i=o[0],_={params:a,data:i};r(_,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a).shiftDownRow(i),n(_)}))}},localPrint=function(e,t,a,r,n){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"localprint"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}var i=t.get("id").getValue();if(cb.utils.isEmpty(i))cb.utils.alert("未找到具体单据","error");else{var _=a&&a.cSvcUrl||"/bill",c=a.disabledCallback,l=a.enabledCallback,s="";if(a.cParameter){var d=JSON.parse(a.cParameter);s=d&&d.printTplItemName}if(s){var u=t.get(s);if(u&&2!=cb.rest.terminalType){var m=u.getValue();if(cb.utils.isEmpty(m))return void cb.utils.alert("请选择打印模板","error");c&&(c(),a.disabledCallback=!1),_localPrint(e,m,i,_,r,l)}else{c&&(c(),a.disabledCallback=!1),cb.rest.DynamicProxy.create({getTemplate:{url:"print/getTemplateByBo",method:"GET",options:{mask:!0}}}).getTemplate({billno:e},(function(t,a){if(t)return cb.utils.alert(t.message,"error"),void(l&&l());var n=1===a.length?a[0]:a.find((function(e){return e.isdefault}));if(cb.utils.isEmpty(n))return cb.utils.alert("没有设置打印模板，请检查","error"),void(l&&l());_localPrint(e,n.templatecode,i,_,r,l)}))}}else cb.utils.alert("请预置打印按钮的cParameter信息 { printTplItemName : 打印模板的cItemName}","warning")}},_localPrint=function(e,t,a,r,n,o){var i={billno:e,templateCode:t,ids:[a]};cb.rest.DynamicProxy.create({print:{url:r+"/getTemplateStructure",method:"POST",options:{mask:!0}}}).print(i,(function(e,t){if(e)return cb.utils.alert(e.message,"error"),void(o&&o());n(t,(function(){cb.utils.localPrint(t),o&&o()}))}))},isInWorkBench=function(e){var t=!1,a="isInWorkBench";return t=isModelHasKey(e,a),e&&0==t&&(e=e.getParent(),t=isModelHasKey(e,a)),e&&0==t&&(e=e.getParent(),t=isModelHasKey(e,a)),t},isHideAlert=function(e){var t=!1,a="isHideAlert";return t=isModelHasKey(e,a),e&&0==t&&(e=e.getParent(),t=isModelHasKey(e,a)),e&&0==t&&(e=e.getParent(),t=isModelHasKey(e,a)),t||!1},isModelHasKey=function(e,t){return e&&1==e.getCache(t)||!1},save=function(e,t,a,r,n,o){if(!(a=a||{}).cAction){var i=t.allActions&&t.allActions.find((function(e){return"save"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,i)}t.getGridModel()&&t.getGridModel().getRowsCount()&&t.getGridModel().select(0);var _=t.validate();if(_){if(1==isHideAlert(t))n({err:{message:"以下数据项校验失败："+_.join(",")}});else if("ncc"===cb.extendConfig.theme)cb.utils.alert(t.getCache("customErrorMessage")||"以下数据项校验失败："+_.join(","),"error");else{var c=t.getCache("invalidFields");if(c){var l=[],s=!1;c.forEach((function(e){var a=t.get(e),r=a.get("bShowIt"),n=a.get("bHidden");!1===r||n?l.push(a._get_data("cShowCaption")||a._get_data("cCaption")||a._get_data("cFieldName")):s=!0})),l.length>0&&!s?cb.utils.alert("存在隐藏必输数据项："+l.join(","),"error"):cb.utils.alert("以下数据项校验失败："+_.join(","),"error")}}console.log("保存失败---以下数据项校验失败："+_.join(","))}else{var d=_common__WEBPACK_IMPORTED_MODULE_0__.w(t),u=t.getParams().metaType,m=t.collectData();if(m){if("editablevoucherlist"==u&&(m=m[t.getGridModel().getName()]),d==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD){if(m._status=cb.models.DataStates.Insert,"treevoucher"===u){var f=t.getTreeModel(),E=m[f.getState("parentField")];if(E){if(f){var p=f.getNodesByKeys(E);p&&p.length&&(m.level=p[0].level+1)}}else m.level=1}var g=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"parentId");if(null!=g){var v=_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"foreignKey");v&&(m[v]=g)}}else m._status=cb.models.DataStates.Update;var h=Object.assign({billnum:e,data:JSON.stringify(m)},a.defineParams);r({params:a,data:h},(function(){a.options={mask:!0},_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(r,i){var _=i,c={params:a,err:r,res:_};if(!r){if(t.setDirty(!1),_handlePageInfoStatus(t,a,i),0==isHideAlert(t)){var l=cb.locale("P_YS_FED_FW_0001026085",{text:o||a.cShowCaption||a.cCaption||"保存"});window.parent!==window&&cb.rest.AppContext.query.random&&t.getParams().domain?window.parent.postMessage({key:"crossdomainpush",random:cb.rest.AppContext.query.random,msg:{type:"success",content:l}},"*"):cb.utils.alert(l,"success")}if(1==isInWorkBench(t))return void n(c,_common__WEBPACK_IMPORTED_MODULE_0__.a);var s=t.getParams(),m=s.menuId,f=s.saveReturn;t.getCache("entryMode")!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&m&&!1!==f&&"treevoucher"!==u||_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE);var E=a.cAction.trim().toLocaleLowerCase();if("saveandadd"===E){if("treevoucher"===u){var p=t.getTreeModel();if(t.execute("updateTreeRefer"),t.getParams().saveRefresh){var g=_[p.getState("keyField")];p._set_data("defaultSelectedKeys",[g]),_loadTree(t,{billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")},(function(){}))}else d!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD?p.updateNode(_):p.addNode(_)}return void n(c,_common__WEBPACK_IMPORTED_MODULE_0__.a)}if("saveandaudit"!==E&&!1!==t.getParams().saveReturn&&(t.getParams().multitpl||t.getCache("entryMode")!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE)&&"treevoucher"!==u&&!m)return cb.utils.isEmpty(t.get("id").getValue())&&i&&t.get("id").setValue(i.id),n(c,_common__WEBPACK_IMPORTED_MODULE_0__.a),void t.communication({type:"return",payload:t.get("id").getValue()});t.getGridModels().forEach((function(e){e.unselectAll()}));var v,h=t.collectData(!0),C=[];for(var g in i)Array.isArray(i[g])&&t.get(g)&&t.get(g).getDirtyRowIndexes&&t.get(g).getDirtyRowIndexes()&&t.get(g).getDirtyRowIndexes().length>0&&(C.push(g),v={});if(C.forEach((function(e){v[e]=t.get(e).getDirtyRowIndexes()})),_=_common__WEBPACK_IMPORTED_MODULE_0__.e(h,i,v),render(t,_),"treevoucher"===u){p=t.getTreeModel();if(_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),t.execute("updateTreeRefer"),t.getParams().saveRefresh){g=_[p.getState("keyField")];p._set_data("defaultSelectedKeys",[g]),_loadTree(t,{billnum:e,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"treeName")},(function(){}))}else d!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD?p.updateNode(_):p.addNode(_,!0)}}n(c,_common__WEBPACK_IMPORTED_MODULE_0__.a)}),h)}))}else"treevoucher"!==u&&(cb.utils.alert("未作任何修改"),t.setReadOnly(!0),_common__WEBPACK_IMPORTED_MODULE_0__.I(t),_staterule_rule__WEBPACK_IMPORTED_MODULE_5__.d(t))}},_delete=function(e,t,a,r,n){var o=e.getParams().metaType;_common__WEBPACK_IMPORTED_MODULE_0__.p(t,(function(t,a){if(t)e.setCache("deleteError",!0);else{if(e.setCache("deleteError",!1),cb.utils.alert("操作成功","success"),"treevoucher"===o){var i=e.getTreeModel();if(i){var _=i.getSelectedKeys();if(_&&1==_.length){var c=i.getSelectedNodes()[0],l=i.getNextSibling(c),s=i.getPrevSibling(c),d=i.getParentNode(c);if(i.deleteNode(_),cb.extendConfig.voucher.treeCard||null===(cb.extendConfig.treeVoucher||{}).selectAfterDelete)_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e);else if("prev"===(cb.extendConfig.treeVoucher||{}).selectAfterDelete)_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e,i._get_data("dataSource")),i.selectNodes(s||l||d);else if("next"===(cb.extendConfig.treeVoucher||{}).selectAfterDelete)_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e,i._get_data("dataSource")),i.selectNodes(l||s||d);else{(i._get_data("dataSource")||[]).length>0?(_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE),render(e,i._get_data("dataSource")),i.selectNodes(l||s||d)):(_common__WEBPACK_IMPORTED_MODULE_0__.G(e,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),e.biz.do("add",e))}}}}else{if(!e.getCache("condition"))return void e.communication({type:"return"});e.getParams().menuId?window.parent!==window&&window.jDiwork?jDiwork.closeWin():render(e):n||e.communication({type:"return"})}e.getCache("returnList")&&(e.communication({type:"return"}),e.setCache("returnList",!1))}r({err:t,res:a},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),a)},doDelete=function(e,t,a,r,n){var o=t.getParams().metaType;if("treevoucher"===o){if(!(_=_getTreeSelectNode(t)))return void cb.utils.alert("请选择有效数据","warning");if(_&&_.children&&_.children.length>0&&!cb.extendConfig.voucher.treeCard)return void cb.utils.alert("有下级，不能删除","warning")}var i=t.getNecessaryData();if("treevoucher"===o&&cb.extendConfig.voucher.treeCard){var _=_getTreeSelectNode(t);i=_}var c={billnum:e,data:JSON.stringify(i)};r({params:a,data:c},(function(){var e=t.getParams().caption,r=!1;cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026053",{text:e}),(function(){var _=cb.extendConfig.voucher.deleteReturn;if(_&&!t.getParams().menuId&&"treevoucher"!==o){"ncc"==themeType&&(_=_handlePageInfoStatus(t,a));var l=t.allActions.find((function(e){var t="cmd"+_;return e.cCommand&&e.cCommand.trim().toLocaleLowerCase()===t}));l&&(t.biz.do(_,t,l),r=!0)}t.getCache("isReturn")&&(r=!0),"treevoucher"===o&&cb.extendConfig.voucher.treeCard?cb.utils.confirm("删除时要做业务引用校验，可能等待的时间较长，是否确认删除？",(function(){i&&i.children&&i.children.length>0?cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026052",{text:e}),(function(){_delete(t,a,c,n,r)})):_delete(t,a,c,n,r)})):_delete(t,a,c,n,r)}),(function(){a&&a.enabledCallback&&a.enabledCallback()}))}))},moveFirstOrLast=function(e,t,a,r,n){var o={billnum:e,condition:t.getCache("condition")};r({params:a,data:o},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,r){n({err:e,res:r},_common__WEBPACK_IMPORTED_MODULE_0__.a),e||(_handlePageInfoStatus(t,a),render(t,r))}),o)}))},movePrevOrNext=function(e,t,a,r,n){if(t.setCache("deleteError",!1),t.getCache("condition")){var o="get"==(a.cHttpMethod?a.cHttpMethod.toLocaleLowerCase():"get")?encodeURI(JSON.stringify(t.getCache("condition"))):t.getCache("condition"),i={billnum:e,id:t.get("id").getValue(),condition:o};r({params:a,data:i},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(r,o){if(r){var i={err:r,res:o};r&&!o&&t.setCache("returnList",!0),n(i,_common__WEBPACK_IMPORTED_MODULE_0__.a)}else{var _=_tplIsEquql(o,t);t.getCache("deleteError")||_reloadVoucher(_,o,t,e,n),_handlePageInfoStatus(t,a)}}),i)}))}},pull=function(e,t,a,r,n){var o=new cb.utils.queryString(a.cSvcUrl),i=o.get("code"),_=o.get("targetBillNo");if(i&&_){var c={code:i,isMainSelect:1,childIds:[t.get("id").getValue()]},l={cSvcUrl:o.pathname+o.toStr(),cHttpMethod:a.cHttpMethod};r({params:a,data:c},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(l,(function(e,a){if(!e){var r={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,carryData:a},o={billtype:"voucher",billno:_,params:r};cb.loader.runCommandLine("bill",o,t)}n({err:e,res:a},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),c)}))}},saveAndAdd=function(e,t,a){var r=t.allActions&&t.allActions.find((function(e){return"save"===e.cAction.trim().toLocaleLowerCase()}));if(r){r=Object.assign({},r,{cAction:a.cAction});save(e,t,r,(function(e,a){t.promiseExecute("beforeSave",e,a)}),(function(r){var n,o;n=r,o=function(){if(t.setCache("actionType","saveandadd"),r.err)_common__WEBPACK_IMPORTED_MODULE_0__.a(r);else{t.clear(!1);var n=t.allActions&&t.allActions.find((function(e){return"add"===e.cAction.trim().toLocaleLowerCase()}));(n=Object.assign({},n,{cAction:a.cAction})).saveData=r.res,add(e,t,n,(function(e,a){t.promiseExecute("beforeAdd",e,a)}),(function(e,a){t.promiseExecute("afterAdd",e,(function(){a&&a(e),t._get_data("propertyNames").forEach((function(e){var a=t.get(e);a instanceof cb.models.BaseModel&&a.doPropertyChange("validate",{type:"",message:""})}),t)}))}))}},t.promiseExecute("afterSave",n,(function(){o&&o(n)}))}))}else cb.utils.alert("没有取到保存参数","error")},saveAndAudit=function(e,t,a){var r=t.allActions&&t.allActions.find((function(e){return"save"===e.cAction.trim().toLocaleLowerCase()}));if(r){r=Object.assign({},r,{cAction:a.cAction});save(e,t,r,(function(e,a){t.promiseExecute("beforeSave",e,a)}),(function(r){var n,o;n=r,o=function(){if(r.err)_common__WEBPACK_IMPORTED_MODULE_0__.a(r);else{var n=t.allActions&&t.allActions.find((function(e){return"audit"===e.cAction.trim().toLocaleLowerCase()}));n?(n=Object.assign({},n,{cAction:a.cAction}),audit(e,t,n,(function(e,a){t.promiseExecute("beforeAudit",e,a)}),(function(e,a){t.promiseExecute("afterAudit",e,(function(){a&&a(e)}))}))):cb.utils.alert("没有取到提交参数","error")}},t.promiseExecute("afterSave",n,(function(){o&&o(n)}))}))}else cb.utils.alert("没有取到保存参数","error")},add=function(e,t,a,r,n){var o;if(!t)return _getInitdata(e,a,n);if(!(a=a||{}).cAction){var i=t.allActions&&t.allActions.find((function(e){return"add"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,i)}var _=new cb.utils.queryString(a.cSvcUrl),c=[];if(_.has("code")){var l={billtype:"billmaker",billno:_.get("billno"),params:{code:_.get("code"),makeBilltype:_.get("makeBilltype")}};cb.loader.runCommandLine("bill",l,null,(function(o,i){var _=function(e,t){c=t,n({err:e,params:a,res:t},_common__WEBPACK_IMPORTED_MODULE_0__.a)},l={billnum:e};r({params:a,data:l},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.s(l,a,_),o.on("afterOkClick",(function(e){if(e.data){_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD);var a=_common__WEBPACK_IMPORTED_MODULE_0__.e(e.data,c);render(t,a,!0)}})),o.on("close",(function(){t.communication({type:"modal",payload:!1})})),t.communication({type:"modal",payload:{type:"platform",url:"billmaker",model:t,data:{vm:o,viewmeta:i}}})}))}))}else{var s,d=t.getParams().metaType;if("treevoucher"===d){var u=t.getTreeModel().getState("maxLevel"),m=!1===u?65536:u||3;if((s=_getTreeSelectNode(t))&&s.level>m)return void cb.utils.alert(cb.locale("P_YS_FED_FW_0001026057",{level:m+1}),"error")}var f={billnum:e};if(Object.assign(f,a.carryParams),"treevoucher"===d&&cb.extendConfig.voucher.treeCard){var E=t.getTreeModel(),p=E.getState("keyField");f=Object.assign({},f,((o={})[p]=s&&s[E.getState("keyField")],o))}r({params:a,data:f},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.s(f,a,(function(e,r){var o={err:e,params:a,res:r=r||{}};if(!e){if(_common__WEBPACK_IMPORTED_MODULE_0__.G(t,_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),t.addData=r,t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)){var i=t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).getValue();r[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY]=i}if("treevoucher"===d){var _=t.getTreeModel(),c=_.getState("parentField");s&&null==r[c]&&(r[c]=s[_.getState("keyField")],r.parent_name=s.name)}if(cb.extendConfig&&"ncc"==cb.extendConfig.theme?render(t,r,!0):render(t,Object.assign({},r,a.carryData),!0,!a.carryData),a.callback)a.callback();else{var l=t.getParams(),u=l.masterOrgField,m=l.masterOrgKeyField,f=t.get(u);if(f){var E=t.get(m);if(E){var p=E.getValue();if(p){var g={isExtend:!0,simpleVOs:[{field:"id",op:"in",value1:p}]},v=function(){return E.setValue(null),t.setDisabled(!0),t.get("btnAbandon")&&t.get("btnAbandon").setDisabled(!1),f.setDisabled(!1),!1},h=f.getCache("vm");h?h.execute("pressEnter",{model:f,condition:g,browse:!1,errCallBack:v}):f.browse(!1,(function(e){e.on("getRefMetaReady",(function(){e.execute("pressEnter",{model:f,condition:g,browse:!1,errCallBack:v})}))}))}}}}}n(o,_common__WEBPACK_IMPORTED_MODULE_0__.a)}))}))}},getPredicateValue=function(e){var t=/<%.*?%>/g,a=e.match(t);if(!a)return e;var r={},n=!0;return a.forEach((function(e){var t=e.substring(2,e.length-2).split(".");if(2===t.length){var a=cb.rest.AppContext[t[0]];r[e]=a&&(cb.utils.isEmpty(a[t[1]])?"":a[t[1]])}else n=!1})),n?e.replace(t,(function(e){return r[e]})):e},localoutput=function(billNo,viewmodel,params,beforeAct,afterAct){return __awaiter(_this,void 0,void 0,(function(){var XLSX,outputData,dataColumns,res,tmpObj,i,resObj,key,keyName,resDetails,resSonObj,enumValue,enumString,lookupVector,resultVector,thisLoc,fileName,sheet,sheetRowCount,colCount,rowRange,R,C,cell_address,cell_ref,value,key,controlType,cellConfig,cFormatData,colRange,R_1,thisCell_address,thisCell_ref,iNumPoint,decimal,colRange,R_2,thisCell_address,thisCell_ref,colRange,R_3,thisCell_address,thisCell_ref,decimalCount,i,cell_address,cell_ref,length_1,re,deciLength,colRange,R_4,thisCell_address,thisCell_ref,colRange,R_5,thisCell_address,thisCell_ref,wb;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,Promise.all([__webpack_require__.e(0),__webpack_require__.e(11)]).then(__webpack_require__.t.bind(null,2425,7))];case 1:for(XLSX=_a.sent(),outputData=viewmodel.get(""+params.childrenField).getData(),dataColumns=viewmodel.get(""+params.childrenField).getColumns(),res=[],tmpObj={},i=0;i<outputData.length;i++){for(key in resObj={},dataColumns)keyName=dataColumns[key].cShowCaption?dataColumns[key].cShowCaption:dataColumns[key].cCaption,dataColumns[key].bShowIt&&!dataColumns[key].bHidden&&(resDetails=outputData[i],resSonObj={},resSonObj.cShowCaption=keyName,resSonObj.cControlType=dataColumns[key].cControlType,resSonObj.cFormatData=dataColumns[key].cFormatData,resSonObj.iNumPoint=dataColumns[key].iNumPoint,resSonObj.cEnumString=dataColumns[key].cEnumString,enumValue=null,dataColumns[key].cEnumString&&(enumString=dataColumns[key].cEnumString,lookupVector=Object.keys(eval("("+enumString+")")),resultVector=Object.values(eval("("+enumString+")")),thisLoc=lookupVector.indexOf(resDetails[key].toString()),enumValue=resultVector[thisLoc]),resSonObj.iColWidth=dataColumns[key].iColWidth,tmpObj[key]=resSonObj,resObj[keyName]=enumValue||resDetails[key]);res.push(resObj)}for(fileName=billNo+".xlsx",sheet=XLSX.utils.json_to_sheet(res),sheetRowCount=res.length,colCount=Object.keys(res[0]).length,sheet["!cols"]=new Array(colCount),rowRange=XLSX.utils.decode_range(sheet["!ref"]),R=0;R<=1;++R)for(C=rowRange.s.c;C<=rowRange.e.c;++C)if(0==R){for(key in cell_address={c:C,r:R},cell_ref=XLSX.utils.encode_cell(cell_address),value=sheet[cell_ref].v,tmpObj)if(tmpObj[key].cShowCaption===value){if(controlType=tmpObj[key].cControlType,cellConfig=tmpObj[key],cFormatData=cellConfig.cFormatData,sheet["!cols"][C]={wpx:cellConfig.iColWidth},"YYYY-MM-DD"===cFormatData)for(colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_1=colRange.s.r;R_1<=colRange.e.r;++R_1)thisCell_address={c:C,r:R_1},thisCell_ref=XLSX.utils.encode_cell(thisCell_address),sheet[thisCell_ref].t="d";switch(controlType&&controlType.trim().toLocaleLowerCase()){case"inputnumber":case"money":case"price":try{cFormatData=cFormatData&&""!=cFormatData?JSON.parse(cFormatData):{}}catch(e){cb.utils.alert("数量/金额/单价，预制错误！","error")}if(iNumPoint=cellConfig.iNumPoint,decimal=cFormatData.decimal?getPredicateValue(cFormatData.decimal):null,"money"===controlType?iNumPoint=decimal||cb.rest.AppContext.option.amountofdecimal:"price"===controlType?iNumPoint=decimal||cb.rest.AppContext.option.monovalentdecimal:decimal?iNumPoint=decimal:cb.utils.isEmpty(iNumPoint)&&(iNumPoint=null),("money"===controlType||cFormatData.decimal&&cFormatData.decimal.indexOf("amountofdecimal"))&&(cFormatData.splitter=!0,!iNumPoint))for(colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_2=colRange.s.r;R_2<=colRange.e.r;++R_2)thisCell_address={c:C,r:R_2},thisCell_ref=XLSX.utils.encode_cell(thisCell_address),sheet[thisCell_ref].z=XLSX.SSF._table[3];if(iNumPoint)for(colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_3=colRange.s.r;R_3<=colRange.e.r;++R_3){for(thisCell_address={c:C,r:R_3},thisCell_ref=XLSX.utils.encode_cell(thisCell_address),decimalCount=cFormatData.splitter?"#,##0.0":"0.0",i=1;i<iNumPoint;i++)decimalCount+="0";sheet[thisCell_ref].z=decimalCount}}}}else if(1===R)if(cell_address={c:C,r:R},cell_ref=XLSX.utils.encode_cell(cell_address),"n"===sheet[cell_ref].t){if(length_1=sheet[cell_ref].v.toString().length,sheet[cell_ref].z)re=/[0-9]+\.([0-9]*)/,deciLength=sheet[cell_ref].v.toString().replace(re,"$1").length,length_1+=deciLength;else if(length_1>=12)for(colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_4=colRange.s.r;R_4<=colRange.e.r;++R_4)thisCell_address={c:C,r:R_4},thisCell_ref=XLSX.utils.encode_cell(thisCell_address),sheet[thisCell_ref].z=XLSX.SSF._table[1]}else if("b"===sheet[cell_ref].t)for(colRange={s:{r:1,c:C},e:{r:sheetRowCount,c:C}},R_5=colRange.s.r;R_5<=colRange.e.r;++R_5)thisCell_address={c:C,r:R_5},thisCell_ref=XLSX.utils.encode_cell(thisCell_address),sheet[thisCell_ref].t="s",sheet[thisCell_ref].v=sheet[thisCell_ref].v?"是":"否";return wb=XLSX.utils.book_new(),XLSX.utils.book_append_sheet(wb,sheet,""+params.childrenField),XLSX.writeFile(wb,fileName),[2]}}))}))},output=function(e,t,a,r,n){var o="";window._baseUrl&&(o="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var i=o+"/files"+a.cSvcUrl,_=new cb.utils.queryString(i);if(_){var c={billnum:e,ids:[t.get("id").getValue()].join(),id:t.get("id").getValue(),data:a.data,partParam:a.partParam},l=_&&_.pathname+_.toStr();r({params:a,data:c},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.l(l,c),n()}))}},savebo=function(e,t,a,r,n){cb.rest.DynamicProxy.create({saveBo:{url:"print/saveBo",method:"GET"}}).saveBo({billno:e},(function(e,t){e?cb.utils.alert(e.message,"error"):cb.utils.alert("保存业务对象成功","success")}))},preview=function(e,t,a,r,n){var o=a.params&&a.params.cAction;if("localPrint"===o){var i=t.get("btnLocalPrint");return i&&(a.disabledCallback=function(){i.setDisabled(!0)},a.enabledCallback=function(){i.setDisabled(!1)}),void t.biz.do(o,t,a)}r({params:a},(function(){var r="",o="",i="";if(a.cParameter){var _=JSON.parse(a.cParameter);r=_&&_.printTplItemName}if(r?(o=t.get(r).getValue())||(i="请选择打印模板。"):i="请预置打印按钮的cParameter信息{printTplItemName : 打印模板的cItemName}",""!=i)return cb.utils.alert(i,"warning"),void n({err:i});var c=cb.electron.getSharedObject(),l=c?null:window.open("about:blank");cb.rest.DynamicProxy.create({preview:{url:"print/printPreview",method:"POST"}}).preview({route:a.cSvcUrl||"/bill",billno:e,template:o,ids:[t.get("id").getValue()]},(function(e,t){if(!e){var a=cb.rest.AppContext,r=a.user,o=a.serviceUrl;t=t+"&lang="+(r&&r.locale||"zh_CN"),c?cb.electron.sendOrder("openExternal",""+o+t+"&token="+(r&&r.token||"")):l.location.href=t}n({err:e,res:t},_common__WEBPACK_IMPORTED_MODULE_0__.a)}))}))},print=function(e,t,a,r,n){var o=t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY)&&t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY).getValue()&&t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_PRINT_KEY).getValue().toString(),i={json:{bill:{billnum:e,ids:[t.get("id").getValue()],tplid:o},type:"voucher"}};r({params:a,data:i},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.o(i,a,(function(e,t){e?console.error(e):(window.open(t),n())}))}))},initDefaultActions=function(e,t,a,r,n){var o=t.allActions;r({params:a,data:o},(function(){t.on("moveprev",(function(){var a=o.find((function(e){return e.cCommand&&"cmdmoveprev"===e.cCommand.trim().toLocaleLowerCase()}));a&&movePrevOrNext(e,t,a)})),t.on("movenext",(function(){var a=o.find((function(e){return e.cCommand&&"cmdmovenext"===e.cCommand.trim().toLocaleLowerCase()}));a&&movePrevOrNext(e,t,a)})),t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY)&&t.get(_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_TPL_KEY).on("afterValueChange",(function(e){e&&e.value&&t.biz.do("selecttpl",t,e)})),n()}))},selectTpl=function(e,t,a,r,n){a.tplid=a.value.value;var o=function(r,o){var i=_common__WEBPACK_IMPORTED_MODULE_0__.z(r,o,e,a);if(i){var _=i.vm,c=i.view;t.communication({payload:{menuName:c.cBillName,vm:_,refresh:!0,metaData:c}}),_loadVm(t,_),_common__WEBPACK_IMPORTED_MODULE_0__.G(_,_common__WEBPACK_IMPORTED_MODULE_0__.w(t));var l,s=void 0;_common__WEBPACK_IMPORTED_MODULE_0__.w(_)==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD?(l=t.collectData(!0),s=t.addData):(l=t.getOriginalData(),s=t.collectData(!0)),_.setData(s),render(_,l,_common__WEBPACK_IMPORTED_MODULE_0__.w(_)==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD),n&&n()}};r({params:a},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.t(e,a,o)}))},push=function(e,t,a,r,n){if(console.log("begin-push--"+(new Date).valueOf()),t)_common__WEBPACK_IMPORTED_MODULE_0__.D(t,a,t.collectData(!0),r,n);else if(a&&a.cSvcUrl){var o=new cb.utils.queryString(a.cSvcUrl),i=o.get("groupCode"),_=o.get("code");if(_){cb.utils.isArray(a.data)||(a.data=[a.data]);var c=[],l=[];a.data.forEach((function(e){c.push(e.id),a.pushKey&&l.push(e[a.pushKey])}));var s=a.pushKey?l:Array.from(new Set(c)),d=a.pushKey?Array.from(new Set(c)):void 0,u={code:_,isMainSelect:a.pushKey?0:1,childIds:s,mainIds:d,data:a.data,groupCode:i};Object.assign(u,a.carryParams),console.log("doProxy-push--"+(new Date).valueOf()),_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(t,r){t?window.parent!==window&&cb.rest.AppContext.query.random&&a.domain?window.parent.postMessage({key:"crossdomainpush",random:cb.rest.AppContext.query.random,args:t.message},"*"):_common__WEBPACK_IMPORTED_MODULE_0__.a({err:t}):(window.parent!==window&&cb.rest.AppContext.query.random&&a.domain&&window.parent.postMessage({key:"crossdomainpush",random:cb.rest.AppContext.query.random},"*"),r.targetData&&(delete r.targetData._status,a.carryParams=a.carryParams||{},a.carryParams.externalData=r.targetData,a.targetData=r.targetData,r.dimensionKeys&&r.dimensionKeys.length>1&&(a.dimensionKeys=r.dimensionKeys),a.dimensionGroupCode=i,a.groupTaskKey=r.dimensionKeys&&r.dimensionKeys.length&&r.dimensionKeys[0].groupTaskKey,a.bWorkbench=!!i,r.targetData.dimensionKey=r.dimensionKeys&&r.dimensionKeys[0]&&r.dimensionKeys[0].key,_getInitdata(e,a,(function(e,t){e?_common__WEBPACK_IMPORTED_MODULE_0__.a({err1:e}):(console.log("_getInitdata-push--"+(new Date).valueOf()),n(null,_common__WEBPACK_IMPORTED_MODULE_0__.e(t,r.targetData)),console.log("afterAct-push--"+(new Date).valueOf()))}))))}),u)}}},compositeAction=function(e,t,a){var r=null,n=null;try{var o=JSON.parse(a.cParameter);if(r=o.action.split("&")[0].replace(/(\w)/,(function(e){return e.toUpperCase()})),!(n=t.biz.action()[r.trim().toLocaleLowerCase()]))return;a.defineParams=o}catch(e){return void console.error("compositeAction error: "+e.message)}n(e,t,a,(function(e,a){t.promiseExecute("before"+r,e,a)}),(function(e,a){t.promiseExecute("after"+r,e,(function(){a&&a(e)}))}),a.cShowCaption)},saveDraft=function(e,t,a,r,n){t.communication({type:"modal",payload:{key:"Savedraft",data:{model:t}}})},saveDatatemp=function(e,t,a,r,n){t.communication({type:"modal",payload:{key:"Savedatatemp",data:{model:t}}})},getYhtUserIds=function(e,t){e&&(e.user&&e.person?getYhtUserId("user",e.user,(function(a){getYhtUserId("person",e.person,(function(e){t(a.concat(e))}))})):(e.user&&getYhtUserId("user",e.user,t),(e.person||e.id)&&getYhtUserId("person",e.person||e.id,t)))},getYhtUserId=function(e,t,a){var r="",n="";switch(e){case"user":r="productcenter.aa_user",n="yhtUserId";break;case"person":case"id":r="ucf-staff-center.bd_staff_ref",n="userId"}if(r){var o=cb.rest.DynamicProxy.create({getYhtUserId:{url:"/bill/ref/getRefData",method:"POST"}}),i=[];t.forEach((function(e){var t=e.getValue();t&&i.push(t)}));var _={refCode:r,dataType:"grid",condition:{isExtend:!0,simpleVOs:[{field:"id",op:"in",value1:i}]}};o.getYhtUserId(_,(function(e,t){if(t&&t.recordList&&t.recordList.length){var r=[];t.recordList.forEach((function(e){r.push(e[n])})),a(r)}}))}},_getNotice=function(e,t,a){var r=e.get(t);if(r){var n=r.getValue();return n&&a&&(n=new Date(n).format("yyyy-MM-dd")),{key:r.getState("cShowCaption"),value:n}}},ecsuite=function(e,t,a,r,n){var o=(a.cParameter&&JSON.parse(a.cParameter)||{}).action,i=t.get("id").getValue(),_=location.origin+"/meta/voucher/"+e+"/"+i,c=_,l=t.getParams().caption,s=[];switch(["code","vouchdate","creator"].forEach((function(e){var a=_getNotice(t,e,"vouchdate"===e);a&&s.push(a)})),o){case"cooperation":YYCooperationBridge.YYLanuchFlow({name:l,objectName:"YonSuite",objectId:i,webUrl:_,mobileUrl:c});break;case"task":YYCooperationBridge.YYRenderCreateTask({objectName:"YonSuite",objectId:i,idList:[]});break;case"discussion":var d=t.getCache("ecsuiteItems");d?getYhtUserIds(d,(function(e){YYCooperationBridge.YYGroupChat({objectId:i,docCode:t.get("code")&&t.get("code").getValue(),webUrl:_,mobileUrl:c,name:l,notice:s,idList:e})})):YYCooperationBridge.YYGroupChat({objectId:i,docCode:t.get("code")&&t.get("code").getValue(),webUrl:_,mobileUrl:c,name:l,notice:s,idList:[]});break;case"chat":getYhtUserId(a.type,[a.model],(function(e){YYCooperationBridge.YYChat({id:e[0],webUrl:_,mobileUrl:c,name:l,notice:s})}))}},voucherDo=function(e,t,a,r,n){var o=t.getNecessaryData(),i={billnum:e,data:JSON.stringify(o)};r({params:a,data:i},(function(){_common__WEBPACK_IMPORTED_MODULE_0__.p(a,(function(e,r){if(!e&&(cb.utils.alert(cb.locale("P_YS_FED_FW_0001026085",{text:a.cShowCaption}),"success"),r)){var o=t.collectData(!0),i=_common__WEBPACK_IMPORTED_MODULE_0__.e(o,r);render(t,i)}n({err:e,res:r},_common__WEBPACK_IMPORTED_MODULE_0__.a)}),i)}))},asyncMeta=function(e,t,a,r){return new Promise((function(n){var o=t.cardViewModel;if(o)return o.biz.do("load",o,{data:a}),void cb.utils.loadingControl.end();var i=Object.assign({},t);a&&a.tplid&&t&&!t.tplid&&(i.tplid=a.tplid),t&&t.carryData&&(a=Object.assign(a,t.carryData));var _=function(t,o){i.billData=a,_fetchMetaCallback(t,o,e,r,i,n,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.t(e,i,_)}))};_common__WEBPACK_IMPORTED_MODULE_0__.t(e,i,_)}))},asyncWorkflow=function(e){return new Promise((function(t){window.flowComp({width:850,height:510,appsource:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.appCode,businessKey:e,onload:function(e){t(e.fieldAuth||"workflownoctrl")}})}))},processWorkflow=function(e,t,a){parseViewModel(e,a),parseContainer(t.view,a)},parseViewModel=function(e,t){for(var a in t)"mainTable"===a?parseMainEntity(e,t[a]):parseChildEntity(e,a,t[a])},parseMainEntity=function(e,t){for(var a in t){var r=e.get(a);if(r instanceof cb.models.BaseModel){var n=t[a],o=n.visible,i=n.editable;r._set_data("bShowIt",o),r._set_data("bCanModify",i)}}},parseChildEntity=function(e,t,a){var r=e.get(t);if(r instanceof cb.models.BaseModel){var n=r._get_data("columns");if(n)for(var o in a){var i=n[o];if(i){var _=a[o],c=_.visible,l=_.editable;i.bShowIt=c,i.bCanModify=l}}}},parseContainer=function(e,t){e.containers?e.containers.forEach((function(e){parseContainer(e,t)})):e.controls&&parseControls(e,t)},parseControls=function(e,t){var a=t[e.childrenField||"mainTable"];if(a){var r=[];e.controls.forEach((function(e){var t=a[e.cItemName];t&&!t.visible||r.push(e)})),e.controls=r}},_bindKeyboard=function(e){if(!1!==process.env.__KEYBOARD__&&"false"!==process.env.__KEYBOARD__){var t=e.getCache("containerCodes")||[];if(t.length){var a=getContainers(e,t);a.length>2&&e.execute("afterInitKeyboard",a[0],a[1],a[2])}}},getContainers=function(e,t){for(var a=[],r=[],n=[],o=t.length,i=0;i<o;i++){var _=t[i],c=e&&e.getViewMeta(_);if(!c)return;var l=[],s=[];getControls(e,c,l,s,n),a[i]=l,r[i]=s}return[a,r,n.length&&n[0]]},getControls=function(e,t,a,r,n){var o=e.getCache("selectors");o&&(t.containers&&!t.controls?t.containers.forEach((function(t){getControls(e,t,a,r,n)})):t.controls&&t.controls.forEach((function(t){if(t.cItemName){var i=e.getParams()&&e.getParams().billNo,_=t.cItemName,c=i+"|"+_,l=document.getElementById(c),s=l&&l.querySelector(o.join(",")),d=e.get(_);if(c&&(r.push(s||null),a.push(c)),d&&!n.length){var u=!1!==d.getVisible(),m=!0!==d.getDisabled(),f=!0!==d.getReadOnly();u&&m&&f&&n.push(s)}}})))},afterInitData=function(e,t,a,r){return __awaiter(this,void 0,void 0,(function(){var n,o,i,_,c,l,s,d,u,m;return __generator(this,(function(f){switch(f.label){case 0:(n=[]).push(asyncMeta(e,t,a,r)),a&&(a.isWfControlled||a.pk_procdefins)&&a.verifystate>0&&n.push(asyncWorkflow(e+"_"+a.id)),o=[],i=0,_=n.length,f.label=1;case 1:return i<_?(l=(c=o).push,[4,n[i]]):[3,4];case 2:l.apply(c,[f.sent()]),f.label=3;case 3:return i++,[3,1];case 4:return s=o[0],d=s.vm,u=s.view,o[1]&&("workflownoctrl"===o[1]?d.getParams().workflowNoCtrl=!0:processWorkflow(d,u,o[1]),!0===d.getParams().isCoded&&(d.getParams().isCoded=0)),m=d.getParams().masterOrgField,!cb.utils.isEmpty(m)&&d.get(m).get("bCheck")&&d.on("afterCheck",(function(){d.getCache("initKeyboardComplete")||(_bindKeyboard(d),d.setCache("initKeyboardComplete",!0))})),d.on("afterEdit",(function(){_bindKeyboard(d)})),d.promiseExecute("afterLoadMeta",s,(function(){var e=u.cBillName;r(d,u,e);var a=d.getGridModels(),n=d.get("addGrandSonTable"),o=d.getParams().billNo,i=(cb.rest.AppContext.user||{}).id;a.forEach((function(e){var t=e.getName(),a=o+"_"+i+"_"+t,r=null;cb.indexDB.openDB("cacheInfo",1,["billInfo"]).then((function(t){t?cb.indexDB.IDB_getData({dbTableName:"billInfo",dbName:"cacheInfo",key:a}).then((function(t){if(r=t)for(var a in r)"indexedDB_id"!=a&&e.setColumnState(a,"iColWidth",r[a])})):console.error("打开数据库失败，缓存功能不可用！")})).catch((function(e){console.error(e)})),e.on("afterSetDataSource",(function(){var t=e.getCache("afterAct");t&&t(),setTimeout((function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(e,d,d.getParams().mode),_staterule_rule__WEBPACK_IMPORTED_MODULE_5__.a(e,d,d.getParams().mode)}))})),e.on("afterMount",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(e,d,d.getParams().mode),_staterule_rule__WEBPACK_IMPORTED_MODULE_5__.a(e,d,d.getParams().mode)})),e.on("afterInsertRow",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(e,d,d.getParams().mode),_staterule_rule__WEBPACK_IMPORTED_MODULE_5__.a(e,d,d.getParams().mode)})),e.on("afterInsertRows",(function(){_common__WEBPACK_IMPORTED_MODULE_0__.F(e,d,d.getParams().mode),_staterule_rule__WEBPACK_IMPORTED_MODULE_5__.a(e,d,d.getParams().mode)})),e.on("afterInsertRowsFromRefer",(function(e){d.biz.do("referrowscheck",d,Object.assign({childrenField:t},e))})),n&&(e.on("beforeSetDataSource",(function(e){return e.forEach((function(e){e.id?e.rid||(e.rid=e.id):e.rid||(e.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()())})),e})),e.on("beforeInsertRow",(function(e){return e.row.rid=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()(),e})),e.on("beforeInsertRows",(function(e){var t=e.rows;return t.forEach((function(e){e.id?e.rid||(e.rid=e.id):e.rid||(e.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()())})),t}))),e.on("colWidthResize",(function(e){var t=e.columnKey,n=e.width;r||(r={indexedDB_id:a}),r[t]=n,cb.indexDB.IDB_saveData(r,"billInfo","cacheInfo")})),e.on("colWidthReturn",(function(e){r={id:a,dbTableName:"billInfo",dbName:"cacheInfo"},cb.indexDB.IDB_deleteOneData(r)}))})),d.get("addAttachment")&&a.forEach((function(e){e.on("beforeSetDataSource",(function(e){return e.forEach((function(e){e.id?e.attachmentId||(e.attachmentId=e.id):e.attachmentId||(e.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()())})),e})),e.on("beforeInsertRow",(function(e){return e.row.attachmentId=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()(),e}))})),_managePageInfoStatue(d,o);var _=d.getParams(),c=_.billData;if("treevoucher"===_.metaType){var l=d.getTreeModel();if(_bindTreeAttachment(d),l&&l.getState("banQuery")||(_loadTree(d,{billnum:o,treename:_common__WEBPACK_IMPORTED_MODULE_0__.y(d,"treeName")}),_bindTreeSelect(d,o)),d.getParams().mode!==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD){var s=d.getTreeModel();s&&!s.getState("defaultSelectedKeys")&&s.setState("defaultSelectedKeys",!0)}else d.biz.do("add",d)}else d.biz.do("load",d,{data:c});d.getCache("bindTreeSelect")&&d.getTreeModel()&&_bindTreeSelect(d,o),d.biz.do("code",d),d.biz.do("org",d),d.biz.do("depends",d),d.biz.do("rule",d),_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.USEFORMULARULE&&d.biz.do("formularule",d),_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.USESTATERULE&&d.biz.do("staterule",d),t.copy&&d.biz.do("copy",d),_afterViewCallback(o,d,t)})),[2]}}))}))},_handlePageInfoStatus=function(e,t,a){return __awaiter(this,void 0,void 0,(function(){var r,n,o,i,_,c,l,s,d,u,m,f,E,p;return __generator(this,(function(g){switch(g.label){case 0:if("ncc"!=themeType)return[2,!1];if(r=e.get("btnMovefirst"),n=e.get("btnMovelast"),o=e.get("btnMoveprev"),i=e.get("btnMovenext"),_=e.getCache("parentViewModel"),c=_&&_.getCache("lastSearchCondition"),l=e.getCache("curVoucherIndex"),s=e.getCache("recordCount"),!c||cb.utils.isEmpty(l)||!s)return r&&r.setState("disabled",!0),n&&n.setState("disabled",!0),o&&o.setState("disabled",!0),i&&i.setState("disabled",!0),[2,!1];if(d=null,!t)return[3,9];switch(u=t.cAction,u){case"movenext":return[3,1];case"moveprev":return[3,2];case"movelast":return[3,3];case"movefirst":return[3,4];case"delete":return[3,5];case"save":return[3,6]}return[3,8];case 1:return l+=1,[3,8];case 2:return l-=1,[3,8];case 3:return l=s-1,[3,8];case 4:return l=0,[3,8];case 5:return s-=1,m=cb.extendConfig.voucher.deleteReturn,d=m,"movenext"==m?l==s&&(d="moveprev",l=s-1):"moveprev"==m&&(0==l&&(d="movenext"),l=l-1<0?0:l-1),0==s&&(d=!1),e.setCache("curVoucherIndex",l),e.setCache("recordCount",s),[2,d];case 6:return _common__WEBPACK_IMPORTED_MODULE_0__.w(e)==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT?[2]:[4,_getParentAllList(_)];case 7:f=g.sent(),E=f.recordList||[],(p=E.findIndex((function(e){return e.id==a.id})))>-1?(s=f.recordCount||E.length,l=p):(s=1,l=0),g.label=8;case 8:e.setCache("curVoucherIndex",l),e.setCache("recordCount",s),g.label=9;case 9:return 1==s?(r&&r.setState("disabled",!0),n&&n.setState("disabled",!0),o&&o.setState("disabled",!0),i&&i.setState("disabled",!0)):-1==l?(o&&o.setState("disabled",!0),i&&i.setState("disabled",!0),r&&r.setState("disabled",!0),n&&n.setState("disabled",!0)):0==l?(r&&r.setState("disabled",!0),o&&o.setState("disabled",!0),n&&n.setState("disabled",!1),i&&i.setState("disabled",!1)):l<s-1?(r&&r.setState("disabled",!1),n&&n.setState("disabled",!1),o&&o.setState("disabled",!1),i&&i.setState("disabled",!1)):l==s-1&&(n&&n.setState("disabled",!0),i&&i.setState("disabled",!0),r&&r.setState("disabled",!1),o&&o.setState("disabled",!1)),[2]}}))}))},_getParentAllList=function(e){return new Promise((function(t){var a=e.getGridModel(),r=a._get_data("proxyConfig");if(r){var n=a._get_data("queryParams"),o=cb.rest.DynamicProxy.create({queryData:r});delete n.page,o.queryData(n,(function(e,a){e?cb.utils.alert(e.message,"error"):t(a)}))}}))},_managePageInfoStatue=function(e,t){"ncc"===themeType&&e.on("afterLoadData",(function(){var t=e.getCache("curVoucherIndex"),a=e.getCache("recordCount");if(cb.utils.isEmpty(t)||!a){var r=e.getCache("parentViewModel");if(r){var n=r.getCache("curVoucherIndex"),o=r.getCache("pageInfo");if(!cb.utils.isEmpty(n)&&o)t=(o.pageIndex-1)*o.pageSize+n,a=o.recordCount,e.setCache("curVoucherIndex",t),e.setCache("recordCount",a)}}_handlePageInfoStatus(e)}))},rowDetail=function(e,t,a,r,n){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),i=o.getCache("cSunBillNo");if(i){var _=a&&a.params&&!cb.utils.isEmpty(a.params.index)?a.params.index:"";if(cb.utils.isEmpty(_))cb.utils.alert("未获取到行号","error");else{var c=o.getRow(_),l=c.rid;if(l){var s=_common__WEBPACK_IMPORTED_MODULE_0__.w(t),d={mode:_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT,id:l,rowData:c,carryParams:{}};s==_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE&&(d.readOnly=!0);var u={billtype:"voucher",billno:i,params:d};r({params:a,data:u},(function(){cb.loader.runCommandLine("bill",u,t),n()}))}else console.error("缺少子表id")}}},jointquery=function(e,t,a,r,n){var o={params:{editType:"jointquery"},parentViewModel:t,billNum:e,billId:t.get("id").getValue()};if(a&&a.childrenField){var i=[];i.push(t.getGridModel().getRow(a.params.index).id);var _={childIds:i},c={childKey:a.childrenField};o=Object.assign(o,_,c)}r(o,(function(){t.communication({payload:{title:"单据联查结果显示",type:"platform",url:"voucher-search/ShowFlow",checkReturn:!0,modal:t,data:o}})}))},printPreview=function(e,t,a,r,n){r(a,(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.x(a,"preview",t),r=e.currentParams,o=e.url;if(!r)return!1;window.open(o+_common__WEBPACK_IMPORTED_MODULE_0__.i(r),"_blank"),n()}))},printDesign=function(e,t,a,r,n){r({params:a},(function(){var e=_common__WEBPACK_IMPORTED_MODULE_0__.x(a,"design",t),r=e.currentParams,n=e.url;window.open(n+_common__WEBPACK_IMPORTED_MODULE_0__.i(r),"_blank")}))},printNow=function(e,t,a,r,n){r(a,(function(){_common__WEBPACK_IMPORTED_MODULE_0__.B(a,t),n()}))},batchOutputVoucher=function(e,t,a,r,n){var o=t.getGridModel(),i=t.getTreeModel(),_={billnum:e};if(i){var c=i.getSelectedKeys();if(c.includes("main")){var l=i._get_data("keyMap");c=Object.keys(l)}cb.utils.isArray(c)?_.ids=c.join():"string"==typeof c&&(_.ids=c)}else if(o){var s=a&&a.params&&null!=a.params.index?[o.getRow(a.params.index)]:o.getSelectedRows();if(!s||0==s.length)return void cb.utils.alert("请选择","warning");var d=[];s.forEach((function(e){e.id&&e.pubts&&d.push(e.id)}),_this),_.ids=d.join()}var u="";window._baseUrl&&(u="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var m=u+"/files"+a.cSvcUrl,f=new cb.utils.queryString(m),E=f&&f.pathname+f.toStr();r({params:a,data:_},(function(){if(!_.fileName){var e=t.getParams().caption;e&&(_.fileName=e+"模板")}_common__WEBPACK_IMPORTED_MODULE_0__.l(E,_),n()}))},exportVoucherTemplate=function(e,t,a,r,n){var o="";window._baseUrl&&(o="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var i=o+"/files"+a.cSvcUrl,_=new cb.utils.queryString(i),c=_.pathname+_.toStr(),l={billnum:_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey")};r({params:a,data:l},(function(){if(!l.fileName){var e=t.getParams().caption;e&&(l.fileName=e+"模板")}_common__WEBPACK_IMPORTED_MODULE_0__.l(c,l),n()}))},importVoucher=function(e,t,a,r,n){var o={disabledCallback:a.disabledCallback,enabledCallback:a.enabledCallback};a.disabledCallback=!1,a.enabledCallback=!1;var i={params:a,data:{}},_=!1,c=1,l="asyncImport_"+cb.utils.getNewGuid().replace(/-/g,""),s="";if(a.cParameter){var d=JSON.parse(a.cParameter);d&&(_=d.isAsync,c=d.interval||c,s=d.acceptedFileType||"")}r(i,(function(){var e=document.createElement("input");e.type="file",s&&(e.accept=s),e.style.display="none",e.onchange=function(r){cb.utils.loadingControl.start("导入中..."),o.disabledCallback&&o.disabledCallback();var n=new FormData;n.enctype="multipart/form-data";var s=r.target.files[0],d=s&&s.name,u=s&&s.size;n.append("file",s),i.data.mapCondition&&n.append("mapCondition",JSON.stringify(i.data.mapCondition));var m=new XMLHttpRequest,f=a.cSvcUrl+"?billnum="+_common__WEBPACK_IMPORTED_MODULE_0__.y(t,"cardKey");_&&(f=f+"&asyncKey="+l);var E=window._baseUrl?""+window._baseUrl+f:f;m.open("POST",E,!0),m.send(n),_?(o.enabledCallback&&o.enabledCallback(),m.onreadystatechange=function(){cb.utils.loadingControl.end();var e=!1,a="";if(4===m.readyState){if(200===m.status){var r=void 0;try{r=JSON.parse(m.responseText)}catch(t){e=!0,a="模板内容导入失败,返回信息："+m.responseText}200===r.code||(e=!0,a="模板内容导入失败，"+r.message+"。")}else e=!0,a="模板内容导入返回信息： xhr.readyState ="+m.readyState+"  xhr.status ="+m.status+"  xhr.responseText = "+m.responseText;if(e)cb.utils.alert(a);else{var n=cb.utils.getNowFormatDate(),i=t.getParams()&&(t.getParams().name||t.getParams().caption),_={asyncKey:l,fileSize:u,fileName:d,curTime:n,busName:i,percentage:0,asyncData:"{}"};t.communication({type:"asyncImport",payload:_});var s=setInterval((function(){asyncImportQuery(t,_,o)}),1e3*c);t.setCache(l,s),cb.utils.alert("导入已转入后台处理，可进行其它操作！")}}}):m.onreadystatechange=function(){if(cb.utils.loadingControl.end(),4===m.readyState)if(o.enabledCallback&&o.enabledCallback(),200===m.status){var e=void 0;try{e=JSON.parse(m.responseText)}catch(e){return void cb.utils.alert("模板内容导入失败,返回信息："+m.responseText)}if(200===e.code){var a=e.data;a.sucessCount&&(t.execute("refresh"),t.execute("afterImport",a)),t.communication({type:"modal",payload:{key:"BatchMsg",data:{type:2,res:a}}})}else cb.utils.alert("模板内容导入失败，"+e.message+"。","error")}else console.log("模板内容导入返回信息： xhr.readyState ="+m.readyState+"  xhr.status ="+m.status+"  xhr.responseText = "+m.responseText)},document.body.removeChild(e)},document.body.appendChild(e),e.click()}))},asyncImportQuery=function(e,t,a){var r=t.asyncKey;cb.rest.DynamicProxy.create({getImportProcess:{url:"billtemp/getImportProcess?",method:"GET",options:{mask:!1}}}).getImportProcess({asyncKey:r},(function(a,r){var n="";if(a)return n=a.message,void handleAsyncImportOver(e,t,n);if(r){var o=void 0;try{o=JSON.parse(r)}catch(a){return void handleAsyncImportOver(e,t,n="模板内容导入失败,返回信息："+r)}var i=parseFloat(o.percentage||"0");"0"==o.flag?(n="模板内容导入失败",o.data&&(n=n+",返回信息："+o.data),handleAsyncImportOver(e,t,n)):1==o.flag&&i>=100&&(handleAsyncImportOver(e,t),e.execute("refresh"),e.execute("afterImport",o),e.execute("openNotification",Object.assign({res:o.data},t))),t.asyncData=r,t.percentage=i,e.communication({type:"asyncImport",payload:t})}}))},handleAsyncImportOver=function(e,t,a){var r=e.getCache(t.asyncKey);e.clearCache(t.asyncKey),r&&clearTimeout(r),a&&(cb.utils.alert(a),t.bDelTask=!0,t.errStr=a,e.communication({type:"asyncImport",payload:t}))},doCommunication=function(e,t,a,r,n){_common__WEBPACK_IMPORTED_MODULE_0__.n(e,t,a,r,n)},attachment=function(e,t,a,r,n){if(t.get("addAttachment")){var o=_common__WEBPACK_IMPORTED_MODULE_0__.v(t,a),i=a&&a.params&&null!=a.params.index?[o.getRow(a.params.index)]:o.getSelectedRows();if(0!=i.length)if(i.length>1)cb.utils.alert("附件管理只能单行显示","warning");else{var _=i[0];if(_.attachmentId){var c=t.getCache("attachmentCondition"),l=Object.assign({id:_.attachmentId},c);r({params:a,data:l},(function(){t.communication({type:"modal",payload:{key:"Attachment",data:{size:"md",data:l,model:t}}}),n()}))}else cb.utils.alert("行缺少附件id","warning")}else cb.utils.alert("请选择行","warning")}else console.log("扩展脚本需要配置addAttachment")},_bindTreeAttachment=function(e){var t=e.getTreeModel();e.get("addAttachment")&&t.on("beforeSetDataSource",(function(e){var a=t._get_data("childrenField")||"children",r=t._get_data("keyField")||"id";return function e(t){t.forEach((function(t){var n=t[a];t.attachmentId||(t.attachmentId=t[r]),n&&cb.utils.isArray(n)&&n.length>0&&e(n)}))}(e),e}))},voucherAttachment=function(e,t,a,r,n){if(t.get("addAttachment")){var o="";switch(_common__WEBPACK_IMPORTED_MODULE_0__.w(t)){case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE:case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT:var i=t.get("attachmentId").getValue();if(i)o=i;else if(c=t.get("id").getValue())t.get("attachmentId").setValue(c),o=c;else{var _=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()();t.get("attachmentId").setValue(_),o=_}break;case _helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD:var c;if(c=t.get("attachmentId").getValue())o=c;else{_=uuid_v1__WEBPACK_IMPORTED_MODULE_2___default()();t.get("attachmentId").setValue(_),o=_}}var l=t.getCache("attachmentCondition"),s=Object.assign({id:o},l);r({params:a,data:s},(function(){t.communication({type:"modal",payload:{key:"Attachment",data:{size:"md",data:s,model:t}}}),n()}))}else console.log("扩展脚本需要配置addAttachment")},stateRule=function(e,t,a,r,n){_staterule_rule__WEBPACK_IMPORTED_MODULE_5__.c(e,t,a,r,n)},formulaRule=function(e,t,a,r,n){Object(_staterule_formularule__WEBPACK_IMPORTED_MODULE_3__.a)(e,t,a,r,n)},showSon=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.DEFAULT_SHOW_SON,showHideSon=function(e,t,a,r,n){showSon=!showSon;var o=null;if(a.cParameter)try{o=JSON.parse(a.cParameter).sonGroupCode}catch(e){console.error(e)}t.execute("updateViewMeta",{code:o,visible:showSon})},scan=function(e,t,a,r,n){Object(_mtlapi__WEBPACK_IMPORTED_MODULE_4__.r)(e,t,a,r,n)},share=function(e,t,a,r,n){Object(_mtlapi__WEBPACK_IMPORTED_MODULE_4__.t)(e,t,a,r,n)};return{init:function(e,t,a){!(t=t||{}).mode&&t.query&&t.query.mode&&(t.mode=t.query.mode),!t.id&&t.query&&t.query.id&&(t.id=t.query.id),cb.extendConfig.voucher||(cb.extendConfig.voucher={}),!t.hasOwnProperty("saveReturn")&&cb.extendConfig.voucher.hasOwnProperty("saveReturn")&&(t.saveReturn=cb.extendConfig.voucher.saveReturn);var r=this,n=function(r,n){r?_common__WEBPACK_IMPORTED_MODULE_0__.a({err:r}):((n=n||{})._status===cb.models.DataStates.Insert&&(t.mode=_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_ADD,t.realAdd=!1),afterInitData(e,t,n,a))},o=t.metaType&&t.metaType.trim().toLocaleLowerCase();"editablevoucherlist"===o||"treevoucher"===o?(t.metaType=o,n()):cb.rest.DynamicProxy.create({getTplList:{url:"billmeta/tpllist",method:"GET"}}).getTplList({billno:e},(function(a,o){var i=t.query.systemCode;if(i&&o&&o.length)o=o.find((function(e){return e.systemCode===i})),t.tplid=o&&o.iTplId;else if(o&&o.length&&(o=o.filter((function(e){return null==e.systemCode}))),a||o&&1===o.length);else{var _={};(o||[]).forEach((function(e){var t=e.iTplId;switch(e.iTplMode){case 0:_[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE]=t;break;case 2:_[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT]=t}})),t.multitpl=!0,t.tplid="browse"===t.mode||t.readOnly?_[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_BROWSE]:_[_helpers_env__WEBPACK_IMPORTED_MODULE_1__.a.VOUCHER_STATE_EDIT]}if(t.action)return r.action()[t.action](e,null,t,(function(){}),n);_getInitdata(e,t,n)}))},do:function(e,t,a){_common__WEBPACK_IMPORTED_MODULE_0__.K(this,e,t,a)},action:function(){var e={};try{e=cb.extendConfig.voucherExtendConfig}catch(t){console.log(t),e={}}var t={scan:scan,share:share,render:renderData,doservice:_doService,load:loadData,search:search,code:buildCode,org:buildOrg,depends:buildDepends,rule:buildRule,initdefaultactions:initDefaultActions,commandline:_common__WEBPACK_IMPORTED_MODULE_0__.j,abandon:abandon,copy:copy,push:push,edit:_common__WEBPACK_IMPORTED_MODULE_0__.r,save:save,addrow:addRow,table2dbtnclick:table2DBtnClick,insertrow:insertRow,deleterow:deleteRow,copyrow:copyRow,shiftuprow:shiftUpRow,shiftdownrow:shiftDownRow,delete:doDelete,invalid:inValid,workflow:workflow,audit:audit,submit:submit,unsubmit:unsubmit,unaudit:audit,close:close,open:open,movefirst:moveFirstOrLast,movelast:moveFirstOrLast,moveprev:movePrevOrNext,movenext:movePrevOrNext,add:add,create:add,pull:pull,check:check,refresh:refresh,columnsetting:_common__WEBPACK_IMPORTED_MODULE_0__.h,checkapprove:checkApprove,cellcheck:cellCheck,cellscheck:cellsCheck,referrowscheck:referRowsCheck,lineopen:lineOpenOrClose,lineclose:lineOpenOrClose,localoutput:localoutput,output:output,print:print,selecttpl:selectTpl,saveandadd:saveAndAdd,saveandaudit:saveAndAudit,savebo:savebo,preview:preview,localprint:localPrint,selfdefineaction:compositeAction,savedraft:saveDraft,savedatatemp:saveDatatemp,ecsuite:ecsuite,voucherdo:voucherDo,batchmodify:batchModify,jointquery:jointquery,printpreview:printPreview,printdesign:printDesign,printnow:printNow,batchoutput:batchOutputVoucher,batchimport:importVoucher,tempexport:exportVoucherTemplate,openpage:doCommunication,goback:doCommunication,attachment:attachment,voucherattachment:voucherAttachment,rowdetail:rowDetail,staterule:stateRule,billsetting:_common__WEBPACK_IMPORTED_MODULE_0__.A,formularule:formulaRule,autocomplete:_common__WEBPACK_IMPORTED_MODULE_0__.b,customdo:_common__WEBPACK_IMPORTED_MODULE_0__.m,bizflowpush:_common__WEBPACK_IMPORTED_MODULE_0__.f,showhideson:showHideSon};return Object.assign(t,e,_voucher_M__WEBPACK_IMPORTED_MODULE_6__)}}}();cb.namespace("biz.common"),cb.biz.common.voucher=voucher,__webpack_exports__.default=voucher}.call(this,__webpack_require__(172))}}]);
//# sourceMappingURL=1.bundle.js.map?_=d566ad53-de75-49ba-965f-44adb4dd2a09