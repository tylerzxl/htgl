(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{2422:function(e,t,a){"use strict";a.d(t,"r",(function(){return l})),a.d(t,"t",(function(){return s})),a.d(t,"m",(function(){return u})),a.d(t,"j",(function(){return d})),a.d(t,"h",(function(){return f})),a.d(t,"d",(function(){return m})),a.d(t,"b",(function(){return g})),a.d(t,"g",(function(){return p})),a.d(t,"k",(function(){return b})),a.d(t,"f",(function(){return v})),a.d(t,"p",(function(){return h})),a.d(t,"u",(function(){return y})),a.d(t,"v",(function(){return S})),a.d(t,"n",(function(){return C})),a.d(t,"l",(function(){return w})),a.d(t,"w",(function(){return T})),a.d(t,"a",(function(){return _})),a.d(t,"q",(function(){return x})),a.d(t,"s",(function(){return D})),a.d(t,"i",(function(){return P})),a.d(t,"o",(function(){return E})),a.d(t,"c",(function(){return I})),a.d(t,"x",(function(){return k})),a.d(t,"e",(function(){return R}));var r=a(196),n=a.n(r),i=function(){return(i=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var n in t=arguments[a])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function o(e){var t={};return e&&(t=e.cParameter?JSON.parse(e.cParameter):e),t}function c(e){"upesn"!==n.a.platform?cb.utils.alert("当前平台： "+n.a.platform+" ，结果："+e):console.log("当前平台： "+n.a.platform+" ，结果："+e)}function l(e,t,a,r,o){var l={};if(null==a?void 0:a.cParameter){var s=JSON.parse(a.cParameter);l.needResult=s.needResult?parseInt(s.needResult):1,"all"===s.scanType?l.scanType=["qrCode","barCode"]:Array.isArray(l.scanType)||(l.scanType=[s.scanType])}n.a.scanQRCode(i(i({},l),{success:function(e){var t=e.resultStr;cb.invoker.publish("mtl",{action:"scan",result:t}),c(t)},fail:function(e){c(e.message)}}))}function s(e,t,a,r,l){var s=o(a);n.a.upesn.showShareMenu(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"share",result:e}),c(e)},fail:function(e){c(e.message)}}))}function u(e,t,a,r,i){var o=n.a.platform;cb.invoker.publish("mtl",{action:"platform",result:o}),c(n.a.platform)}function d(e,t,a,r,i){n.a.getNetworkType({success:function(e){var t=e.networkType;cb.invoker.publish("mtl",{action:"getNetworkType",networkType:t}),c(e)},fail:function(e){c(e.message)}})}function f(e,t,a,r,i){n.a.getMac({success:function(e){var t=e.macAddress;cb.invoker.publish("mtl",{action:"getMac",result:t}),c(e)},fail:function(e){c(e.message)}})}function m(e,t,a,r,l){var s=o(a);n.a.dail(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"dail",result:e}),c(e)},fail:function(e){c(e.message)}}))}function g(e,t,a,r,o){var l={};if(null==a?void 0:a.cParameter){var s=JSON.parse(a.cParameter);l.count=s.count,"all"===s.sourceType?l.sourceType=["album","camera"]:Array.isArray(l.sourceType)||(l.sourceType=[s.sourceType])}n.a.chooseImage(i(i({},l),{success:function(e){var t=e.localIds;cb.invoker.publish("mtl",{action:"chooseImage",result:t}),c(e)},fail:function(e){c(e.message)}}))}function p(e,t,a,r,l){var s=o(a);n.a.getLocation(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"getLocation",result:e}),c(e)},fail:function(e){c(e.message)}}))}function b(e,t,a,r,l){var s=o(a);n.a.openLocation(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"openLocation",result:e}),c(e)},fail:function(e){c(e.message)}}))}function v(e,t,a,r,l){var s=o(a);n.a.generateQRCode(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"generateQRCode",result:e}),c(e)},fail:function(e){c(e.message)}}))}function h(e,t,a,r,l){var s=o(a);if(s.headers&&"string"==typeof s.headers)try{s.headers=JSON.parse(s.headers)}catch(e){return void alert("headers 参数错误")}if(s.params&&"string"==typeof s.params)try{s.params=JSON.parse(s.params)}catch(e){return void alert("params 参数错误")}n.a.request(i(i({},s),{success:function(e){var t=e.data;cb.invoker.publish("mtl",{action:"request",result:t}),c(e)},fail:function(e){c(e.message)}}))}function y(e,t,a,r,i){n.a.startRecord({success:function(e){cb.invoker.publish("mtl",{action:"startRecord",result:e}),c(e)},fail:function(e){c(e.message)}})}function S(e,t,a,r,i){n.a.stopRecord({success:function(e){cb.invoker.publish("mtl",{action:"stopRecord",result:e}),c(e)},fail:function(e){c(e.message)}})}function C(e,t,a,r,l){var s=o(a);n.a.playVoice(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"playVoice",result:e}),c(e)},fail:function(e){c(e.message)}}))}function w(e,t,a,r,l){var s=o(a);n.a.pauseVoice(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"pauseVoice",result:e}),c(e)},fail:function(e){c(e.message)}}))}function T(e,t,a,r,l){var s=o(a);n.a.stopVoice(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"stopVoice",result:e}),c(e)},fail:function(e){c(e.message)}}))}function _(e,t,a,r,l){var s=o(a);n.a.changeScreenOrientation(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"changeScreenOrientation",result:e}),c(e)},fail:function(e){c(e.message)}}))}function x(e,t,a,r,i){n.a.restoreScreenOrientation({success:function(e){cb.invoker.publish("mtl",{action:"restoreScreenOrientation",result:e}),c(e)},fail:function(e){c(e.message)}})}function D(e,t,a,r,l){var s=o(a);n.a.setStorage(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"setStorage",result:e}),c(e)},fail:function(e){c(e.message)}}))}function P(e,t,a,r,l){var s=o(a);n.a.getStorage(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"getStorage",result:e}),c(e)},fail:function(e){c(e.message)}}))}function E(e,t,a,r,l){var s=o(a);n.a.removeStorage(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"removeStorage",result:e}),c(e)},fail:function(e){c(e.message)}}))}function I(e,t,a,r,l){var s=o(a);n.a.clearStorage(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"clearStorage",result:e}),c(e)},fail:function(e){c(e.message)}}))}function k(e,t,a,r,l){var s=o(a);n.a.uploadFile(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"uploadFile",result:e}),c(e)},fail:function(e){c(e.message)}}))}function R(e,t,a,r,l){var s=o(a);n.a.downloadFile(i(i({},s),{success:function(e){cb.invoker.publish("mtl",{action:"downloadFile",result:e}),c(e)},fail:function(e){c(e.message)}}))}},2432:function(e,t,a){"use strict";a.r(t);var r=a(191),n=a(123),i=a(557),o=a.n(i),c=a(2422),l=a(61),s=a(429),u=function(){return(u=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var n in t=arguments[a])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},d=function(){var e=this,t=function(e,t,a){r.H(e),r.I(e),s.d(e),a?(e.setDirty(!0),e.loadDirtyData(t)):(e.loadData(t),t&&(e.execute("afterLoadData",t),e.validate(!0)))},a=function(e){var t,a,r=e.getTreeModel();return r&&(t=r.getSelectedNodes()),t&&t.length&&t[0]&&(a=t[0]),a},i=function(e,i,o,c,l){i.getCache("lastMode")?a(i)?r.q(e,i,o,c,l,(function(e,a,i){r.p(i,(function(a,i){if(!a){cb.utils.alert("操作成功","success");var o=e.collectData(!0),c=r.e(o,i);r.G(e,n.a.VOUCHER_STATE_EDIT),t(e,c),e.getTreeModel().updateNode(c)}l({err:a,res:i},r.a)}),a)})):cb.utils.alert("请选择有效数据","warning"):function(e,t,a,n,i){var o=a&&a.params&&a.params.index;if(null!=o){var c=t.getGridModel();if(c){var l=c.getRow(o);if(l){var s={billnum:e,data:JSON.stringify(l)};n({params:a,data:s},(function(){r.p(a,(function(e,a){e||(cb.utils.alert("操作成功","success"),t.execute("back")),i({err:e,res:a},r.a)}),s)}))}}}}(e,i,o,c,l)},d=function(e,t,a,r,n){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"open"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}cb.extendConfig.allConfirm&&a.cShowCaption?cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026042",{cShowCaption:a.cShowCaption}),(function(){i(e,t,a,r,n)})):i(e,t,a,r,n)},f=function(e,t,a,r,n){if(!(a=a||{}).cAction){var o=t.allActions&&t.allActions.find((function(e){return"close"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(a,o)}cb.extendConfig.allConfirm?cb.utils.confirm("是否确认停用此记录",(function(){i(e,t,a,r,n)})):i(e,t,a,r,n)},m=function(e,t,a){for(var n=e.getGridModels(),i=1;i<n.length;i++)n[i].clear();var o=e.getCache("queryItems")||[];if(o.length){var c=!1;if(o.forEach((function(t){var a=t.replace(/(\w)/,(function(e){return e.toUpperCase()}));e.getCache("exec"+a)||(c=!0)})),c)return void(a&&a())}"Report"===r.y(e,"billType")&&e.execute("firstQueryDone",!0);var s=e.getParams().query.reportId,u=e.getGridModel();s&&!t.reportId&&u.setColumns(u.getState("columns")),Object.assign(t,e.getParams().query),delete t.isSum;var d=e.getCache("isSum");if(null!=d&&(t.isSum=d),u){if(u.setState("showSearch",t.showSearch),delete t.showSearch,1==e.getCache("bDisplayNavTree")&&!t.bFromNav)return;u.promiseExecute("beforeLoad",t,(function(){var r=e.allActions&&e.allActions.find((function(e){return e.cCommand&&"cmdlist"===e.cCommand.trim().toLocaleLowerCase()})),n=r&&r.cSvcUrl||"bill/list";n=cb.rest._appendUrl(n,e.getParams().query);var i=r&&r.cSvcUrl?{url:n,method:r.cHttpMethod||"POST",options:{mask:!0}}:{url:n,method:"POST",options:{mask:!0}};u.setDataSource(i,t,(function(e){var t=u.getParent();if(t){var a=t.getCache("pageInfo"),r=l.compConfig.table&&l.compConfig.table.delayLoadPageInfo,n=t.getParams().billType;n=n.toLocaleLowerCase();0!=r&&["voucherlist","archivelist"].includes(n)&&a?(a.pageIndex=e.pageIndex,a.pageSize=e.pageSize):t.setCache("pageInfo",{recordCount:e.recordCount,pageIndex:e.pageIndex,pageSize:e.pageSize})}var i=p(e);i&&this.setColumns(i.columns,i.fieldNames)})),u.setSortColumn(),u.setCache("afterAct",a),e.getCache("cardViewModel")&&u.execute("dblClick",{})}))}},g=function(e){for(var t=e.getCache("FilterViewModel"),a=t._get_data("propertyNames"),r=!0,n=0;n<a.length;n++){var i=a[n],o=t.get(i);if(o instanceof cb.models.BaseModel&&!1!==o._get_data("needCollect")&&!1!==o._get_data("needClear")&&o._get_data("mustInput")){var c=o.getAllData?o.getAllData():o.getData();if("object"==typeof c){if(cb.utils.isEmpty(c.value1)&&cb.utils.isEmpty(c.value2)){r=!1;break}}else if(cb.utils.isEmpty(c)){r=!1;break}}}return r},p=function(e){if(e&&e.viewmodel){for(var t={},a=[],r=e.viewmodel.entities.filter((function(e){return e.bMain&&"Bill"===e.cType}))[0].fields,n=0;n<r.length;n++){var i=r[n];t[i.cItemName]=i,a.push(i.cItemName)}return{columns:t,fieldNames:a}}},b=function(e,t,a,r,n){var i=a?a.groupSchemaId:void 0,o=a?a.groupSchemaName:void 0,c=a?a.dimensionId||9999:void 0;t.execute("refreshEChartConfig",{billnum:e,groupSchemaId:i,groupSchemaName:o,dimensionId:c});var l=!0;!0===t.getCache("execSchema")?l=!1:t.setCache("execSchema",!0),t.setCache("groupSchemaId",i),t.getGridModel().setState("showColumnSetting",!i);var s=Object.assign({billnum:e,groupSchemaId:i,isIncludeMeta:!0},t.getCache("lastSearchCondition"));if(Object.assign(s,t.getParams().query),!1===l&&void 0===t.getCache("lastSearchCondition")){var u=t.getCache("FilterViewModel"),d=u.getCache("schemeId"),f=u&&u.get("search");f&&f.fireEvent("click",{solutionid:d})}else m(t,s,n)},v=function(e,t){e.get("addAttachment")&&e.getGridModels().forEach((function(e){e.on("beforeSetDataSource",(function(e){return e.forEach((function(e){e.attachmentId||(e.id?e.attachmentId=e.id:e.attachmentId=o()())})),e}))}))},h=function(e,t){var a=e.getGridModel();if(a){var i=null,o=a.getColumns();for(var c in o)if(o[c].bJointQuery){i=c;break}a.on("cellJointQuery",(function(e){var t=a.getRow(e.rowIndex);e.cellName===i?(a.execute("dblClick",t,e),a.setCache("backData",{rowIndex:e.rowIndex,id:t.id})):a.execute("jointQuery",Object.assign(e,{rowData:t}))})),a.on("dblClick",(function(t,i){var o=this.getParent(),c={mode:n.a.VOUCHER_STATE_EDIT,readOnly:!e.getParams().doubleEdit,id:t.id,rowData:t,cellInfo:i,carryParams:{},cardViewModel:o.getCache("cardViewModel")};if(c=Object.assign({},c,e.getCache("lastSearchCondition")),!a.execute("beforeDblClick",c))return!0;var l=r.y(e,"cardKey");if(l){var s=a.get("dataSource").findIndex((function(e){return e.id==t.id}));o.setCache("curVoucherIndex",s);var u={billtype:"voucher",billno:l,params:c};cb.loader.runCommandLine("bill",u,o)}})),e.on("afterBatchdelete",(function(t){var a=e.getGridModels();if(!t.res.failCount)for(var r=1;r<a.length;r++)a[r].clear()})),a.on("afterSetDataSource",(function(){var t=a.getCache("afterAct");t&&t(),r.F(a,e),s.a(a,e)})),a.on("afterQueryPageInfo",(function(t){e.getCache("pageInfo").recordCount=t.recordCount}))}},y=function(e,t,a){var r=e.allActions&&e.allActions.find((function(e){return e.cCommand&&"cmdquerytree"===e.cCommand.trim().toLocaleLowerCase()})),n=r&&r.cSvcUrl?{url:r.cSvcUrl,method:r.cHttpMethod||"POST"}:{url:"bill/querytree",method:"POST"},i=e.getTreeModel();i&&i.promiseExecute("beforeLoad",t,(function(){i.setDataSource(n,t),a&&i.setCache("afterAct",a)}))},S=function(e,a){var i=e.getTreeModel();if(i){i.setReadOnly(!0);var o=e.getGridModel(),c=e.getParams().billType;i.on("select",(function(i){e.promiseExecute("beforeTreeSelect",i,(function(){if(o||"TreeList"===c){if(!o)return;e.setCache("execTree",!0);var l={billnum:a};if(i.length){var s=i[0],u=s.path,d=s.id;"main"==d&&(d=""),u?l.path=u:d&&(l.ids=d.toString())}Object.assign(l,e.getCache("lastSearchCondition")),m(e,l)}else i.length?(r.G(e,n.a.VOUCHER_STATE_EDIT),function(e,a,n){if(a.getParams().hasChildren){var i={billnum:e,id:n[a.getTreeModel().getState("keyField")]},o=a.allActions&&a.allActions.find((function(e){return e.cCommand&&"cmddetail"===e.cCommand.trim().toLocaleLowerCase()})),c=o&&o.cSvcUrl?{cSvcUrl:o.cSvcUrl,cHttpMethod:o.cHttpMethod||"GET"}:{cSvcUrl:"bill/detail",cHttpMethod:"GET"};r.p(c,(function(e,r){e||t(a,r)}),i)}else t(a,n)}(a,e,i[0]),e.setCache("lastMode",n.a.VOUCHER_STATE_EDIT)):(r.G(e,n.a.VOUCHER_STATE_ADD),e.biz.do("add",e),e.setCache("lastMode",n.a.VOUCHER_STATE_ADD))}))})),i.on("afterSetDataSource",(function(){if(o){var e=o.getCache("afterAct");e&&e()}else{var t=i.getCache("afterAct");t&&t()}}))}},C=function(e,a){var i,c,l,s=r.y(e,"billType"),u=r.y(e,"filterId"),d=r.y(e,"condition"),f=r.y(e,"detailId");switch(s){case"Report":!d&&u||m(e,{billnum:a,condition:d}),h(e);break;case"VoucherList":case"ArchiveList":case"YYList":m(e,{billnum:a,condition:d}),h(e),function(e,t){var a=e.getGridModel();if(a){var i=e.getGridModels();if(!(i.length<2)&&a.getCache("bMain"))0,a.on("masterTableRowClick",(function(t){var o=a.getRow(t).id,c=cb.rest.DynamicProxy.create({ensure:{url:"/bill/detail",method:"GET"}}),l={billnum:r.y(e,"cardKey"),id:o};c.ensure(l,(function(t,a){if(t)cb.utils.alert(t.message,"error");else{for(var r=function(t){var a=i[t];a._set_data("dataSourceMode","local"),a.clear(),void 0!==a.getCache("cSunBillNo")&&(a.un("masterTableRowClick"),a.on("masterTableRowClick",(function(t){var r=a.getRow(t),i=r.rid;if(i){var o={mode:n.a.VOUCHER_STATE_EDIT,readOnly:!e.getParams().doubleEdit,id:i,rowData:r,carryParams:{}},c={billtype:"voucher",billno:a.getCache("cSunBillNo"),params:o};cb.loader.runCommandLine("bill",c,e)}else console.error("缺少子表id")})))},o=1;o<i.length;o++)r(o);e.setData(a)}}))})),e.get("addGrandSonTable")&&i.forEach((function(e,t){t>0&&!e.getCache("bMain")&&e.on("beforeSetDataSource",(function(e){return e.forEach((function(e){e.rid||(e.id?e.rid=e.id:e.rid=o()())})),e}))}))}}(e),v(e);break;case"TreeList":var g=e.getTreeModel();if(g&&g.getState("defaultSelectedKeys")&&(c="tree",-1===(l=(i=e).getCache("queryItems")||[]).indexOf(c)&&l.push(c),i.setCache("queryItems",l)),v(e),g&&g.getState("banQuery"));else!e.getGridModel()&&u||y(e,{billnum:a,treename:r.y(e,"treeName")});S(e,a),function(e,t){var a=e.getTreeModel();a&&(a.on("cellJointQuery",(function(e){var t=e.rowData;a.execute("dblClick",t)})),a.on("dblClick",(function(e){var t=this.getParent(),i={mode:n.a.VOUCHER_STATE_EDIT,readOnly:!0,id:e.id,rowData:e,cardViewModel:t.getCache("cardViewModel")};if(!a.execute("beforeDblClick",i))return!0;var o={billtype:"voucher",billno:r.y(t,"cardKey"),params:i};cb.loader.runCommandLine("bill",o,t)})))}(e),h(e);break;case"TreeArchive":y(e,{billnum:a,treename:r.y(e,"treeName")}),S(e,a),e.biz.do("add",e),e.setCache("lastMode",n.a.VOUCHER_STATE_ADD);break;case"Compare":r.G(e,n.a.VOUCHER_STATE_BROWSE),y(e,{billnum:a,treename:r.y(e,"treeName"),isDistinct:!0}),function(e,a){var i=e.getTreeModel();i&&i.on("select",(function(i){if(e.getGridModel()&&i.length){var o=r.y(e,"foreignKey");if(o){var c=o.split(".");c&&c.length>1&&(o=c[1])}var l={billnum:a,path:i[0][o],operator:"eq"};m(e,l)}var s=i[0];r.G(e,n.a.VOUCHER_STATE_EDIT),t(e,s)}))}(e,a),h(e),t(e)}f&&function(e,t,a){var r=e.getTreeModel();r&&r.on("afterSetDataSource",(function(e){r.select(a)}))}(e,0,f)},w=function(e,t,a){if(void 0===a&&(a=!0),e){var r=t&&t.params&&null!=t.params.index?[e.getRow(t.params.index)]:e.getSelectedRows(),n=[];return r&&r.length>0&&r.map((function(e){e.id&&n.push(e.id)})),a?Array.from(new Set(n)):n}},T=function(e,t,n,i,o){var c=a(t);if(c){var l=t.getTreeModel();n[l.getState("parentField")]=c[l.getState("keyField")]}i({params:n},(function(){r.g(e,t,n,i,o)}))},x=function(e,a,n,i,o){var c=a.getCache("lastMode");if(c){i({params:n},(function(){cb.utils.confirm("确定要放弃么",(function(){!function(e){r.G(e,c),t(e,e.getOriginalData());var a={res:e.getOriginalData()};o(a,r.a)}(a)}))}))}else a.communication({type:"return"})},D=function(e){return e.indexOf("ist")>-1||"compare"==e.toLowerCase()},P=function(e,i,o,c,l){if(!0===cb.isTest_ImportProgressBall)var s=0,u="asyncImport_"+Math.floor(1e10*Math.random()),d=setInterval((function(){s+=1;var e={asyncData:JSON.stringify({flag:1,percentage:s,count:s,totalCount:100}),asyncKey:u,busName:"供应商"+u,curTime:"2019-11-26 10:25:0",fileName:"供应商档案模版.xlsx",fileSize:327101,percentage:s};i.communication({type:"asyncImport",payload:e}),s>=100&&clearInterval(d)}),1e3);else{if(!(o=o||{}).cAction){var f=i.allActions&&i.allActions.find((function(e){return"add"===e.cAction.trim().toLocaleLowerCase()}));Object.assign(o,f)}var m=i.getParams()&&i.getParams().billType;i.setCache("curVoucherIndex",-1),m?D(m)?function(e,t,i,o,c){if("touch"===cb.rest.interMode){var l=t.getGridModel();l&&l.clearCache("backData")}var s,u={};if((i=(i=i||{})||{}).cParameter)try{u=JSON.parse(i.cParameter)}catch(e){}if(s=u.billnum&&"tree"===u.type?u.billnum:r.y(t,"cardKey")){var d,f=a(t);f&&(d=f[t.getTreeModel().getState("keyField")]);var m={params:i,mode:n.a.VOUCHER_STATE_ADD,action:"add",carryParams:{},parentId:d,parent:f};o({params:m=Object.assign({},m,t.getCache("lastSearchCondition"))},(function(e){e&&(m.carryParams.externalData=e),cb.loader.runCommandLine("bill",{billtype:"voucher",billno:s,params:m},t),c()}))}else cb.utils.alert("元数据未配置cCardKey","warning")}(0,i,o,c,l):function(e,i,o,c,l){var s=i.getTreeModel()&&i.getTreeModel().getState("maxLevel"),u=!1===s?65536:s||3,d=a(i);if(d&&d.level>u)cb.utils.alert(cb.locale("P_YS_FED_FW_0001026057",{level:u+1}),"error");else{var f={billnum:e};c({params:o,data:f},(function(){r.s(f,o,(function(e,a){if(a){r.G(i,n.a.VOUCHER_STATE_ADD);var o=i.getTreeModel(),c=o.getState("parentField");null==a[c]&&d&&(a[c]=d[o.getState("keyField")],a.parent_name=d.name),t(i,a,!0)}l({err:e,res:a},r.a)}))}))}}(e,i,o,c,l):console.error("未获得billType")}},E=function(e,a,i,o,c){var l=a.validate();if(l)cb.utils.alert("以下数据项校验失败："+l.join(","),"error");else{var s=a.collectData();if(s){var u=r.w(a);if(u!=n.a.VOUCHER_STATE_ADD)s._status=cb.models.DataStates.Update;else{s._status=cb.models.DataStates.Insert;var d=a.getTreeModel(),f=s[d.getState("parentField")];if(f){if(d){var m=d.getNodesByKeys(f);m&&m.length&&(s.level=m[0].level+1)}}else s.level=1}var g={billnum:e,data:JSON.stringify(s)};o({params:i,data:g},(function(){i.options={mask:!0},r.p(i,(function(i,o){if(!i){var l,s=a.collectData(!0),d=[];for(var f in o)Array.isArray(o[f])&&a.get(f)&&a.get(f).getDirtyRowIndexes&&a.get(f).getDirtyRowIndexes()&&a.get(f).getDirtyRowIndexes().length>0&&(d.push(f),l={});d.forEach((function(e){l[e]=a.get(e).getDirtyRowIndexes()}));var m=r.e(s,o,l);r.G(a,n.a.VOUCHER_STATE_EDIT),t(a,m),a.execute("updateTreeRefer");var g=a.getTreeModel();a.getParams().saveRefresh?y(a,{billnum:e,treename:r.y(a,"treeName")},(function(){var e=m[g.getState("keyField")];e&&g.select(e.toString())})):u!==n.a.VOUCHER_STATE_ADD?g.updateNode(m):g.addNode(m,!0),cb.utils.alert("保存成功","success")}c({err:i,res:o},r.a)}),g)}))}}},I=function(e,t,a,r,n){var i=t.getGridModel(),o=a&&a.params&&null!=a.params.index?[i.getRow(a.params.index)]:i.getSelectedRows();if(0!=o.length)if(o.length>1)cb.utils.alert("附件管理只能单行显示","warning");else{var c=o[0],l=t.getCache("attachmentCondition"),s=Object.assign({id:c.attachmentId},l);r({params:a,data:s},(function(){t.communication({type:"modal",payload:{key:"Attachment",data:{size:"md",data:s,model:t}}}),n()}))}else cb.utils.alert("请选择行","warning")},k=function(e,t,a,r,n){R(e,t,a,r,n)},R=function(t,a,r,n,i,o){var c;if("btnDelete"!==r.cItemName&&"btnDeleteRow"!==r.cItemName&&null==o&&(o=!!cb.extendConfig.allConfirm),r.cmdParameter)try{c=JSON.parse(r.cmdParameter).primarykey}catch(e){console.error("batchDo action parameter error: "+e.message)}c||(c="id");var l,s=a.getGridModel(),u=a.getTreeModel(),d={};if((r=r||{}).cParameter)try{d=JSON.parse(r.cParameter)}catch(e){}if(d.billnum&&"tree"===d.type?(l=u.getSelectedNodes(),t=d.billnum):s?l=r&&r.params&&null!=r.params.index?[s.getRow(r.params.index)]:s.getSelectedRows():u&&(l=u.getSelectedNodes()),l&&0!=l.length){var f;f=d.billnum&&"tree"===d.type?u.getNecessaryDataForRows(l):s?s.getNecessaryDataForRows(l):u.getNecessaryDataForRows(l);var m=[],g=[];l.forEach((function(e,t){e.id&&e.pubts&&Object.assign(f[t],{code:e.code,id:e.id,pubts:e.pubts}),-1===g.indexOf(e[c])&&(m.push(f[t]),g.push(e[c]))}),e);var p={billnum:t,data:JSON.stringify(m)};n({params:r,data:p},(function(){if(o){var e=a.getParams().caption;cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026054",{cCaption:r.cShowCaption,text:e}),(function(){d.isAsync?O(a,r,i,m,p,c):M(a,r,i,m,p,c)}),(function(){r&&r.enabledCallback&&r.enabledCallback()}))}else d.isAsync?O(a,r,i,m,p,c):M(a,r,i,m,p,c)}))}else cb.utils.alert("请选择","warning")},O=function(e,t,a,n,i,o){i.externalData=u({isAsync:!0},i.externalData);r.p(t,(function(n,o){if(!n){var c=o&&Array.isArray(o.infos)&&o.infos[0]||{},l={asyncKey:c.asyncKey,url:c.url,asyncName:"删除"};W(i.billnum,e,l),e.execute("back",t)}a({err:n,res:o},r.a)}),i)},M=function(e,t,a,n,i,o){r.p(t,(function(i,o){if(!i){var c=t.cShowCaption;1===n.length?o.failCount?cb.utils.alert(cb.locale("P_YS_FED_FW_0001026088",{actionText:c,messages:o.messages[0]}),"error"):cb.utils.alert(cb.locale("P_YS_FED_FW_0001026089",{actionText:c}),"success"):"ncc"!==cb.extendConfig.theme||e.getCache("showBatchMsg")?e.communication({type:"modal",payload:{key:"BatchMsg",data:{type:2,res:o}}}):o.failCount>0?cb.utils.alert(cb.locale("P_YS_FED_FW_0001026087",u({actionText:c},o)),"error"):cb.utils.alert(cb.locale("P_YS_FED_FW_0001026086",u({actionText:c},o)),"success"),e.execute("back",t)}a({err:i,res:o},r.a)}),i)},N=function(e,t,i,o,c){var l,s,u,d=t.getGridModel(),f={};if((i=i||{}).cParameter)try{f=JSON.parse(i.cParameter)}catch(e){}if(f.billnum&&"tree"===f.type){u=f.billnum;var m=a(t);l=m.id,s=m}else if(d){var g=i&&i.params&&i.params.index,p=null!=g?[d.getRow(i.params.index)]:d.getSelectedRows();if(!p||1!==p.length)return void cb.utils.alert("请选择一条数据","warning");l=p[0].id,s=p[0],d.setCache("backData",{rowIndex:g,id:l}),u=r.y(t,"cardKey")}else{if(!(m=a(t)))return void cb.utils.alert("请选择一条数据","warning");l=m.id,s=m,u=r.y(t,"cardKey")}var b={params:i,mode:n.a.VOUCHER_STATE_EDIT,copy:i.copy,id:l,rowData:s,carryParams:{}};if(d){var v=d.get("dataSource").findIndex((function(e){return e.id==l}));t.setCache("curVoucherIndex",v),b=Object.assign({},b,t.getCache("lastSearchCondition"))}o({params:i,carry:b},(function(){var e={billtype:"voucher",billno:u,params:b};cb.loader.runCommandLine("bill",e,t),c()}))},A=function(e,t,a,n,i){var o=t.getParams()&&t.getParams().billType;o&&(D(o)?N(0,t,a,n,i):r.r(e,t,a,n,i))},U=function(e,t,r,n,i){var o=t.getCache("lastSearchCondition"),c=t.getTreeModel();if(t.getGridModel()){var l=Object.assign({billnum:e},r),s=t.getCache("isSum");null!=s&&(l.isSum=s),Object.assign(l,t.getParams().query);var u=t.getCache("groupSchemaId");if(u&&(l.groupSchemaId=u),c){var d=a(t);if(d){var f=d.path,p=d.id;f&&p?(l.path=f,l.ids=p.toString()):f?l.path=f:p&&(l.ids=p.toString())}}var b=cb.utils.extend(!0,l,o);n?n({params:o,data:b},(function(){m(t,b,i)})):m(t,b,i)}else{if(!("ncc"!=cb.extendConfig.theme||g(t)&&o))return;F(e,t,o)}},L=function(e,t,a,r,n){t.setCache("execFilter",!0),t.setCache("lastSearchCondition",a),r({params:a,data:a},(function(){U(e,t,a,null,n)}))},F=function(e,t,a,n,i){var o={billnum:e,treename:r.y(t,"treeName")};a&&a instanceof Object&&(o=Object.assign(o,a)),n?n({params:a,data:o},(function(){y(t,o,i)})):y(t,o,i)},V=function(e,t,r,i,o){var c=t.getTreeModel();if(c&&r)if(r.cTarget){var l=a(t);if(l){var s={};s.detailId=l[c.getState("keyField")];var u=cb.utils.extend(!0,s,{mode:n.a.VOUCHER_STATE_EDIT});i({params:r,data:u},(function(){var e={billtype:"voucherlist",billno:r.cTarget,params:u};cb.loader.runCommandLine("bill",e,t),o()}))}}else console.log("未配置tree 的billnumber ,在commend表的target中设置")},G=function(e,t,a,n,i){var o=t.getTreeModel();if(o){var c=o.getSelectedNodes();if(c.length){var l=c[0];if(o.isFirst(l))cb.utils.alert("分类已是同级次的第一个","warning");else{var s=o.getState("keyField"),u={billnum:e,action:a.cAction,id:l[s]};n({params:a,data:u},(function(){r.p(a,(function(e,n){e||(cb.utils.alert(cb.locale("P_YS_FED_FW_0001026085",{text:a.cShowCaption}),"success"),t.execute("back")),i({err:e,res:n},r.a)}),u)}))}}else cb.utils.alert("请选择一条数据","warning")}},K=function(e,t,a,n,i){var o=t.getTreeModel();if(o){var c=o.getSelectedNodes();if(c.length){var l=c[0];if(o.isLast(l))cb.utils.alert("分类已是同级次的最后一个","warning");else{var s=o.getState("keyField"),u={billnum:e,action:a.cAction,id:l[s]};n({params:a,data:u},(function(){r.p(a,(function(e,n){e||(cb.utils.alert(cb.locale("P_YS_FED_FW_0001026085",{text:a.cShowCaption}),"success"),t.execute("back")),i({err:e,res:n},r.a)}),u)}))}}else cb.utils.alert("请选择一条数据","warning")}},j=function(e,t,a,r,n){var i,o;try{i=(o=JSON.parse(a.cmdParameter)).billnumber,delete o.billnumber}catch(e){console.error("pull action parameter error: "+e.message)}if(i){var c={source:"pull",query:o};cb.loader.runCommandLine("bill",{billtype:"voucherlist",billno:i,params:c},t)}},q=function(e,t,a,n,i){r.C(t,a)},B=function(e,t,a,n,i){if(a){var o=a.params&&a.params.index;if(null!=o){var c=t.getGridModel();if(c){var l=c.getRow(o);if(l){var s,u=c.getNecessaryDataForRows([l]);Object.assign(u[0],{id:l.id,pubts:l.pubts});var d=t.get("sumSwitch");d&&(s=d.getState("sumSwitchKey")),a.pushKey=s,r.D(t,a,u,n,i)}}}}},H=function(e,t,a,n,i){var o=t.getGridModel(),c=o.getSelectedRows();if(c.length){var l,s=o.getNecessaryDataForRows(c);c.forEach((function(e,t){e.id&&e.pubts&&Object.assign(s[t],{id:e.id,pubts:e.pubts})}));var u=t.get("sumSwitch");u&&(l=u.getState("sumSwitchKey")),a.pushKey=l,r.D(t,a,s,n,i)}else cb.utils.alert("请选择有效数据","warning")},z=function(e,t,a,n,i){if(a){var o=a.params&&a.params.index;if(null!=o){var c=t.getGridModel();if(c){var l=c.getRow(o);l&&r.k(t,a,l.id,n,i)}}}},J=function(e,t,a,n,i){var o=new cb.utils.queryString(a.cSvcUrl),c=o.get("code"),l=t.getGridModel(),s=w(l);if(s&&0!=s.length){if(c){var u={code:c,isMainSelect:1,childIds:s},d={cSvcUrl:o.pathname+o.toStr(),cHttpMethod:a.cHttpMethod};n({params:a,data:u},(function(){r.p(d,(function(e,t){i({err:e,res:t},r.a)}),u)}))}}else cb.utils.alert("请选择有效数据","warning")},W=function(e,t,a,r,n){var i=a.asyncKey,o=a.asyncInterval,c=void 0===o?1:o,l=a.btnCallBack,s=a.fileSize,u=a.fileName,d=a.url,f=a.asyncName,m=void 0===f?"导入":f,g=a.refresh,p=void 0===g||g,b={asyncKey:i,fileSize:s,fileName:u,curTime:cb.utils.getNowFormatDate(),busName:t.getParams()&&(t.getParams().name||t.getParams().caption),percentage:0,asyncData:"{}",url:d,asyncName:m,refresh:p};t.communication({type:"asyncImport",payload:b});var v=setInterval((function(){X(t,b,l)}),1e3*c);t.setCache(i,v),cb.utils.alert(m+"已转入后台处理，可进行其它操作！")},Y=function(e,t,a,i,o){var c=t.getGridModel(),l="";window._baseUrl&&(l="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var s=l+"/files"+a.cSvcUrl,u=new cb.utils.queryString(s),d={format:u.has("type")?u.get("type"):"pdf",type:"voucherlist",bill:{page:{pageSize:c.getPageSize(),pageIndex:c.getPageIndex()},billnum:e}},f=n.a.HTTP_OUTPUT_BILL;i({params:a,data:d},(function(){r.l(f,d),o()}))},Q=function(e,t,a){var r=e.getCache(t.asyncKey);e.clearCache(t.asyncKey),r&&clearTimeout(r),a&&(cb.utils.alert(a),t.bDelTask=!0,t.errStr=a,e.communication({type:"asyncImport",payload:t}))},X=function(e,t,a){var r=t.asyncKey,n=t.url||"billtemp/getImportProcess?";cb.rest.DynamicProxy.create({getImportProcess:{url:n,method:"GET",options:{mask:!1}}}).getImportProcess({asyncKey:r},(function(a,r){var n="";if(a)return n=a.message,void Q(e,t,n);if(r){var i=void 0;try{i=JSON.parse(r)}catch(a){return void Q(e,t,n="模板内容导入失败,返回信息："+r)}var o=parseFloat(i.percentage||"0");"0"==i.flag?(n="模板内容导入失败",i.data&&(n=n+",返回信息："+i.data),Q(e,t,n)):1==i.flag&&o>=100&&(Q(e,t),t.refresh&&e.execute("refresh"),e.execute("openNotification",Object.assign({res:i.data},t))),t.asyncData=r,t.percentage=o,e.communication({type:"asyncImport",payload:t})}}))},Z=function(e,t,a,n,i){var o={disabledCallback:a.disabledCallback,enabledCallback:a.enabledCallback};a.disabledCallback=!1,a.enabledCallback=!1;var c={params:a,data:{}},l=!1,s=1,u="asyncImport_"+cb.utils.getNewGuid().replace(/-/g,""),d="";if(a.cParameter){var f=JSON.parse(a.cParameter);f&&(l=f.isAsync,s=f.interval||s,d=f.acceptedFileType||"")}n(c,(function(){var n=document.createElement("input");n.type="file",d&&(n.accept=d),n.style.display="none",n.onchange=function(i){cb.utils.loadingControl.start("导入中..."),o.disabledCallback&&o.disabledCallback();var d=new FormData;d.enctype="multipart/form-data";var f=i.target.files[0],m=f&&f.name,g=f&&f.size;d.append("file",f),c.data.mapCondition&&d.append("mapCondition",JSON.stringify(c.data.mapCondition));var p=new XMLHttpRequest,b=a.cSvcUrl+"?billnum="+r.y(t,"cardKey");try{"bd_staff_card"===r.y(t,"cardKey")&&(b=a.cSvcUrl+"?billnum="+c.data.mapCondition.billnum)}catch(e){console.error(e)}var v=t.getState("serviceCode")||cb.rest.AppContext.query.serviceCode;v&&(b=b+"&serviceCode="+v),l&&(b=b+"&asyncKey="+u);var h=window._baseUrl?""+window._baseUrl+b:b;p.open("POST",h,!0),p.send(d),l?(o.enabledCallback&&o.enabledCallback(),p.onreadystatechange=function(){cb.utils.loadingControl.end();var r=!1,n="";if(4===p.readyState){if(200===p.status){var i=void 0;try{i=JSON.parse(p.responseText)}catch(e){r=!0,n="模板内容导入失败,返回信息："+p.responseText}i&&200===i.code||(r=!0,n="模板内容导入失败，"+i.message+"。")}else 0==p.status?(r=!0,n="offline"):(r=!0,n="模板内容导入返回信息： xhr.readyState ="+p.readyState+"  xhr.status ="+p.status+"  xhr.responseText = "+p.responseText);if(r)cb.utils.alert(n);else{var c={asyncKey:u,asyncInterval:s,btnCallBack:o,fileSize:g,fileName:m,asyncName:a.cShowCaption};if(!t.execute("beforeQueryAsyncProcess",{billNo:e,viewmodel:t,queryParams:c}))return!1;W(e,t,c)}}}):p.onreadystatechange=function(){if(cb.utils.loadingControl.end(),4===p.readyState)if(o.enabledCallback&&o.enabledCallback(),200===p.status){var e=void 0;try{e=JSON.parse(p.responseText)}catch(e){return void cb.utils.alert("模板内容导入失败,返回信息："+p.responseText)}if(e&&200===e.code){var a=e.data;a.sucessCount&&t.execute("refresh"),t.communication({type:"modal",payload:{key:"BatchMsg",data:{type:2,res:a}}})}else cb.utils.alert("模板内容导入失败，"+e.message+"。","error")}else console.log("模板内容导入返回信息： xhr.readyState ="+p.readyState+"  xhr.status ="+p.status+"  xhr.responseText = "+p.responseText)},document.body.removeChild(n)},document.body.appendChild(n),n.click()}))},$=function(e,t,a,n,i){var o="";window._baseUrl&&(o="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var c=o+"/files"+a.cSvcUrl,l=new cb.utils.queryString(c),s=l.pathname+l.toStr(),u={billnum:r.y(t,"cardKey")},d={params:a,data:u};n(d,(function(){if(!u.fileName){var e=t.getParams().caption;e&&(u.fileName=e+"模板")}r.l(s,d.data),i()}))},ee=function(e,t,a,r,n){var i=a&&a.cSvcUrl;i?r({params:a},(function(){window.open(i),n()})):cb.utils.alert("导出模板的地址为空","error")},te=function(e,t,a,n,i){var o=t.getCache("isSum"),c=t.getGridModel();if(c&&!c.getRowsCount())return void cb.utils.alert("导出数据不允许为空，请重新选择后重试！","error");var l="";window._baseUrl&&(l="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var s=l+"/files"+a.cSvcUrl,u=new cb.utils.queryString(s),d=u.pathname+u.toStr(),f=Object.assign({billnum:e||r.y(t,"cardKey"),groupSchemaId:t.getCache("groupSchemaId")},t.getParams().query,t.getCache("lastSearchCondition"));delete f.showSearch,null!=o&&(f.isSum=o),n({params:a,data:f},(function(){r.l(d,f),i()}))},ae=function(e,t,a,r,n){t.communication({type:"modal",payload:{key:"MessageSubscribe",data:{model:t}}})},re=function(t,a,n,i,o){var c,l=a.get("sumSwitch");l&&(c=l.getState("sumSwitchKey"));var s=a.getGridModel(),u={billnum:t};c&&(u.key=s.getColumnState(c,"cFieldName"));var d=a.getCache("isSum");if(null!=d&&(u.isSum=d),s){var f=n&&n.params&&null!=n.params.index?[s.getRow(n.params.index)]:s.getSelectedRows();if(!f||0==f.length)return void cb.utils.alert("请选择","warning");if(f.length>2e3)return void cb.utils.alert("单次最大导出2000条,请重新选择后重试！","warning");var m=[];f.forEach((function(e){c?m.push(e[c]):e.id&&e.pubts&&m.push(e.id)}),e),u.ids=m.join()}var g="";window._baseUrl&&(g="/"===window._baseUrl.substr(0,1)?window._baseUrl:"/"+window._baseUrl);var p=g+"/files"+n.cSvcUrl,b=new cb.utils.queryString(p);b.set("serviceCode",cb.rest.AppContext.query.serviceCode||"");var v=b&&b.pathname+b.toStr();i({params:n,data:u},(function(){if(!u.fileName){var e=a.getParams().caption;e&&(u.fileName=e)}r.l(v,u),o()}))},ne=function(e,t,a,n,i){var o=t.getGridModel();if(o){var c={json:{bill:{page:{pageSize:o.getPageSize(),pageIndex:o.getPageIndex()},billnum:e},type:"voucherlist",token:!0}};n({params:a,data:c},(function(){r.o(c,a,(function(e,t){e?console.error(e):(window.open(t),i())}))}))}},ie=function(e,t,a,n,i){n({params:a},(function(){var n=t.get("templates").getValue();if(n){var c=window.open("about:blank"),l=cb.rest.DynamicProxy.create({preview:{url:"print/printPreview",method:"POST"}}),s=w(t.getGridModel()),u=t.getCache("lastSearchCondition")?JSON.stringify(t.getCache("lastSearchCondition").condition):null,d={route:a.cSvcUrl||"/bill",billno:e,template:n,ids:s,condition:u};l.preview(d,(function(e,t){if(!e){var a=o()(),n=new cb.utils.queryString(t);n.set("random",a),n.set("params",null),n.set("lang",cb.rest.AppContext.user&&cb.rest.AppContext.user.locale||"zh_CN"),c.location.href=n.pathname+decodeURIComponent(n.toStr()),window.addEventListener("message",(function(e){"context"===e.data.key&&e.data.random===a&&(d.tenantId=n.get("tenantId"),c.postMessage({key:"params",value:d},e.origin))}),!1)}i({err:e,res:t},r.a)}))}else cb.utils.alert("请选择打印模板","warning")}))},oe=function(e,t,a,i,o){var c=t.get(n.a.VOUCHER_PRINT_KEY)&&t.get(n.a.VOUCHER_PRINT_KEY).getValue()&&t.get(n.a.VOUCHER_PRINT_KEY).getValue().toString(),l=t.getGridModel(),s=w(l);if(s&&0!=s.length){var u={json:{bill:{billnum:r.y(t,"cardKey"),ids:s,tplid:c},type:"voucher"}};i({params:a,data:u},(function(){r.o(u,a,(function(e,t){e?console.error(e):(window.open(t),o())}))}))}else cb.utils.alert("请选择有效数据","warning")},ce=function(e,t,a,n,i){n(a,(function(){var e=t.getGridModel(),n=r.x(a,"preview",t),o=n.currentParams,c=n.url;if(!o)return!1;(e&&e.getSelectedRows()||[]).length>500?cb.utils.confirm("数据量较大，预览可能比较慢，是否使用打印插件，是否直接静默打印",(function(){r.B(a,t)}),(function(){le(o,c)})):le(o,c),i()}))},le=function(e,t){var a=r.i(e);if(a.length>2e3){var n=cb.rest.DynamicProxy.create({cacheData:{url:"/cachePrint",method:"post",options:{uniform:!1}}}),i=JSON.stringify(e.params);n.cacheData({param:i},(function(a,n){if(n){e.sendType=7,e.params=n.key;var i=r.i(e);window.open(t+i,"_blank")}}))}else window.open(t+a,"_blank")},se=function(e,t,a,n,i){n({params:a},(function(){var e=r.x(a,"design",t),n=e.currentParams,i=e.url;window.open(i+r.i(n),"_blank")}))},ue=function(e,t,a,n,i){n(a,(function(){r.B(a,t),i()}))},de=function(e,t,a,r,n){cb.rest.DynamicProxy.create({saveBo:{url:"print/saveBo",method:"GET"}}).saveBo({billno:e},(function(e,t){e?cb.utils.alert(e.message,"error"):cb.utils.alert("保存业务对象成功","success")}))},fe=function(e,t,i,o,c){var l=a(t);if(l)if(l&&l.children&&l.children.length>0)cb.utils.alert("有下级，不能删除","warning");else{var s=t.getNecessaryData(),u={billnum:e,data:JSON.stringify(s)};o({params:i,data:u},(function(){cb.utils.confirm("确定要删除么",(function(){r.p(i,(function(e,a){if(!e){var i=t.getTreeModel();if(i){var o=i.getSelectedKeys();o&&1==o.length&&(i.deleteNode(o),r.G(t,n.a.VOUCHER_STATE_ADD),t.biz.do("add",t))}cb.utils.alert("操作成功","success")}c({err:e,res:a},r.a)}),u)}))}))}else cb.utils.alert("请选择有效数据","warning")},me=function(e,t,a,n,i){if("Report"!==t.getParams().billType){var o=t.get("id")&&t.get("id").getValue(),c=t.get("code")&&t.get("code").getValue();if(cb.utils.isEmpty(o)&&cb.utils.isEmpty(c))cb.utils.alert("未找到具体单据","error");else{var l=r.y(t,"cardKey");if(cb.utils.isEmpty(l))cb.utils.alert("元数据未配置cCardKey","error");else{var s=cb.rest.DynamicProxy.create({getTemplate:{url:"print/getTemplateByBo",method:"GET",options:{mask:!0}},print:{url:"bill/getTemplateStructure",method:"POST",options:{mask:!0}}});s.getTemplate({billno:l},(function(e,t){if(e)cb.utils.alert(e.message,"error");else{var a=1===t.length?t[0]:t.find((function(e){return e.isdefault}));if(cb.utils.isEmpty(a))cb.utils.alert("没有设置打印模板，请检查","error");else{var r={billno:l,templateCode:a.templatecode};c?r.code=c:r.ids=[o],s.print(r,(function(e,t){e?cb.utils.alert(e.message,"error"):n(t,(function(){cb.utils.localPrint(t)}))}))}}}))}}}else pe(e,t,a,n,i)},ge=function(e,t,a,r,n){t.setCache("isSum",t.get("sumSwitch").getValue()||null),U(e,t,{isIncludeMeta:!0},r,n)},pe=function(e,t,a,r,n){var i=cb.rest.DynamicProxy.create({getTemplate:{url:"print/getTemplateByBo",method:"GET",options:{mask:!0}},print:{url:"report/getTemplateStructure",method:"POST",options:{mask:!0}}});i.getTemplate({billno:e},(function(a,n){if(a)cb.utils.alert(a.message,"error");else{var o=1===n.length?n[0]:n.find((function(e){return e.isdefault}));if(cb.utils.isEmpty(o))cb.utils.alert("没有设置打印模板，请检查","error");else{var c=t.getCache("lastSearchCondition"),l=c?JSON.stringify(c.condition):null,s={billno:e,templateCode:o.templatecode,condition:l,route:"/report/bill"};i.print(s,(function(e,t){e?cb.utils.alert(e.message,"error"):r(t,(function(){cb.utils.localPrint(t)}))}))}}}))},be=function(e,t,a,r,n){t.communication({type:"modal",payload:{key:"batchModify",data:{billType:"list",billNo:e,model:t,params:a}}})},ve=function(e,t,a,n,i){var o=r.y(t,"cardKey");if(o){var c={params:{editType:"jointquery"},parentViewModel:t,billNum:o,billId:t.getGridModel().getRow(a.params.index).id};t.communication({payload:{title:"单据联查结果显示",type:"platform",url:"voucher-search/ShowFlow",checkReturn:!0,modal:t,data:c}})}else cb.utils.alert("元数据未配置cCardKey","warning")},he=function(e,t,a,i,o){var c=t.getGridModel(),l=a&&a.params&&a.params.index;if(null!=l&&c){var s=c.getRow(l);if(s)if(s.isWfControlled&&0!==s.verifystate){var u=r.y(t,"cardKey"),d=u+"_"+s.id;u||(d=e+"_"+s.id);var f={width:850,height:510,appsource:n.a.appCode,businessKey:d};i({params:a,data:f},(function(){window.flowComp(f).showFlowBox({onClose:function(a){(t.getCache("queryItems")||[]).forEach((function(e){var a=e.replace(/(\w)/,(function(e){return e.toUpperCase()}));t.setCache("exec"+a,!0)})),U(e,t)}})}))}else cb.utils.alert("暂无审批详情","warning")}},ye=function(e,t,a,n,i){r.n(e,t,a,n,i)},Se=function(e,t,a,r,i){var o=function(e){var a=new URL(e);if(!a.searchParams.has("_condition_")){var r=t.getCache("lastSearchCondition");r&&r.condition&&a.searchParams.set("_condition_",encodeURI(JSON.stringify(r.condition)))}var n=cb.rest.AppContext.globalization&&cb.rest.AppContext.globalization.locale||"zh_CN";return a.searchParams.set("locale",n),a.toString()};console.log("REPORT_SERVER:"+n.a.HTTP_REPORT_SERVER_URL);var c=cb.rest.AppContext.query.serviceCode;if(!n.a.HTTP_REPORT_SERVER_URL)return cb.utils.alert("请先配置报表服务地址","warning");var l=n.a.HTTP_REPORT_SERVER_URL+"/analysis_server/analysis/lightAnalysis/open/"+e;window.parent!==window&&window.jDiwork&&c?window.jDiwork.getData({serviceCode:c},(function(t){var a={title:t.iframeTitle+"-即时分析",code:e,url:o(l)};r(a,(function(){window.jDiwork.openService(c,{},a,(function(e){i(e)}))}))})):window&&window.open(o(l))},Ce=function(e,t,a,n,i){var o=t.getGridModel(),c=o.getSelectedRows();if(c.length){var l=o.getNecessaryDataForRows(c);r.f(e,t,a,n,i,l)}else cb.utils.alert("请选择有效数据","warning")},we=function(e,t,a,r,n){s.c(e,t,a,r,n)},Te=function(e,t,a,r,n){Object(c.r)(e,t,a,r,n)},_e=function(e,t,a,r,n){Object(c.t)(e,t,a,r,n)},xe=function(e,t,a,n,i){var o=r.y(t,"cardKey");cb.route.pushPage("/view/yyarchive/"+o+"MobileArchive")},De=function(e,t,a,r,n){cb.route.goBack()};return{init:function(e,t,a){cb.extendConfig||(cb.extendConfig={});var i=function(o,c){r.z(o,c,e,t,(function(i,o){delete i.getParams().query.isSum;var c=t&&t.query&&Boolean(t.query.isSum);c&&i.setCache("isSum",c);var l=t&&t.reportId;l&&(t.query.reportId=l);var u={vm:i,view:o};i.promiseExecute("afterLoadMeta",u,(function(){var t=i.get("parent_name");if(t instanceof cb.models.ReferModel){var c=t.getState("maxLevel"),l=!1===c?65536:c||3;t.setState("maxLevel",l)}var u=i.getGridModel();u&&u.on("afterInsertRow",(function(){r.F(u,i,i.getParams().mode),s.a(u,i,i.getParams().mode)})),a(i,o,o.cBillName),C(i,e);var d=i.get("sumSwitch");if(d&&d.getState("crossPageSelect")){var f=d.getState("sumSwitchKey");cb.utils.isEmpty(f)?u.setState("rowKeyField","id"):u.setState("rowKeyField",f)}n.a.USESTATERULE&&i.getCache("FilterViewModel")&&i.getCache("FilterViewModel").on("afterInit",(function(){i.biz.do("staterule",i)}))}))}),(function(t){"Report"===t.getParams().billType&&t.getParams().filterId&&!t.getParams().condition&&(t.getParams().autoLoad=!1);var a=t.getGridModel();if(a){var i=t.getParams().billType,o=(cb.rest.AppContext.user||{}).id;if(["VoucherList","ArchiveList"].includes(i)||a.setState("delayLoadPageInfo",!1),["Report","VoucherList","ArchiveList","TreeList"].indexOf(i)>-1&&e&&o){var c,l=e+"_"+o;r.u(l,(function(e){if(c=e){for(var r in c)"indexedDB_id"!=r&&"pageSize"!=r&&a.setColumnState(r,"iColWidth",c[r]);c.pageSize&&a.get("pageInfo")&&(a.get("pageInfo").pageSize=c.pageSize)}t.initData()})),a.on("pageInfoChange",(function(e){var t=e.pageSize;c||(c={indexedDB_id:l}),c.pageSize=t,cb.indexDB.IDB_saveData(c,"billInfo","cacheInfo")})),a.on("colWidthResize",(function(e){var t=e.columnKey,a=e.width;c||(c={indexedDB_id:l}),c[t]=a,cb.indexDB.IDB_saveData(c,"billInfo","cacheInfo")})),a.on("colWidthReturn",(function(e){c={id:l,dbTableName:"billInfo",dbName:"cacheInfo"},cb.indexDB.IDB_deleteOneData(c)}))}else t.initData()}else t.initData();t.on("refresh",(function(){U(e,t)})),t.on("back",(function(a){for(var n=t.getGridModel(),i=t.getGridModels(),o=1;o<i.length;o++)i[o].clear();if(n){if(a){if(a.cParameter)try{if("tree"===JSON.parse(a.cParameter).type)return void t.biz.do("queryTree",t)}catch(e){}}if("touch"===cb.rest.interMode||"3"==cb.rest.terminalType){var c=n.getCache("backData");if(!c)return void U(e,t);n.clearCache("backData");var l=t.allActions&&t.allActions.find((function(e){return e.cCommand&&"cmdlist"===e.cCommand.trim().toLocaleLowerCase()})),u=l&&l.cSvcUrl?{url:l.cSvcUrl,method:l.cHttpMethod||"POST",options:{mask:!0}}:{url:"bill/list",method:"POST",options:{mask:!0}},d=cb.rest.DynamicProxy.create({queryData:u}),f={billnum:e,page:{pageSize:n.getPageSize(),pageIndex:1},condition:{isExtend:!0,simpleVOs:[{field:"id",op:"eq",value1:c.id}]}};d.queryData(f,(function(e,a){a&&a.recordList&&a.recordList.length&&(n.updateRow(c.rowIndex,a.recordList[0]),r.F(n,t),s.a(n,t))}))}else n.setPageIndex(n.getPageIndex(),!0)}else{if(!("ncc"!=cb.extendConfig.theme||g(t)&&t.getCache("lastSearchCondition")))return;F(e,t,t.getCache("lastSearchCondition"),null,(function(){a&&t.getTreeModel().doPropertyChange("setExpandRow",{rowKey:a,isExpand:!0})}))}}));var u=new cb.promise;t.on("return",(function(e){if(r.w(t)===n.a.VOUCHER_STATE_BROWSE||!t.getDirtyData(!1)){var a=t.getRudux("portal");return a&&0==_.isEmpty(a.asyncImportArr)&&(e.prompt={msg:"有异步处理正在进行，请检查。"}),!0}return e&&"object"==typeof e?(e.prompt={},!0):(cb.utils.confirm(cb.locale("P_YS_FED_FW_0001026058",{abandonText:e}),(function(){u.resolve()}),(function(){u.reject()})),u)}))}),(function(){r.t(e,t,i)}))};r.t(e,t,i)},do:function(e,t,a){r.K(this,e,t,a)},action:function(){var e={};try{e=cb.extendConfig.voucherListExtendConfig}catch(t){console.log(t),e={}}var t={newadd:xe,newback:De,scan:Te,share:_e,doservice:i,copy:z,open:d,close:f,save:E,add:P,push:J,singlepush:B,edit:A,dblclick:N,abandon:x,delete:fe,batchdelete:k,batchaudit:R,batchunaudit:R,batchsubmit:R,batchunsubmit:R,batchdo:R,search:L,refresh:U,output:Y,batchoutput:re,batchimport:Z,tempexport:$,statictempexport:ee,reportexport:te,messagesubscribe:ae,print:ne,batchprint:oe,check:T,columnsetting:r.h,edittree:V,querytree:F,moveup:G,movedown:K,commandLine:r.j,switchgroupschema:b,savebo:de,preview:ie,localprint:me,batchpush:H,sumswitch:ge,pull:j,pullx:q,jointquery:ve,batchmodify:be,printpreview:ce,printdesign:se,workflow:he,printnow:ue,asyncprocess:W,openpage:ye,openreport:Se,goback:ye,attachment:I,billsetting:r.A,staterule:we,autocomplete:r.b,customdo:r.m,bizflowbatchpush:Ce};return Object.assign(t,e)}}}();cb.namespace("biz.common"),cb.biz.common.voucherlist=d,t.default=d}}]);
//# sourceMappingURL=6.bundle.js.map?_=d566ad53-de75-49ba-965f-44adb4dd2a09